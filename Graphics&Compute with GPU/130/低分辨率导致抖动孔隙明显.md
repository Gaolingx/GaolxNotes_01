# 低分辨率导致抖动孔隙明显

### 🧑‍💻 User

taau可以配合dither做假透明，但是超分前的渲染分辨率低的话孔隙会比较明显是为什么？

---

### 🤖 Assistant

这是一个非常经典且技术性的图形学问题。

**简短的回答：**
核心原因在于 **Dither（抖动）是在“渲染分辨率”这个低分辨率网格上执行的**。当渲染分辨率较低时，每一个“渲染像素”在屏幕上占据的物理面积变大，导致抖动产生的空隙（Hole）在视觉上也被放大了。此外，TAAU（时间抗锯齿上采样）在处理高频噪声（Dither图案）时，由于输入信息密度不足，难以通过历史帧有效地填补这些巨大的空隙。

以下是详细的技术分析，分为几个关键维度：

### 1. 物理尺寸放大（The Scaling Factor）

这是最直观的原因。Dither 透明通常使用的是 Screen-space Dithering（屏幕空间抖动），例如使用 $2\times2$ 或 $4\times4$ 的 Bayer 矩阵或者 Blue Noise 纹理。

*   **渲染阶段：** Dither 操作发生在 Fragment Shader 中，基于当前的像素坐标（`gl_FragCoord.xy`）。如果你的渲染分辨率是 $1080p$，而输出分辨率是 $4K$（TAAU 200% Upscale），那么渲染缓冲区中的 **1 个像素** 对应最终屏幕上的 **4 个像素**（$2\times2$ 区域）。
*   **结果：** 在 $1080p$ 下丢弃 1 个像素，意味着在 $4K$ 屏幕上丢弃了一个 $2\times2$ 的像素块。原本肉眼难以察觉的“细微噪点”，被暴力放大成了肉眼可见的“方块”或“孔隙”。

### 2. 采样率不足与奈奎斯特极限（Nyquist Limit）

TAAU 的核心目标是从低分辨率重建高分辨率细节，它假设场景是连续的。

*   **Dither 的本质：** Dither 是一种极高频的信号（像素级的高频跳变：有-无-有-无）。这种信号的频率往往接近甚至超过了低分辨率缓冲区的奈奎斯特频率。
*   **信息丢失：** 当渲染分辨率降低时，你原本用来描述物体边缘和半透明过渡的采样点变少了。Dither 实际上进一步删除了 50%（或其他比例）的有效像素。
*   **TAA 的困境：** TAA 需要利用 Motion Vector（运动矢量）去寻找上一帧的历史像素来填补当前的空隙。
    *   在高分辨率下，像素很密集，相邻像素的颜色差异较小，历史帧很容易找到正确的颜色来混合。
    *   在低分辨率下，相邻像素跨度大。当 TAA 试图通过 History Buffer 填补 Dither 的空洞时，由于单帧内的有效信息太稀疏，重构出的结果往往带有明显的噪声残留或重影。

### 3. TAAU 的 Neighborhood Clamping（邻域钳位）副作用

现代 TAA/TAAU（如 UE4/UE5 的 TAA，FSR2，DLSS）为了防止**鬼影（Ghosting）**，都会包含一个 `Neighborhood Clamping` 或 `History Rectification` 步骤。

$$
\text{Color}_{history} = \text{clamp}(\text{Color}_{history}, \text{Min}_{neighbor}, \text{Max}_{neighbor})
$$

这个机制通过采样当前帧像素周围的 $3\times3$ 区域，来限制历史像素的颜色范围。

*   **问题所在：** 在 Dither 图案中，当前像素是“实体”，而相邻像素可能是“背景”。
*   **低分辨率下的表现：** 当分辨率低时，$3\times3$ 的邻域范围在世界空间中覆盖的面积很大。如果 Dither 的孔隙导致邻域内采到了背景色，Clamping 机制会认为“历史帧里的半透明混合色”是无效的（因为它既不完全像前景，也不完全像背景），从而强制将历史颜色拉回到当前帧的颜色。
*   **后果：** 这导致 TAA **拒绝了** 历史帧的混合结果，使得 Dither 的噪点图案无法被时间累积平滑掉，最终保留了原本的孔隙感。

<details>
<summary><strong>💡 深度解析：为什么 Upscaler 会加剧这个问题？</strong></summary>

Upscaler（如 FSR, DLSS）不仅仅是放大图片，它们通常带有 **Sharpening（锐化）** 滤镜（例如 RCAS）。

1.  **噪声被当成细节：** Upscaler 很难区分“高频纹理细节”和“高频 Dither 噪声”。
2.  **锐化副作用：** 当渲染分辨率低时，Dither 的孔隙被放大成了边缘清晰的色块。Upscaler 的锐化Pass 会进一步增强这些色块的边缘对比度，使得“孔隙”看起来更加锐利、明显，而不是变得模糊柔和。

</details>

### 4. 抖动模式与像素网格的对齐（Grid Alignment）

如果 Dither Pattern 是基于屏幕坐标固定的（Screen-aligned）：

*   当相机移动时，物体划过固定的 Dither 网格。TAA 能够捕捉到这种变化，并随时间积分出半透明效果。
*   但是，如果渲染分辨率很低，物体在屏幕上移动几个“高分像素”的距离，可能在“渲染分辨率”下连 1 个像素都没跨过去。这意味着在 TAA 的时间窗口内，**样本的变化率不足**。TAA 没有收集到足够多的“前景”和“背景”样本来进行完美的混合。

---

### 解决方案建议

如果你在开发中遇到这个问题，可以尝试以下优化策略：

1.  **Blue Noise 而非 Bayer Matrix：**
    使用 Blue Noise（蓝噪声）纹理代替有序的 Bayer 矩阵。蓝噪声在高频分布上更均匀，低频成分少，经过 TAAU 放大后，视觉上的“结块感”会比有序抖动弱。

2.  **Interleaved Gradient Noise (IGN) + 动态抖动：**
    不要使用静态的 Dither Pattern。每一帧都给 Dither 坐标加一个随机偏移（Jitter）。这强迫 TAA 在时间维度上这一帧看到孔隙，下一帧看到实体，从而加速收敛为半透明颜色。

3.  **调整 TAA 参数（Bias）：**
    对于标记为 Dither 透明的物体，可以尝试在 Shader 中输出特殊的 Stencil 或标记，稍微放松 TAA 的 Clamping 强度，允许更多的历史帧混合（但这可能导致拖影）。

4.  **Dither before Upscale (Or Dither in High Res):**
    这是一个较为昂贵的做法，但效果最好：
    *   不在低分辨率的 G-Buffer/Forward Pass 中做 Dither Clip。
    *   而是将半透明物体留到 Upscale 之后，在全分辨率下渲染（但这违背了使用低分渲染提升性能的初衷）。

5.  **Alpha to Coverage (A2C):**
    如果你的 MSAA 开启（虽然配合 TAAU 很少开 MSAA），A2C 可以提供比单纯 Dither 更好的子像素级覆盖，但这在延迟渲染管线中通常不可用。

---

### 🧑‍💻 User

有没有可能，超大孔的话均匀pattern会更好看？

---

### 🤖 Assistant

这是一个非常敏锐且有深度的观察。**你是对的，完全有可能。**

在渲染分辨率极低、导致“孔隙（Pixel/Texel）”在物理屏幕上变得很大的情况下，**有序图案（Ordered Pattern，如 Bayer 或规则棋盘格）往往比随机/蓝噪声（Blue Noise）看起来更“干净”且容易接受。**

这听起来似乎违反了“蓝噪声是图形学万金油”的常识，但在 **超低分辨率 + TAAU** 这个特定语境下，是有其心理声学（Psycho-visual）和信号处理层面的科学依据的。

以下是为什么在“超大孔”情况下，均匀/有序 Pattern 看起来更好的原因：

### 1. 视觉心理学：结构 vs. 瑕疵

人眼（和大脑）对图像的处理有一种机制：**我们更容易忽略“有规律的结构”，而对“无规律的杂乱”非常敏感。**

*   **蓝噪声/随机噪声（在大颗粒下）：**
    当蓝噪声的颗粒非常细小时，它模拟了胶片颗粒，人眼会自动积分（Blend）出半透明感。但当分辨率极低，蓝噪声的“颗粒”变成了硕大的“色块”。
    此时，蓝噪声特有的“不结块”特性反而变成了劣势——你会看到屏幕上分布着大小不一、位置杂乱的色块。这种视觉感受非常像**“渲染错误”、“伪影”或“脏迹”**。

*   **有序图案（Bayer/Checkerboard）：**
    当 Bayer 矩阵被放大时，它呈现出一种规则的网格（Screen Door Effect）。虽然你能明显看到这些网格，但大脑会将其识别为一种**“材质属性”**（比如丝袜、铁丝网）或者**“显示风格”**（像复古的 LCD 像素排列）。
    这种**“确定性”**比随机噪声的**“混乱感”**在视觉上更稳定，看起来不像是“坏掉的渲染”。

### 2. TAA 的“两帧收敛”特性

这可能是技术上最重要的原因。TAA（以及 TAAU）在处理确定性的规律信号时，比处理随机信号效率高得多。

假设我们使用最简单的 $2\times2$ 棋盘格（Checkerboard）做 Dither，并且每帧反转（Invert）一次：

*   **帧 N：** 像素 A 是实体，像素 B 是孔隙。
*   **帧 N+1：** 像素 A 是孔隙，像素 B 是实体。

对于 TAA 来说，这是一个**完美的信号**。只要摄像机不动或运动缓慢，TAA 只需要结合**当前帧**和**上一帧**（一共2帧），就能获得 $100\%$ 完整的颜色信息。
$$
\text{Color}_{\text{resolved}} = 0.5 \times \text{Frame}_N + 0.5 \times \text{Frame}_{N+1}
$$
这种规则的闪烁在时间轴上非常容易被 TAA 完美平滑掉，变成完美的半透明。

相反，**随机噪声/蓝噪声**在时间上往往也是随机抖动的。在低分辨率下，TAA 需要积累很多帧才能把那个巨大的孔隙填满。在这个漫长的积累过程中，你就会看到鬼影（Ghosting）和沸腾的噪点（Boiling Noise）。

### 3. Upscaler 的边缘重建逻辑

超分算法（特别是 FSR 1.0 / EASU 这类基于边缘重建的）更喜欢连续的线条。

*   **有序图案：** 即使被挖孔，剩下的像素往往还能连成某种对角线或规则形状。Upscaler 在检测边缘时，可能会把这种规则的孔隙识别为纹理细节进行锐化，虽然有摩尔纹风险，但边缘是清晰的。
*   **随机噪声：** 产生的是孤立的像素点。Upscaler 很难判断这是噪点还是细节，处理后的结果往往是边缘模糊、糊成一团的色块。

### 4. 案例验证：半透明合成的两种流派

在业界，确实存在根据分辨率选择 Pattern 的做法：

| 场景 | 推荐 Pattern | 原因 |
| :--- | :--- | :--- |
| **高分辨率 / 原生 4K** | **Blue Noise / IGN** | 像素极小，人眼自动混合，追求无纹理感的柔和过渡。 |
| **低分辨率 / 掌机模式 / 强 TAAU** | **Bayer / Interleaved Gradient** | 像素巨大，追求时间维度的快速收敛和画面的稳定性。 |

### 总结与建议

如果你的渲染分辨率真的很低（比如 Switch 掌机模式，或者 PC 上极端的 Performance DLSS），导致孔隙肉眼可见地巨大：

1.  **尝试回退到有序抖动（Ordered Dithering）：** 使用 $4\times4$ 甚至 $8\times8$ 的 Bayer 矩阵。
2.  **锁定世界坐标（World Space Pattern）：** 不要让 Dither Pattern 随屏幕移动（Screen Space），而是尝试将其映射到物体或世界坐标上。这样当相机移动时，孔隙相对于物体是静止的，TAA 更容易将其视为“物体本身的纹理”而稳定下来，而不是满屏乱飞的噪点。
3.  **强制两帧反转：** 确保你的 Dither Pattern 严格执行“奇数帧/偶数帧”互补。这能最大化 TAA 的利用率。

**结论：** 是的，在分辨率不足时，**“看起来像一张整齐的网”通常比“看起来像一堆脏乱的噪点”要好受得多。** 这是一种“两害相权取其轻”的美学选择。