# FSR1.0在卡通渲染中的伪影问题

### 🧑‍💻 User

3d实时渲染postprocessing常用的fsr1.0 EASU+RCAS upscale，为什么在卡通渲染中会有很明显的artifact？

---

### 🤖 Assistant

FSR 1.0 (FidelityFX Super Resolution) 的核心包含两个Pass：**EASU** (Edge-Adaptive Spatial Upsampling) 和 **RCAS** (Robust Contrast-Adaptive Sharpening)。

这两者都是基于**纯空间（Spatial）**的算法，不包含时间轴（Temporal）信息。在写实渲染（Photorealistic）中表现尚可，但在**卡通渲染（Toon Shading / Cel-shading）**中容易出现明显的 Artifacts（伪影、锯齿、噪点），主要原因可以归结为以下几点：

### 1. 边缘性质的冲突 (EASU vs. Hard Edges)

卡通渲染的核心特征是**“硬边缘”**和**“二值化/阶梯化光照”**。

*   **EASU 的逻辑：** EASU 通过分析局部像素的梯度（Gradient）来判断边缘，并试图在重建分辨率时保持边缘的清晰度。它假设图像具有自然图像的属性，即边缘通常伴随着一定的渐变过渡（Anti-aliased edges）。
*   **卡通渲染的现状：** 卡通渲染中的描边（Outline）通常是非常锐利的高对比度线条（往往是纯黑线+亮色块），或者是光照产生的硬切线（Terminator line）。
*   **结果：**
    *   **锯齿放大（Aliasing）：** 当源分辨率较低时，卡通描边的锯齿非常明显。EASU 在分析这些锯齿状的像素结构时，容易将其误判为图像的几何特征并加以保留/强化，而不是将其平滑化。这导致 Upscale 后的线条出现明显的“断裂”或“台阶感”。
    *   **形状扭曲：** 对于极细的描边（如1像素宽），EASU 的插值可能会导致线条粗细不均，甚至在某些角度断开。

### 2. RCAS 的过锐化 (Overshoot & Ringing)

RCAS 是为了解决 Upscale 后的模糊而设计的锐化算法，它基于局部对比度进行增强。

*   **RCAS 的逻辑：** 它寻找局部对比度的变化，增强亮部和暗部的差异。
*   **卡通渲染的现状：** 卡通渲染充斥着**大面积纯色块（Flat Color）**和**极其剧烈的亮度跳变**（从受光面直接跳到阴影面，中间没有渐变）。
*   **结果：**
    *   **振铃效应（Ringing / Halos）：** 在卡通硬阴影或描边周围，RCAS 会试图“增强”这个已经是最大对比度的边缘。这会导致在黑线旁边出现一圈不自然的“白边”或“光晕”，或者在色块交界处出现奇怪的亮线。
    *   **弄巧成拙的平滑面：** 在写实渲染中，RCAS 能够找回纹理细节（如石头的颗粒感）。但在卡通渲染的纯色块（如皮肤、衣服）上，原本应该是绝对平滑的颜色，如果源图像包含极其微小的噪点（Dithering 或压缩伪影），RCAS 会将这些噪点视为“细节”并暴力锐化，导致画面看起来很“脏”。

### 3. 缺乏时域稳定性 (Temporal Instability)

这是 FSR 1.0 作为空间超分算法的通病，但在卡通渲染中尤为明显。

*   **问题：** 卡通描边通常是高频信息（High Frequency）。当相机微弱移动时，低分辨率下的描边像素会在相邻像素格之间“跳动”（Shimmering）。
*   **现象：** 由于 EASU/RCAS 每一帧都是独立处理的，没有由 TAA（时间抗锯齿）或 FSR 2.0 那样的历史帧来平滑这种跳动。导致卡通人物的线条在运动时出现严重的**闪烁（Flickering）**和**蠕动**。

### 4. Dithering（抖动）与网点风格的不兼容

很多二次元游戏为了模拟漫画风格或处理半透明（Transparency），会大量使用 **Screen-space Dithering**（屏幕空间抖动网点）。

*   **冲突：** FSR 1.0 的输入通常是经过 Tone Mapping 之前的颜色，或者是在后期链条的中间。如果在 FSR 之前应用了 Dithering，EASU 和 RCAS 会彻底崩溃。
*   **结果：** 它们会试图去“重建”和“锐化”这些网点，导致本来应该在人眼中融合的半透明效果变成了明显的、锐利的噪点矩阵，严重破坏画面观感。

---

### 总结与对比

| 特征 | 写实渲染 (FSR 1.0 假设) | 卡通渲染 (实际情况) | FSR 1.0 的副作用 |
| :--- | :--- | :--- | :--- |
| **边缘** | 柔和过渡，包含次级像素信息 | 锐利硬边，二值化 | **锯齿增强，线条断裂** |
| **纹理** | 丰富的高频细节（噪点是有益的） | 大面积纯色块（噪点是有害的） | **纯色区域出现噪点/脏斑** |
| **对比度** | 连续变化的梯度 | 阶梯状跳变 (Ramp Shading) | **边缘出现白边/光晕 (Ringing)** |
| **动态** | 纹理掩盖了部分像素闪烁 | 线条清晰，闪烁极易察觉 | **严重的线条闪烁** |

### 解决方案建议

如果在卡通渲染项目中必须使用 Upscaling，建议采取以下策略：

1.  **改用 TAAU / FSR 2.0+ / DLSS：** 卡通渲染极其依赖**时间抗锯齿（Temporal AA）**来保持线条的连续和稳定。基于时域的超分算法效果远好于 FSR 1.0。
2.  **调整 RCAS 强度：** 如果只能用 FSR 1.0，务必**大幅降低 RCAS 的 Attenuation（强度）**。卡通画面的边缘本身就够硬了，不需要额外的锐化。
3.  **甚至不如简单的 Bicubic + CAS：** 有时候 EASU 对于硬边的处理反而不如简单的双三次插值（Bicubic）看着顺眼。
4.  **SMAA 预处理：** 在 FSR 之前先做一遍 SMAA（形态学抗锯齿）可能有助于缓解源图像的锯齿，但这增加了开销。