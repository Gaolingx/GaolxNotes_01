# 曲面细分技术局限性

### 🧑‍💻 User

为什么曲面细分shader目前游戏很少使用？

---

### 🤖 Assistant

这是一个非常敏锐的观察。虽然DirectX 11时代（约2010年）曾将**曲面细分（Tessellation）**作为革命性技术大肆宣传，但在现代游戏开发中，我们确实发现传统的硬件曲面细分技术并没有像当初预期的那样普及到每一个物体上。

简单来说，原因可以归结为：**性价比太低（性能开销大 vs 视觉提升有限）**，且**由于新技术的出现（如Nanite和Mesh Shaders），传统曲面细分正在被降维打击。**

以下是详细的技术分析：

### 1. 性能陷阱：微多边形与过着色（Overshading）

曲面细分的核心理念是根据摄像机距离，动态地将原本粗糙的模型增加三角形数量，使其变得圆润。然而，这在硬件层面存在巨大的效率问题。

*   **像素小于三角形问题（Sub-pixel Triangles）：**
    当曲面细分级别过高时，生成的三角形可能比屏幕上的一个像素还要小。
    假设屏幕分辨率下，一个像素点覆盖了区域 $A$。如果细分后的三角形面积 $A_{tri} < A_{pixel}$，GPU的光栅化单元（Rasterizer）仍然需要处理这数百万个微小的三角形。
*   **Quad Overdraw（四边形过度绘制）：**
    现代GPU在像素着色阶段通常以 $2 \times 2$ 的像素块（Quad）为单位进行处理。如果三角形太小，在这个 $2 \times 2$ 的块中可能只有1个像素有效，另外3个像素的计算资源就被浪费了（Helper Lanes）。这导致**几何处理和光栅化的效率急剧下降**。

$$ \text{Efficiency Loss} \propto \frac{\text{Small Triangles}}{\text{Pixel Size}} $$

### 2. 视觉伪影与美术工作流的噩梦

对于美术师和技术美术（TA）来说，曲面细分并不像“开启一个开关”那么简单，它经常带来难以修复的瑕疵：

*   **模型裂缝（Cracks & Seams）：**
    当一个模型的不同部分（例如角色的脖子和身体）使用了不同的细分级别，或者UV接缝处的法线计算不一致时，几何体就会被撕裂，产生肉眼可见的裂缝。修复这些问题需要极其严格的模型制作规范（Watertight meshes）。
*   **UV扭曲与纹理拉伸：**
    当平面被置换（Displacement）凸起时，原本贴合的纹理会被拉伸，导致画面模糊或变形。这通常需要复杂的映射技术来补偿。
*   **碰撞体不匹配：**
    曲面细分只改变渲染的模型，物理碰撞体通常还是低模。这意味着玩家可能会看到角色的脚陷进石头里，或者悬浮在凸起的地面上。

### 3. 更高性价比的替代方案

随着图形学的发展，很多时候我们不需要真正的几何细分就能达到类似的效果，或者有更先进的几何技术。

#### A. 视差遮蔽映射 (Parallax Occlusion Mapping, POM)
对于墙壁砖块、鹅卵石路面这种细节，POM利用光线步进（Ray Marching）在2D纹理中模拟深度。
*   **优势：** 纯像素着色器计算，不需要增加三角形数量，也没有几何裂缝问题。
*   **效果：** 在不极度贴近观察轮廓时，效果与曲面细分几乎一样，但开销低得多。

#### B. 虚幻引擎 5 的 Nanite (虚拟化几何体)
这是目前最大的“杀手”。Nanite 彻底改变了几何体的渲染管线。
*   **原理：** 它不再依赖运行时的`Hull Shader`和`Domain Shader`进行细分，而是预先处理好极高精度的模型，并根据屏幕误差动态选择显示哪些“簇（Clusters）”。
*   **结果：** Nanite 实现了“无限几何细节”，且自动处理了LOD（细节层次），让传统的曲面细分在静态物体上变得多余。

#### C. Mesh Shaders (DX12 Ultimate / Vulkan)
现代GPU引入了Mesh Shaders管线，它比传统的曲面细分管线更灵活。开发者可以自己编写算法来生成或剔除几何体，而不是被困在固定的曲面细分阶段中。

### 4. 并非完全弃用：它转向了特定领域

虽然“万物皆细分”的理念失败了，但曲面细分在特定场景下依然是王者，并且目前的游戏仍在大量使用，只是你可能没意识到：

1.  **地形渲染（Terrain）：** 几乎所有开放世界游戏（如《地平线》、《荒野大镖客2》）的地形都使用了基于视距的曲面细分（CDLOD等算法），因为地形是高度图（Heightmap），非常适合置换。
2.  **水面模拟：** 大洋的波浪通常是低模平面通过曲面细分配合Gerstner波公式生成的。
3.  **交互式轨迹：** 比如《黑神话：悟空》或《战神》中的雪地/沙地交互。玩家走过留下的脚印，实际上是动态修改了细分后的顶点高度。

### 技术深挖：管线对比

<details>
<summary>点击展开：传统曲面细分管线 vs. 现代 Mesh Shader 管线</summary>

#### 1. 传统 DX11 Tessellation 管线
这是一个固定的、多阶段的流程，硬件开销主要在于数据在这些阶段间的传递：

1.  **Vertex Shader:** 处理低模顶点。
2.  **Hull Shader (HS):** 决定细分多少次（Tessellation Factors）。
3.  **Tessellator (Fixed Function):** 硬件生成新的顶点拓扑结构。
4.  **Domain Shader (DS):** 计算新生成顶点的最终位置（通常读取高度图进行置换）。
5.  **Geometry Shader (Optional):** (通常跳过，太慢)。
6.  **Rasterizer -> Pixel Shader**

**缺点：** 只要开启，显卡必须跑完这一套流程，且由于拓扑结构是在中间生成的，显存带宽压力巨大。

#### 2. 现代 Mesh Shader 管线 (DX12 Ultimate)
这种方式更像是在GPU上运行“计算着色器（Compute Shader）”来处理几何：

1.  **Task Shader:** 决定处理哪些Meshlet（网格小块），相当于更智能的LOD控制。
2.  **Mesh Shader:** 并行处理顶点和图元，直接输出给光栅化器。

**优势：** 开发者可以手动剔除不可见的三角形（Culling），或者实现自定义的细分逻辑，效率比固定的Tessellation单元高得多。Nanite的底层逻辑与此类似。

</details>

### 总结

曲面细分并没有消失，而是**从“通用的美容滤镜”变成了“专用的特效工具”**。

*   **对于静态环境（石头、雕像）：** 已经被 **Nanite** 或 **高精度扫描资产+Mesh Shaders** 取代。
*   **对于表面纹理（砖块、路面）：** 已经被 **Parallax Occlusion Mapping (POM)** 取代，因为更便宜。
*   **对于动态表面（水、雪、大型地形）：** 曲面细分仍然是标准解决方案。

游戏开发追求的是“看起来一样好，但跑得更快”。传统的曲面细分往往是“看起来好一点点，但跑得慢很多”，这就是它逐渐退居二线的原因。