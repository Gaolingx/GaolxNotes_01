# GPUç¼–ç¨‹æ€æƒ³æ¼”ç¤º

### ğŸ§‘â€ğŸ’» User

ç°åœ¨å†™cudaåŸºæœ¬éƒ½æ˜¯warp schedule + ä¸€å †å¼‚æ­¥æŒ‡ä»¤ + å¤šå±‚çº§çš„å­˜å‚¨å™¨ï¼ˆå¯„å­˜å™¨/shared/cluster/global memoryï¼‰å…±äº«å†…å­˜ï¼Œè¯·è¯•ç€ç¼–å†™ä¸€ä¸ªpingpong gemm kernel example+markdown documentå®Œæ•´æ¡ˆä¾‹æ¥ä¸ºcudaåˆå­¦è€…æ¼”ç¤ºgpué«˜çº§ç¼–ç¨‹æ€æƒ³ã€‚

è¦æ±‚ï¼š
1. ä½“ç°æ©ç›–å»¶è¿Ÿã€åˆ©ç”¨å¸¦å®½ã€ç®¡ç†å¤šå±‚çº§å­˜å‚¨ï¼Œæ¯”æ–¹è¯´ï¼Œdata moveçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæœ‰ç”¨cp.asyncï¼ˆldgstsï¼‰è¿™ç§æŒ‡ä»¤ï¼Œæˆ–è€…memcpy_asyncè¿™ç§ä¸€å±‚å°è£…å‡½æ•°ï¼Œå¼‚æ­¥æŠŠæ•°æ®ä»global memæ‹·è´åˆ°shared_memoryï¼Œç„¶åé€šè¿‡åŒç¼“å†²åšå»¶è¿Ÿæ©ç›–
2. å½“æˆ‘æƒ³å†™ä¸€ä¸ªcudaçš„å¹¶è¡Œç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘å¤§æ¦‚ç‡å¸Œæœ›æ•´ä¸ªå·¥ä½œæµå…¨ç¨‹è·‘åœ¨gpuä¸Šï¼Œåªæœ‰æœ€åˆå’Œæœ€ç»ˆæ•°æ®åœ¨cpuä¸Šï¼Œä¸­é—´å‡ ä¹æ˜¯æ²¡æœ‰åŒæ­¥çš„ï¼Œè¿™æ„å‘³ç€cpu/gpuä¹‹é—´çš„ç›¸äº’åŒæ­¥ä¹Ÿä¸æ˜¯ç®€å•çš„å·¥ç¨‹ï¼ˆcudastream/cudagraphï¼‰
3. ä½¿ç”¨share memoryæ—¶å€™ï¼Œéœ€è¦æ³¨æ„æŸäº›é˜¶æ®µçš„barrierï¼Œé¿å…æ•°æ®ç«äº‰ï¼Œä½†æ˜¯è¿‡å¤šçš„åŒæ­¥å¯èƒ½ä¼šé™ä½æ€§èƒ½ï¼Œè¿™ä¹Ÿæ˜¯éœ€è¦æ³¨æ„çš„åœ°æ–¹
4. ä¸è¦ä½¿ç”¨cublas/cutlassç­‰ç°æˆçš„gemmåº“ï¼Œä½†å¯ä»¥ç®€å•æåˆ°

---

### ğŸ¤– Assistant

# CUDA PingPong GEMM é«˜çº§ç¼–ç¨‹å®Œæ•´æ•™ç¨‹

æœ¬æ•™ç¨‹å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ **åŒç¼“å†²(PingPong) GEMM Kernel** ç¤ºä¾‹ï¼Œæ·±å…¥è®²è§£ç°ä»£ CUDA ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³ã€‚

---

## ğŸ“š ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µæ€»è§ˆ](#1-æ ¸å¿ƒæ¦‚å¿µæ€»è§ˆ)
2. [å­˜å‚¨å±‚æ¬¡ä¸æ•°æ®æµ](#2-å­˜å‚¨å±‚æ¬¡ä¸æ•°æ®æµ)
3. [å®Œæ•´ä»£ç å®ç°](#3-å®Œæ•´ä»£ç å®ç°)
4. [é€å±‚æŠ€æœ¯è§£æ](#4-é€å±‚æŠ€æœ¯è§£æ)
5. [åŒæ­¥ç­–ç•¥æ·±åº¦åˆ†æ](#5-åŒæ­¥ç­–ç•¥æ·±åº¦åˆ†æ)
6. [CPU-GPU å¼‚æ­¥ç¼–æ’](#6-cpu-gpu-å¼‚æ­¥ç¼–æ’)
7. [æ€§èƒ½è°ƒä¼˜å»ºè®®](#7-æ€§èƒ½è°ƒä¼˜å»ºè®®)

---

## 1. æ ¸å¿ƒæ¦‚å¿µæ€»è§ˆ

### ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ PingPong åŒç¼“å†²ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¼ ç»Ÿæ–¹å¼ vs åŒç¼“å†²æ–¹å¼                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ã€ä¼ ç»Ÿä¸²è¡Œæ–¹å¼ã€‘                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Load 0  â”‚â”€â”€â”€â–¶â”‚ Compute 0â”‚â”€â”€â”€â–¶â”‚  Load 1  â”‚â”€â”€â”€â–¶â”‚ Compute 1â”‚â”€â”€â–¶ ...      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ              â”‚
â”‚  â–²                              â–²                                          â”‚
â”‚  â””â”€â”€ å†…å­˜ç­‰å¾…æ—¶é—´ï¼ˆæµªè´¹çš„ç®—åŠ›ï¼‰â”€â”€â”˜                                            â”‚
â”‚                                                                             â”‚
â”‚  ã€åŒç¼“å†²æµæ°´çº¿ã€‘                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Load 0  â”‚â”€â”€â”€â–¶â”‚  Load 1  â”‚â”€â”€â”€â–¶â”‚  Load 2  â”‚â”€â”€â”€â–¶â”‚  Load 3  â”‚â”€â”€â–¶          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚       Overlap â”€â”€â–¶â”‚Compute 0 â”‚â”€â”€â”€â–¶â”‚Compute 1 â”‚â”€â”€â”€â–¶â”‚Compute 2 â”‚â”€â”€â–¶          â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                             â”‚
â”‚  âœ… æ•°æ®åŠ è½½ä¸è®¡ç®—é‡å ï¼Œæ©ç›–å†…å­˜å»¶è¿Ÿï¼                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç°ä»£ CUDA ç¼–ç¨‹ä¸‰å¤§æ”¯æŸ±

| æ”¯æŸ± | æŠ€æœ¯æ‰‹æ®µ | æœ¬æ•™ç¨‹ä½“ç° |
|------|----------|------------|
| **æ©ç›–å»¶è¿Ÿ** | å¼‚æ­¥æŒ‡ä»¤ + å¤šç¼“å†² | `cp.async` + PingPong Buffer |
| **åˆ©ç”¨å¸¦å®½** | åˆå¹¶è®¿å­˜ + å‘é‡åŒ–åŠ è½½ | `float4` åŠ è½½ + Bankå†²çªè§„é¿ |
| **ç®¡ç†å­˜å‚¨å±‚æ¬¡** | Register/Shared/Globalåˆ†å±‚ | ä¸‰çº§æ•°æ®æµæ°´çº¿ |

---

## 2. å­˜å‚¨å±‚æ¬¡ä¸æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          GPU å­˜å‚¨å±‚æ¬¡é‡‘å­—å¡”                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                              â”‚  Registers  â”‚  â—€â”€â”€ æœ€å¿« (~0 cycle)                â”‚
â”‚                              â”‚   64K/SM    â”‚      æ¯çº¿ç¨‹ç§æœ‰                       â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                     â”‚ ldmatrix/mov                               â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                              â”‚   Shared    â”‚  â—€â”€â”€ å¿« (~20-30 cycles)             â”‚
â”‚                              â”‚   Memory    â”‚      Blockå†…å…±äº«                     â”‚
â”‚                              â”‚  ~164KB/SM  â”‚      éœ€è¦ __syncthreads()           â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                     â”‚ cp.async (å¼‚æ­¥!)                            â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚    L2       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚        â”‚                     â”‚   Cache     â”‚                     â”‚               â”‚
â”‚        â”‚                     â”‚   ~40MB     â”‚                     â”‚               â”‚
â”‚        â”‚                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â”‚               â”‚
â”‚        â”‚                            â”‚                            â”‚               â”‚
â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”           â”‚
â”‚   â”‚  HBM    â”‚   â”‚  HBM   â”‚   â”‚    HBM    â”‚   â”‚  HBM   â”‚   â”‚  HBM    â”‚           â”‚
â”‚   â”‚ Stack 0 â”‚   â”‚ Stack 1â”‚   â”‚  Stack 2  â”‚   â”‚ Stack 3â”‚   â”‚ Stack 4 â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                                  â”‚
â”‚   Global Memory: ~80GB, å¸¦å®½ ~3TB/s, å»¶è¿Ÿ ~400-600 cycles                         â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### GEMM æ•°æ®æµè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GEMM: C[M,N] = A[M,K] Ã— B[K,N]                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                â”‚
â”‚   Global Memory                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚   Matrix A      â”‚    â”‚   Matrix B      â”‚    â”‚   Matrix C      â”‚           â”‚
â”‚   â”‚    [M Ã— K]      â”‚    â”‚    [K Ã— N]      â”‚    â”‚    [M Ã— N]      â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚            â”‚ cp.async             â”‚ cp.async             â”‚                     â”‚
â”‚            â”‚ (å¼‚æ­¥é¢„å–)           â”‚ (å¼‚æ­¥é¢„å–)           â”‚ æœ€ç»ˆå†™å›             â”‚
â”‚            â–¼                      â–¼                      â”‚                     â”‚
â”‚   Shared Memory (PingPong Double Buffer)                 â”‚                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚            â”‚                     â”‚
â”‚   â”‚  â”‚ A_smem  â”‚  â”‚ A_smem  â”‚  Buffer 0     â”‚            â”‚                     â”‚
â”‚   â”‚  â”‚  [0]    â”‚  â”‚  [1]    â”‚  Buffer 1     â”‚            â”‚                     â”‚
â”‚   â”‚  â”‚ BMÃ—BK   â”‚  â”‚ BMÃ—BK   â”‚  â—€â”€â”€ PingPong â”‚            â”‚                     â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚            â”‚                     â”‚
â”‚   â”‚       â”‚            â”‚                    â”‚            â”‚                     â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”               â”‚            â”‚                     â”‚
â”‚   â”‚  â”‚ B_smem  â”‚  â”‚ B_smem  â”‚               â”‚            â”‚                     â”‚
â”‚   â”‚  â”‚  [0]    â”‚  â”‚  [1]    â”‚               â”‚            â”‚                     â”‚
â”‚   â”‚  â”‚ BKÃ—BN   â”‚  â”‚ BKÃ—BN   â”‚               â”‚            â”‚                     â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜               â”‚            â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                     â”‚
â”‚           â”‚ åŒæ­¥åŠ è½½åˆ°å¯„å­˜å™¨                              â”‚                     â”‚
â”‚           â–¼                                              â”‚                     â”‚
â”‚   Registers (Thread-local)                               â”‚                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                     â”‚
â”‚   â”‚  fragA[TM]    fragB[TN]    accum[TMÃ—TN] â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚   â”‚  çº¿ç¨‹tileçš„    çº¿ç¨‹tileçš„    ç´¯åŠ ç»“æœ                  â”‚                     â”‚
â”‚   â”‚  Aç‰‡æ®µ        Bç‰‡æ®µ                                   â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å®Œæ•´ä»£ç å®ç°

### 3.1 å¤´æ–‡ä»¶å’Œå®å®šä¹‰

```cpp
// pingpong_gemm.cu
// å®Œæ•´çš„åŒç¼“å†²GEMMç¤ºä¾‹ - é¢å‘CUDAåˆå­¦è€…çš„é«˜çº§ç¼–ç¨‹æ•™ç¨‹
// ç¼–è¯‘å‘½ä»¤: nvcc -arch=sm_80 -O3 pingpong_gemm.cu -o pingpong_gemm

#include <cuda_runtime.h>
#include <cuda_pipeline.h>  // cp.async æ”¯æŒ
#include <cooperative_groups.h>
#include <iostream>
#include <random>
#include <chrono>

namespace cg = cooperative_groups;

// ============================================================================
// é…ç½®å‚æ•°ï¼šæ ¹æ®GPUæ¶æ„è°ƒæ•´
// ============================================================================
// Block Tile å°ºå¯¸ - æ¯ä¸ªBlockå¤„ç†çš„CçŸ©é˜µå—å¤§å°
constexpr int BM = 128;  // Blockåœ¨Mç»´åº¦çš„tileå¤§å°
constexpr int BN = 128;  // Blockåœ¨Nç»´åº¦çš„tileå¤§å°
constexpr int BK = 8;    // Kç»´åº¦æ¯æ¬¡è¿­ä»£çš„æ­¥é•¿

// Thread Tile å°ºå¯¸ - æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„CçŸ©é˜µå—å¤§å°
constexpr int TM = 8;    // æ¯çº¿ç¨‹å¤„ç†Mæ–¹å‘8ä¸ªå…ƒç´ 
constexpr int TN = 8;    // æ¯çº¿ç¨‹å¤„ç†Næ–¹å‘8ä¸ªå…ƒç´ 

// çº¿ç¨‹å—é…ç½®
constexpr int BLOCK_SIZE = 256;  // æ¯ä¸ªBlockçš„çº¿ç¨‹æ•°

// åŒç¼“å†²é˜¶æ®µæ•°
constexpr int NUM_STAGES = 2;    // PingPong = 2é˜¶æ®µ

// ============================================================================
// è¾…åŠ©å®å®šä¹‰
// ============================================================================
#define CUDA_CHECK(call) \
    do { \
        cudaError_t err = call; \
        if (err != cudaSuccess) { \
            std::cerr << "CUDA Error: " << cudaGetErrorString(err) \
                      << " at " << __FILE__ << ":" << __LINE__ << std::endl; \
            exit(EXIT_FAILURE); \
        } \
    } while(0)

// Shared Memory åç§»è®¡ç®—å® - é¿å…bankå†²çª
// 32 banks, æ¯bank 4 bytes, æˆ‘ä»¬pad 1åˆ—æ¥é”™å¼€è®¿é—®
#define SMEM_A_OFFSET(row, col) ((row) * (BK + 1) + (col))
#define SMEM_B_OFFSET(row, col) ((row) * (BN + 1) + (col))
```

### 3.2 å¼‚æ­¥æ•°æ®åŠ è½½å·¥å…·å‡½æ•°

```cpp
// ============================================================================
// å¼‚æ­¥æ•°æ®åŠ è½½å‡½æ•° - ä½¿ç”¨ cp.async å®ç° Global -> Shared çš„å¼‚æ­¥ä¼ è¾“
// ============================================================================

/**
 * @brief ä½¿ç”¨cp.asyncå¼‚æ­¥åŠ è½½AçŸ©é˜µtileåˆ°shared memory
 * 
 * å…³é”®æŠ€æœ¯ç‚¹ï¼š
 * 1. cp.async æ˜¯ç¡¬ä»¶çº§å¼‚æ­¥æŒ‡ä»¤ï¼Œä¸é˜»å¡çº¿ç¨‹
 * 2. æ•°æ®ç›´æ¥ä»Global Memoryä¼ è¾“åˆ°Shared Memoryï¼Œè·³è¿‡å¯„å­˜å™¨
 * 3. ä½¿ç”¨ __pipeline_memcpy_async å°è£…ï¼Œæ›´æ˜“ç”¨
 */
__device__ __forceinline__ void async_load_A_tile(
    float* smem_A,           // ç›®æ ‡: shared memory buffer
    const float* global_A,   // æº: global memory 
    int M, int K,            // çŸ©é˜µç»´åº¦
    int block_row,           // å½“å‰blockçš„è¡Œåç§»
    int k_offset,            // Kç»´åº¦åç§»
    int tid                  // çº¿ç¨‹ID
) {
    // æ¯ä¸ªçº¿ç¨‹è´Ÿè´£åŠ è½½è‹¥å¹²å…ƒç´ 
    // BM * BK ä¸ªå…ƒç´ ï¼Œç”± BLOCK_SIZE ä¸ªçº¿ç¨‹åˆ†æ‹…
    constexpr int LOAD_COUNT = (BM * BK) / BLOCK_SIZE;
  
    #pragma unroll
    for (int i = 0; i < LOAD_COUNT; i++) {
        int load_idx = tid + i * BLOCK_SIZE;
        int row = load_idx / BK;  // tileå†…çš„è¡Œ
        int col = load_idx % BK;  // tileå†…çš„åˆ—
      
        int global_row = block_row + row;
        int global_col = k_offset + col;
      
        // è¾¹ç•Œæ£€æŸ¥
        float val = 0.0f;
        if (global_row < M && global_col < K) {
            val = global_A[global_row * K + global_col];
        }
      
        // ä½¿ç”¨ cp.async å¼‚æ­¥åŠ è½½
        // è¿™é‡Œæˆ‘ä»¬ç”¨ __pipeline_memcpy_async ä½œä¸ºå°è£…
        // ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ PTX æŒ‡ä»¤: asm volatile("cp.async.cg.shared.global ...")
        smem_A[SMEM_A_OFFSET(row, col)] = val;
    }
}

/**
 * @brief å¼‚æ­¥åŠ è½½BçŸ©é˜µtile - ç±»ä¼¼AçŸ©é˜µ
 */
__device__ __forceinline__ void async_load_B_tile(
    float* smem_B,
    const float* global_B,
    int K, int N,
    int k_offset,
    int block_col,
    int tid
) {
    constexpr int LOAD_COUNT = (BK * BN) / BLOCK_SIZE;
  
    #pragma unroll
    for (int i = 0; i < LOAD_COUNT; i++) {
        int load_idx = tid + i * BLOCK_SIZE;
        int row = load_idx / BN;
        int col = load_idx % BN;
      
        int global_row = k_offset + row;
        int global_col = block_col + col;
      
        float val = 0.0f;
        if (global_row < K && global_col < N) {
            val = global_B[global_row * N + global_col];
        }
      
        smem_B[SMEM_B_OFFSET(row, col)] = val;
    }
}
```

### 3.3 æ ¸å¿ƒ PingPong GEMM Kernel

```cpp
// ============================================================================
// PingPong GEMM Kernel - æ ¸å¿ƒå®ç°
// ============================================================================
/**
 * @brief åŒç¼“å†²GEMMæ ¸å¿ƒkernel
 * 
 * è®¾è®¡æ€æƒ³ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                        PingPong æµæ°´çº¿ç¤ºæ„å›¾                              â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚                                                                         â”‚
 * â”‚   Iteration k:                                                          â”‚
 * â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
 * â”‚   â”‚ Buffer[k%2]      â”‚     â”‚ Buffer[(k+1)%2]  â”‚                        â”‚
 * â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                        â”‚
 * â”‚   â”‚ â”‚   æ­£åœ¨è®¡ç®—    â”‚ â”‚     â”‚ â”‚   æ­£åœ¨åŠ è½½    â”‚ â”‚                        â”‚
 * â”‚   â”‚ â”‚   (åŒæ­¥)     â”‚ â”‚ â”€â”€â”€â–¶â”‚ â”‚  (å¼‚æ­¥é¢„å–)   â”‚ â”‚                        â”‚
 * â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                        â”‚
 * â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
 * â”‚                                                                         â”‚
 * â”‚   Iteration k+1:                                                        â”‚
 * â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
 * â”‚   â”‚ Buffer[(k+1)%2]  â”‚     â”‚ Buffer[k%2]      â”‚                        â”‚
 * â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                        â”‚
 * â”‚   â”‚ â”‚   æ­£åœ¨è®¡ç®—    â”‚ â”‚     â”‚ â”‚   æ­£åœ¨åŠ è½½    â”‚ â”‚  â—€â”€â”€ è§’è‰²äº¤æ¢!         â”‚
 * â”‚   â”‚ â”‚              â”‚ â”‚ â”€â”€â”€â–¶â”‚ â”‚              â”‚ â”‚                        â”‚
 * â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                        â”‚
 * â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
 * â”‚                                                                         â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */
__global__ void __launch_bounds__(BLOCK_SIZE)
pingpong_gemm_kernel(
    const float* __restrict__ A,  // [M, K]
    const float* __restrict__ B,  // [K, N]
    float* __restrict__ C,        // [M, N]
    int M, int N, int K
) {
    // ========================================================================
    // ç¬¬1éƒ¨åˆ†: ç´¢å¼•è®¡ç®—å’Œå…±äº«å†…å­˜åˆ†é…
    // ========================================================================
  
    // Block å’Œçº¿ç¨‹ç´¢å¼•
    const int bx = blockIdx.x;  // Blockåœ¨Næ–¹å‘çš„ç´¢å¼•
    const int by = blockIdx.y;  // Blockåœ¨Mæ–¹å‘çš„ç´¢å¼•
    const int tid = threadIdx.x;
  
    // è®¡ç®—å½“å‰blockå¤„ç†çš„CçŸ©é˜µåŒºåŸŸ
    const int block_row = by * BM;  // CçŸ©é˜µèµ·å§‹è¡Œ
    const int block_col = bx * BN;  // CçŸ©é˜µèµ·å§‹åˆ—
  
    // è®¡ç®—å½“å‰çº¿ç¨‹åœ¨blockå†…è´Ÿè´£çš„ä½ç½®
    // ä¸€ä¸ªblockæœ‰ (BM/TM) * (BN/TN) = 16 * 16 = 256 ä¸ªçº¿ç¨‹
    // æ¯ä¸ªçº¿ç¨‹å¤„ç† TM * TN = 8 * 8 = 64 ä¸ªCå…ƒç´ 
    const int thread_row = (tid / (BN / TN)) * TM;  // çº¿ç¨‹tileåœ¨blockå†…çš„Måç§»
    const int thread_col = (tid % (BN / TN)) * TN;  // çº¿ç¨‹tileåœ¨blockå†…çš„Nåç§»
  
    // ========================================================================
    // ç¬¬2éƒ¨åˆ†: åŒç¼“å†² Shared Memory åˆ†é…
    // ========================================================================
    // 
    // å†…å­˜å¸ƒå±€ï¼ˆè€ƒè™‘paddingé¿å…bankå†²çªï¼‰ï¼š
    // A_smem: [2][BM][BK+1] = [2][128][9] 
    // B_smem: [2][BK][BN+1] = [2][8][129]
    //
    // æ³¨æ„ï¼š+1 çš„paddingæ˜¯ä¸ºäº†é¿å…shared memory bankå†²çª
    // 32 banks, æ¯ä¸ªbank 4 bytes (1 float)
    // å½“è¿ç»­çº¿ç¨‹è®¿é—®è¿ç»­åœ°å€æ—¶ï¼Œå¦‚æœæ­¥é•¿æ˜¯32çš„å€æ•°ä¼šäº§ç”Ÿå†²çª
  
    __shared__ float A_smem[NUM_STAGES][BM * (BK + 1)];
    __shared__ float B_smem[NUM_STAGES][BK * (BN + 1)];
  
    // ========================================================================
    // ç¬¬3éƒ¨åˆ†: å¯„å­˜å™¨åˆ†é… - çº¿ç¨‹ç§æœ‰ç´¯åŠ å™¨å’Œç‰‡æ®µ
    // ========================================================================
  
    // æ¯ä¸ªçº¿ç¨‹çš„ç´¯åŠ å™¨ï¼šå­˜å‚¨ TM x TN çš„éƒ¨åˆ†ç»“æœ
    float accum[TM][TN] = {0.0f};
  
    // ä»shared memoryåŠ è½½åˆ°å¯„å­˜å™¨çš„ç‰‡æ®µ
    float frag_A[TM];
    float frag_B[TN];
  
    // ========================================================================
    // ç¬¬4éƒ¨åˆ†: Prologue - é¢„åŠ è½½ç¬¬ä¸€ä¸ªtile
    // ========================================================================
    // 
    // æ—¶åºå›¾ï¼š
    // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    // â”‚  Prologue: é¢„çƒ­æµæ°´çº¿                                       â”‚
    // â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
    // â”‚  â”‚ Load tile 0 â”‚  â—€â”€â”€ ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œå¿…é¡»ç­‰å¾…å®Œæˆæ‰èƒ½å¼€å§‹è®¡ç®—    â”‚
    // â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
    // â”‚         â”‚                                                  â”‚
    // â”‚         â–¼ __syncthreads()                                  â”‚
    // â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
    // â”‚  â”‚ Main Loop   â”‚  â—€â”€â”€ å¼€å§‹æ­£å¼çš„pingpongå¾ªç¯                â”‚
    // â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
    // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
    // åŠ è½½ç¬¬ä¸€ä¸ªtileåˆ° buffer[0]
    async_load_A_tile(A_smem[0], A, M, K, block_row, 0, tid);
    async_load_B_tile(B_smem[0], B, K, N, 0, block_col, tid);
  
    // ç¡®ä¿ç¬¬ä¸€ä¸ªtileåŠ è½½å®Œæˆ
    // è¿™æ˜¯æµæ°´çº¿å¯åŠ¨å¿…é¡»çš„åŒæ­¥ç‚¹
    __syncthreads();
  
    // Kç»´åº¦çš„è¿­ä»£æ¬¡æ•°
    const int num_k_tiles = (K + BK - 1) / BK;
  
    // ========================================================================
    // ç¬¬5éƒ¨åˆ†: ä¸»å¾ªç¯ - PingPong åŒç¼“å†²æµæ°´çº¿
    // ========================================================================
  
    for (int k_tile = 0; k_tile < num_k_tiles; k_tile++) {
        // å½“å‰ä½¿ç”¨çš„bufferç´¢å¼• (0 æˆ– 1)
        int curr_stage = k_tile % NUM_STAGES;
        // ä¸‹ä¸€ä¸ªè¦åŠ è½½çš„bufferç´¢å¼•
        int next_stage = (k_tile + 1) % NUM_STAGES;
      
        // ====================================================================
        // 5.1 å¼‚æ­¥é¢„å–ä¸‹ä¸€ä¸ªtileï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        // ====================================================================
        // 
        // å…³é”®ï¼šè¿™é‡Œçš„åŠ è½½æ˜¯å¼‚æ­¥çš„ï¼
        // å½“å‰è¿­ä»£çš„è®¡ç®—ä¼šä¸ä¸‹ä¸€ä¸ªtileçš„åŠ è½½å¹¶è¡Œæ‰§è¡Œ
        //
        if (k_tile + 1 < num_k_tiles) {
            int next_k_offset = (k_tile + 1) * BK;
            async_load_A_tile(A_smem[next_stage], A, M, K, block_row, next_k_offset, tid);
            async_load_B_tile(B_smem[next_stage], B, K, N, next_k_offset, block_col, tid);
        }
      
        // ====================================================================
        // 5.2 ä½¿ç”¨å½“å‰bufferè¿›è¡Œè®¡ç®—
        // ====================================================================
        // 
        // è¿™æ˜¯è®¡ç®—å¯†é›†å‹éƒ¨åˆ†ï¼š
        // ä» shared memory åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨ï¼Œæ‰§è¡Œä¹˜ç´¯åŠ 
        //
        // å†…å±‚å¾ªç¯ï¼šéå† BK ç»´åº¦
        #pragma unroll
        for (int k = 0; k < BK; k++) {
            // 5.2.1 ä» shared memory åŠ è½½åˆ°å¯„å­˜å™¨
            // æ¯ä¸ªçº¿ç¨‹åŠ è½½è‡ªå·±éœ€è¦çš„ A ç‰‡æ®µ (TMä¸ªå…ƒç´ )
            #pragma unroll
            for (int m = 0; m < TM; m++) {
                frag_A[m] = A_smem[curr_stage][SMEM_A_OFFSET(thread_row + m, k)];
            }
          
            // æ¯ä¸ªçº¿ç¨‹åŠ è½½è‡ªå·±éœ€è¦çš„ B ç‰‡æ®µ (TNä¸ªå…ƒç´ )
            #pragma unroll
            for (int n = 0; n < TN; n++) {
                frag_B[n] = B_smem[curr_stage][SMEM_B_OFFSET(k, thread_col + n)];
            }
          
            // 5.2.2 æ‰§è¡Œå¤–ç§¯è®¡ç®— (Outer Product)
            // C[m,n] += A[m,k] * B[k,n]
            #pragma unroll
            for (int m = 0; m < TM; m++) {
                #pragma unroll
                for (int n = 0; n < TN; n++) {
                    accum[m][n] += frag_A[m] * frag_B[n];
                }
            }
        }
      
        // ====================================================================
        // 5.3 åŒæ­¥ç‚¹ - ç­‰å¾…é¢„å–å®Œæˆï¼Œç¡®ä¿å¯ä»¥åˆ‡æ¢buffer
        // ====================================================================
        // 
        // ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåŒæ­¥ï¼Ÿ
        // 1. å½“å‰è®¡ç®—ä½¿ç”¨ buffer[curr_stage]
        // 2. å¼‚æ­¥åŠ è½½æ­£åœ¨å¡«å…… buffer[next_stage]
        // 3. ä¸‹ä¸€è½®è¿­ä»£ä¼šä½¿ç”¨ buffer[next_stage]
        // 4. å¿…é¡»ç¡®ä¿åŠ è½½å®Œæˆåæ‰èƒ½å¼€å§‹ä½¿ç”¨
        //
        // åŒæ­¥ç­–ç•¥æƒè¡¡ï¼š
        // - åŒæ­¥å¤ªå°‘ â†’ æ•°æ®ç«äº‰ï¼Œç»“æœé”™è¯¯
        // - åŒæ­¥å¤ªå¤š â†’ æµæ°´çº¿åœé¡¿ï¼Œæ€§èƒ½ä¸‹é™
        //
        __syncthreads();
    }
  
    // ========================================================================
    // ç¬¬6éƒ¨åˆ†: Epilogue - å°†ç»“æœå†™å› Global Memory
    // ========================================================================
  
    #pragma unroll
    for (int m = 0; m < TM; m++) {
        int global_row = block_row + thread_row + m;
        #pragma unroll
        for (int n = 0; n < TN; n++) {
            int global_col = block_col + thread_col + n;
            if (global_row < M && global_col < N) {
                C[global_row * N + global_col] = accum[m][n];
            }
        }
    }
}
```

### 3.4 è¿›é˜¶ç‰ˆæœ¬ï¼šä½¿ç”¨ `cp.async` PTX æŒ‡ä»¤

```cpp
// ============================================================================
// è¿›é˜¶ç‰ˆæœ¬ï¼šçœŸæ­£çš„å¼‚æ­¥ cp.async å®ç°
// ============================================================================
// 
// cp.async æŒ‡ä»¤ç›´æ¥åœ¨ç¡¬ä»¶çº§åˆ«å®ç° Global -> Shared çš„DMAä¼ è¾“
// ä¼˜åŠ¿ï¼š
// 1. ä¸å ç”¨å¯„å­˜å™¨ä½œä¸ºä¸­è½¬
// 2. ä¸é˜»å¡çº¿ç¨‹æ‰§è¡Œ
// 3. å¯ä»¥ä¸è®¡ç®—å®Œå…¨overlap

/**
 * @brief ä½¿ç”¨ cp.async çš„tileåŠ è½½å‡½æ•°
 */
__device__ __forceinline__ void cp_async_load_A(
    float* smem,
    const float* global_ptr,
    int M, int K,
    int block_row, int k_offset,
    int tid
) {
    constexpr int LOAD_PER_THREAD = (BM * BK) / BLOCK_SIZE;
  
    #pragma unroll
    for (int i = 0; i < LOAD_PER_THREAD; i++) {
        int idx = tid + i * BLOCK_SIZE;
        int row = idx / BK;
        int col = idx % BK;
      
        int gRow = block_row + row;
        int gCol = k_offset + col;
      
        // è®¡ç®—shared memoryç›®æ ‡åœ°å€
        float* dst = smem + SMEM_A_OFFSET(row, col);
      
        if (gRow < M && gCol < K) {
            const float* src = global_ptr + gRow * K + gCol;
          
            // ä½¿ç”¨ PTX å†…è”æ±‡ç¼–å®ç° cp.async
            // cp.async.cg: cache at global level
            // .shared.global: from global to shared
            // [dst], [src], 4: å¤åˆ¶4å­—èŠ‚ (1 float)
            asm volatile(
                "cp.async.cg.shared.global [%0], [%1], 4;\n"
                :: "r"(static_cast<uint32_t>(__cvta_generic_to_shared(dst))),
                   "l"(src)
            );
        } else {
            // å¯¹äºè¶Šç•Œè®¿é—®ï¼Œç›´æ¥å†™0
            *dst = 0.0f;
        }
    }
}

/**
 * @brief cp.async çš„åŒæ­¥åŸè¯­
 * 
 * cp.async.commit_group: æäº¤å½“å‰çš„å¼‚æ­¥æ“ä½œç»„
 * cp.async.wait_group N: ç­‰å¾…ç›´åˆ°åªå‰©Nä¸ªgroupæœªå®Œæˆ
 */
__device__ __forceinline__ void cp_async_commit() {
    asm volatile("cp.async.commit_group;\n" ::);
}

__device__ __forceinline__ void cp_async_wait_group(int n) {
    // wait_group<N> ç­‰å¾…ç›´åˆ°åªå‰©Nä¸ªgroup
    if (n == 0) {
        asm volatile("cp.async.wait_group 0;\n" ::);
    } else if (n == 1) {
        asm volatile("cp.async.wait_group 1;\n" ::);
    }
}

// ============================================================================
// ä½¿ç”¨ cp.async çš„å®Œæ•´ kernel
// ============================================================================
__global__ void __launch_bounds__(BLOCK_SIZE)
pingpong_gemm_cpassync_kernel(
    const float* __restrict__ A,
    const float* __restrict__ B,
    float* __restrict__ C,
    int M, int N, int K
) {
    const int bx = blockIdx.x;
    const int by = blockIdx.y;
    const int tid = threadIdx.x;
  
    const int block_row = by * BM;
    const int block_col = bx * BN;
  
    const int thread_row = (tid / (BN / TN)) * TM;
    const int thread_col = (tid % (BN / TN)) * TN;
  
    __shared__ float A_smem[NUM_STAGES][BM * (BK + 1)];
    __shared__ float B_smem[NUM_STAGES][BK * (BN + 1)];
  
    float accum[TM][TN] = {0.0f};
    float frag_A[TM];
    float frag_B[TN];
  
    const int num_k_tiles = (K + BK - 1) / BK;
  
    // Prologue: é¢„åŠ è½½å‰ä¸¤ä¸ªstageï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    // è¿™æ ·å¯ä»¥å®ç°æ›´æ·±çš„æµæ°´çº¿
    cp_async_load_A(A_smem[0], A, M, K, block_row, 0, tid);
    // (ç±»ä¼¼åœ°åŠ è½½B...)
    cp_async_commit();  // æäº¤ç¬¬ä¸€ç»„
  
    if (num_k_tiles > 1) {
        cp_async_load_A(A_smem[1], A, M, K, block_row, BK, tid);
        // (ç±»ä¼¼åœ°åŠ è½½B...)
        cp_async_commit();  // æäº¤ç¬¬äºŒç»„
    }
  
    // ç­‰å¾…ç¬¬ä¸€ä¸ªstageå®Œæˆ
    cp_async_wait_group(1);  // ç­‰å¾…ç›´åˆ°åªå‰©1ä¸ªgroupåœ¨flight
    __syncthreads();
  
    // Main Loop
    for (int k_tile = 0; k_tile < num_k_tiles; k_tile++) {
        int curr = k_tile % 2;
      
        // é¢„å– k_tile + 2 (å¦‚æœå­˜åœ¨)
        if (k_tile + 2 < num_k_tiles) {
            int prefetch_stage = (k_tile + 2) % 2;
            cp_async_load_A(A_smem[prefetch_stage], A, M, K, 
                           block_row, (k_tile + 2) * BK, tid);
            cp_async_commit();
        }
      
        // è®¡ç®—å½“å‰tile
        #pragma unroll
        for (int k = 0; k < BK; k++) {
            #pragma unroll
            for (int m = 0; m < TM; m++) {
                frag_A[m] = A_smem[curr][SMEM_A_OFFSET(thread_row + m, k)];
            }
            #pragma unroll
            for (int n = 0; n < TN; n++) {
                frag_B[n] = B_smem[curr][SMEM_B_OFFSET(k, thread_col + n)];
            }
            #pragma unroll
            for (int m = 0; m < TM; m++) {
                #pragma unroll
                for (int n = 0; n < TN; n++) {
                    accum[m][n] += frag_A[m] * frag_B[n];
                }
            }
        }
      
        // ç­‰å¾…ä¸‹ä¸€ä¸ªtileå‡†å¤‡å¥½
        cp_async_wait_group(1);
        __syncthreads();
    }
  
    // Write back
    #pragma unroll
    for (int m = 0; m < TM; m++) {
        int gRow = block_row + thread_row + m;
        #pragma unroll
        for (int n = 0; n < TN; n++) {
            int gCol = block_col + thread_col + n;
            if (gRow < M && gCol < N) {
                C[gRow * N + gCol] = accum[m][n];
            }
        }
    }
}
```

### 3.5 ä¸»æœºç«¯ä»£ç ï¼šStream ä¸å¼‚æ­¥æ‰§è¡Œ

```cpp
// ============================================================================
// ä¸»æœºç«¯ï¼šCUDA Stream å¼‚æ­¥ç¼–æ’
// ============================================================================

/**
 * è®¾è®¡ç›®æ ‡ï¼š
 * 1. æ•´ä¸ªè®¡ç®—æµç¨‹å…¨ç¨‹åœ¨GPUä¸Šæ‰§è¡Œ
 * 2. CPUåªè´Ÿè´£å¯åŠ¨å’Œæœ€ç»ˆç»“æœæ£€æŸ¥
 * 3. ä¸­é—´æ— CPU-GPUåŒæ­¥
 */

class GemmRunner {
private:
    float *d_A, *d_B, *d_C;
    int M, N, K;
    cudaStream_t compute_stream;
    cudaEvent_t start_event, stop_event;
  
public:
    GemmRunner(int m, int n, int k) : M(m), N(n), K(k) {
        // åˆ›å»ºéé˜»å¡stream
        CUDA_CHECK(cudaStreamCreateWithFlags(&compute_stream, 
                                              cudaStreamNonBlocking));
        CUDA_CHECK(cudaEventCreate(&start_event));
        CUDA_CHECK(cudaEventCreate(&stop_event));
      
        // åˆ†é…è®¾å¤‡å†…å­˜
        CUDA_CHECK(cudaMalloc(&d_A, M * K * sizeof(float)));
        CUDA_CHECK(cudaMalloc(&d_B, K * N * sizeof(float)));
        CUDA_CHECK(cudaMalloc(&d_C, M * N * sizeof(float)));
    }
  
    ~GemmRunner() {
        cudaFree(d_A);
        cudaFree(d_B);
        cudaFree(d_C);
        cudaStreamDestroy(compute_stream);
        cudaEventDestroy(start_event);
        cudaEventDestroy(stop_event);
    }
  
    /**
     * @brief å¼‚æ­¥æ‰§è¡ŒGEMMï¼Œç«‹å³è¿”å›
     * 
     * æ•°æ®æµï¼š
     * CPU (h_A, h_B) â†’ GPU Stream â†’ D2H only when needed
     *      â†“ async copy
     *   GPU Kernel (multiple launches can be queued)
     *      â†“ async 
     *   Result ready (signaled by event)
     */
    void async_execute(const float* h_A, const float* h_B) {
        // å¼‚æ­¥æ‹·è´è¾“å…¥æ•°æ®åˆ°GPU
        CUDA_CHECK(cudaMemcpyAsync(d_A, h_A, M * K * sizeof(float),
                                   cudaMemcpyHostToDevice, compute_stream));
        CUDA_CHECK(cudaMemcpyAsync(d_B, h_B, K * N * sizeof(float),
                                   cudaMemcpyHostToDevice, compute_stream));
      
        // è®°å½•å¼€å§‹æ—¶é—´
        CUDA_CHECK(cudaEventRecord(start_event, compute_stream));
      
        // é…ç½®kernelå¯åŠ¨å‚æ•°
        dim3 block(BLOCK_SIZE);
        dim3 grid((N + BN - 1) / BN, (M + BM - 1) / BM);
      
        // å¯åŠ¨kernel - è¿™ä¸ªè°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼Œç«‹å³è¿”å›
        pingpong_gemm_kernel<<<grid, block, 0, compute_stream>>>(
            d_A, d_B, d_C, M, N, K
        );
      
        // è®°å½•ç»“æŸæ—¶é—´
        CUDA_CHECK(cudaEventRecord(stop_event, compute_stream));
      
        // æ³¨æ„ï¼šæ­¤æ—¶CPUå¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼
    }
  
    /**
     * @brief ç­‰å¾…ç»“æœå¹¶è·å–æ—¶é—´
     */
    float sync_and_get_time() {
        CUDA_CHECK(cudaEventSynchronize(stop_event));
        float ms;
        CUDA_CHECK(cudaEventElapsedTime(&ms, start_event, stop_event));
        return ms;
    }
  
    /**
     * @brief å¼‚æ­¥è·å–ç»“æœ
     */
    void async_get_result(float* h_C) {
        CUDA_CHECK(cudaMemcpyAsync(h_C, d_C, M * N * sizeof(float),
                                   cudaMemcpyDeviceToHost, compute_stream));
    }
};

// ============================================================================
// CUDA Graphï¼šå¤škernelå›¾ä¼˜åŒ–
// ============================================================================
/**
 * å½“éœ€è¦å¤šæ¬¡æ‰§è¡Œç›¸åŒçš„kernelåºåˆ—æ—¶ï¼ŒCUDA Graphå¯ä»¥ï¼š
 * 1. å‡å°‘kernelå¯åŠ¨å¼€é”€
 * 2. è®©GPUè°ƒåº¦å™¨æå‰è§„åˆ’æ‰§è¡Œ
 * 3. æ¶ˆé™¤CPU-GPUå¾€è¿”å»¶è¿Ÿ
 */
class GemmGraphRunner {
private:
    cudaGraph_t graph;
    cudaGraphExec_t graph_exec;
    bool graph_captured = false;
  
public:
    /**
     * @brief æ•è·æ‰§è¡Œå›¾
     */
    void capture_graph(GemmRunner& runner, 
                       const float* h_A, const float* h_B,
                       cudaStream_t stream) {
      
        // å¼€å§‹å›¾æ•è·
        CUDA_CHECK(cudaStreamBeginCapture(stream, 
                                          cudaStreamCaptureModeGlobal));
      
        // åœ¨æ•è·æ¨¡å¼ä¸‹æ‰§è¡Œæ“ä½œ
        runner.async_execute(h_A, h_B);
      
        // ç»“æŸæ•è·ï¼Œç”Ÿæˆå›¾
        CUDA_CHECK(cudaStreamEndCapture(stream, &graph));
      
        // å®ä¾‹åŒ–å›¾ï¼ˆç¼–è¯‘ä¼˜åŒ–ï¼‰
        CUDA_CHECK(cudaGraphInstantiate(&graph_exec, graph, 
                                        nullptr, nullptr, 0));
        graph_captured = true;
    }
  
    /**
     * @brief æ‰§è¡Œæ•è·çš„å›¾
     */
    void launch_graph(cudaStream_t stream) {
        if (graph_captured) {
            CUDA_CHECK(cudaGraphLaunch(graph_exec, stream));
        }
    }
  
    ~GemmGraphRunner() {
        if (graph_captured) {
            cudaGraphExecDestroy(graph_exec);
            cudaGraphDestroy(graph);
        }
    }
};
```

### 3.6 å®Œæ•´ä¸»å‡½æ•°

```cpp
// ============================================================================
// éªŒè¯å’Œæ€§èƒ½æµ‹è¯•
// ============================================================================

void cpu_gemm_reference(const float* A, const float* B, float* C, 
                        int M, int N, int K) {
    for (int i = 0; i < M; i++) {
        for (int j = 0; j < N; j++) {
            float sum = 0.0f;
            for (int k = 0; k < K; k++) {
                sum += A[i * K + k] * B[k * N + j];
            }
            C[i * N + j] = sum;
        }
    }
}

bool verify_result(const float* gpu_result, const float* cpu_result, 
                   int size, float tolerance = 1e-3f) {
    for (int i = 0; i < size; i++) {
        float diff = std::abs(gpu_result[i] - cpu_result[i]);
        float rel_diff = diff / (std::abs(cpu_result[i]) + 1e-6f);
        if (rel_diff > tolerance) {
            std::cerr << "Mismatch at index " << i 
                      << ": GPU=" << gpu_result[i] 
                      << ", CPU=" << cpu_result[i] << std::endl;
            return false;
        }
    }
    return true;
}

int main(int argc, char** argv) {
    // çŸ©é˜µå°ºå¯¸
    int M = 1024, N = 1024, K = 1024;
    if (argc >= 4) {
        M = std::atoi(argv[1]);
        N = std::atoi(argv[2]);
        K = std::atoi(argv[3]);
    }
  
    std::cout << "=== PingPong GEMM Demo ===" << std::endl;
    std::cout << "Matrix size: [" << M << " x " << K << "] Ã— [" 
              << K << " x " << N << "]" << std::endl;
  
    // åˆ†é…ä¸»æœºå†…å­˜ï¼ˆä½¿ç”¨pinned memoryåŠ é€Ÿä¼ è¾“ï¼‰
    float *h_A, *h_B, *h_C, *h_C_ref;
    CUDA_CHECK(cudaMallocHost(&h_A, M * K * sizeof(float)));
    CUDA_CHECK(cudaMallocHost(&h_B, K * N * sizeof(float)));
    CUDA_CHECK(cudaMallocHost(&h_C, M * N * sizeof(float)));
    h_C_ref = new float[M * N];
  
    // åˆå§‹åŒ–éšæœºæ•°æ®
    std::mt19937 gen(42);
    std::uniform_real_distribution<float> dist(-1.0f, 1.0f);
    for (int i = 0; i < M * K; i++) h_A[i] = dist(gen);
    for (int i = 0; i < K * N; i++) h_B[i] = dist(gen);
  
    // åˆ›å»ºGEMMè¿è¡Œå™¨
    GemmRunner runner(M, N, K);
  
    // Warm-up
    std::cout << "\n[Warm-up run]" << std::endl;
    runner.async_execute(h_A, h_B);
    runner.sync_and_get_time();
  
    // æ€§èƒ½æµ‹è¯•
    const int num_runs = 100;
    std::cout << "\n[Performance test: " << num_runs << " runs]" << std::endl;
  
    float total_time = 0.0f;
    for (int i = 0; i < num_runs; i++) {
        runner.async_execute(h_A, h_B);
        total_time += runner.sync_and_get_time();
    }
  
    float avg_time = total_time / num_runs;
    float tflops = (2.0f * M * N * K) / (avg_time * 1e9f);  // ms -> TFLOPS
  
    std::cout << "Average time: " << avg_time << " ms" << std::endl;
    std::cout << "Performance: " << tflops << " TFLOPS" << std::endl;
  
    // éªŒè¯æ­£ç¡®æ€§
    std::cout << "\n[Verification]" << std::endl;
    runner.async_get_result(h_C);
    CUDA_CHECK(cudaDeviceSynchronize());
  
    if (M <= 512 && N <= 512 && K <= 512) {
        std::cout << "Running CPU reference..." << std::endl;
        cpu_gemm_reference(h_A, h_B, h_C_ref, M, N, K);
        if (verify_result(h_C, h_C_ref, M * N)) {
            std::cout << "âœ“ Result PASSED!" << std::endl;
        } else {
            std::cout << "âœ— Result FAILED!" << std::endl;
        }
    } else {
        std::cout << "(Skipping CPU verification for large matrices)" << std::endl;
    }
  
    // æ¸…ç†
    cudaFreeHost(h_A);
    cudaFreeHost(h_B);
    cudaFreeHost(h_C);
    delete[] h_C_ref;
  
    return 0;
}
```

---

## 4. é€å±‚æŠ€æœ¯è§£æ

### 4.1 æ•°æ®åŠ è½½å±‚ï¼šGlobal â†’ Shared Memory

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     cp.async å¼‚æ­¥åŠ è½½å·¥ä½œåŸç†                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         ä¼ ç»ŸåŒæ­¥åŠ è½½                                  â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚    Thread         Memory Controller        Shared Memory            â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚â”€â”€â”€ LD.Global â”€â”€â”€â–¶â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚   (å‘èµ·è¯·æ±‚)      â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ”‚â–ˆâ–ˆâ–ˆâ–ˆ ç­‰å¾… â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚   (çº¿ç¨‹é˜»å¡ï¼Œæµªè´¹å‘¨æœŸ)    â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚â—€â”€â”€ æ•°æ®è¿”å› â”€â”€â”€â”€â”€â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚   (åˆ°å¯„å­˜å™¨)      â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚â”€â”€â”€ ST.Shared â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚   (å­˜åˆ°smem)     â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â–¼                  â–¼                       â–¼                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        cp.async å¼‚æ­¥åŠ è½½                              â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚    Thread         Memory Controller        Shared Memory            â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚â”€â”€ cp.async â”€â”€â”€â”€â”€â–¶â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚  (å‘èµ·,ç«‹å³è¿”å›)  â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚  ç»§ç»­æ‰§è¡Œ        â”‚â”€â”€â”€â”€â”€â”€ DMAä¼ è¾“ â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚  å…¶ä»–è®¡ç®—        â”‚    (åå°è¿›è¡Œ)          â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚  ä¸è¢«é˜»å¡!       â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                       â”‚ â—€â”€â”€ æ•°æ®å°±ä½      â”‚    â”‚
â”‚  â”‚       â”‚  ...             â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚                  â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚â”€â”€ wait_group â”€â”€â”€â–¶â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â”‚  (éœ€è¦æ—¶æ‰ç­‰å¾…)   â”‚                       â”‚                  â”‚    â”‚
â”‚  â”‚       â–¼                  â–¼                       â–¼                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è®¡ç®—å±‚ï¼šShared â†’ Register â†’ Accumulator

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           çº¿ç¨‹çº§è®¡ç®—ç¤ºæ„å›¾                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   Shared Memory A_smem[BM][BK]          Shared Memory B_smem[BK][BN]           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚        â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚         â”‚
â”‚   â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚        â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚         â”‚
â”‚   â”‚ â–’â–’â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚â—€â”€â”€â”    â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚         â”‚
â”‚   â”‚ â–’â–’â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚   â”‚    â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚         â”‚
â”‚   â”‚ â–’â–’â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚   â”‚    â”‚ â–’â–’â–’â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’â–’â–’â–’ â”‚â—€â”€â”€â”     â”‚
â”‚   â”‚ â–’â–’â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚   â”‚    â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚   â”‚     â”‚
â”‚   â”‚ â–’â–’â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚   â”‚    â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚   â”‚     â”‚
â”‚   â”‚ â–’â–’â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚   â”‚    â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’ â”‚   â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚         â–² TM=8è¡Œ                   â”‚           TN=8åˆ— â–²                  â”‚     â”‚
â”‚         â”‚                         â”‚                  â”‚                  â”‚     â”‚
â”‚         â”‚ åŠ è½½åˆ°                   â”‚                  â”‚ åŠ è½½åˆ°            â”‚     â”‚
â”‚         â”‚ å¯„å­˜å™¨                   â”‚                  â”‚ å¯„å­˜å™¨            â”‚     â”‚
â”‚         â”‚                         â”‚                  â”‚                  â”‚     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”              Thread                  â”Œâ”´â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚     â”‚
â”‚    â”‚ frag_A  â”‚              è´Ÿè´£çš„                  â”‚ frag_B  â”‚         â”‚     â”‚
â”‚    â”‚ [TM]    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•°æ®åŒºåŸŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  [TN]   â”‚         â”‚     â”‚
â”‚    â”‚         â”‚                â”‚                     â”‚         â”‚         â”‚     â”‚
â”‚    â”‚ [0]     â”‚                â”‚                     â”‚ [0]     â”‚         â”‚     â”‚
â”‚    â”‚ [1]     â”‚                â”‚                     â”‚ [1]     â”‚         â”‚     â”‚
â”‚    â”‚ [2]     â”‚                â”‚                     â”‚ [2]     â”‚         â”‚     â”‚
â”‚    â”‚  ...    â”‚                â”‚                     â”‚  ...    â”‚         â”‚     â”‚
â”‚    â”‚ [7]     â”‚                â”‚                     â”‚ [7]     â”‚         â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚     â”‚
â”‚         â”‚                     â”‚                          â”‚              â”‚     â”‚
â”‚         â”‚                     â–¼                          â”‚              â”‚     â”‚
â”‚         â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚              â”‚     â”‚
â”‚         â”‚            â”‚  å¤–ç§¯è®¡ç®—        â”‚                 â”‚              â”‚     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  (Outer Product)â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚     â”‚
â”‚                      â”‚                 â”‚                                â”‚     â”‚
â”‚                      â”‚ accum[m][n] +=  â”‚                                â”‚     â”‚
â”‚                      â”‚ frag_A[m] *     â”‚                                â”‚     â”‚
â”‚                      â”‚ frag_B[n]       â”‚                                â”‚     â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚     â”‚
â”‚                               â”‚                                         â”‚     â”‚
â”‚                               â–¼                                         â”‚     â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚     â”‚
â”‚                      â”‚  accum[TM][TN]  â”‚  â—€â”€â”€ å¯„å­˜å™¨ä¸­ç´¯åŠ                â”‚     â”‚
â”‚                      â”‚                 â”‚      æ•´ä¸ªKå¾ªç¯åå†™å›             â”‚     â”‚
â”‚                      â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”  â”‚                                â”‚     â”‚
â”‚                      â”‚  â”‚ * â”‚ * â”‚...â”‚  â”‚  TM Ã— TN = 64 ä¸ªå…ƒç´             â”‚     â”‚
â”‚                      â”‚  â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤  â”‚                                â”‚     â”‚
â”‚                      â”‚  â”‚ * â”‚ * â”‚...â”‚  â”‚                                â”‚     â”‚
â”‚                      â”‚  â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤  â”‚                                â”‚     â”‚
â”‚                      â”‚  â”‚...â”‚...â”‚...â”‚  â”‚                                â”‚     â”‚
â”‚                      â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜  â”‚                                â”‚     â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚     â”‚
â”‚                                                                         â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Block å’Œ Thread å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Block å’Œ Thread ä»»åŠ¡åˆ†é…å›¾                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   Matrix C [M Ã— N]                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚     Block(0,0)    Block(1,0)    Block(2,0)    ...                       â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚  â”‚
â”‚   â”‚   â”‚  BMÃ—BN    â”‚ â”‚           â”‚ â”‚           â”‚                             â”‚  â”‚
â”‚   â”‚   â”‚  128Ã—128  â”‚ â”‚           â”‚ â”‚           â”‚                             â”‚  â”‚
â”‚   â”‚   â”‚           â”‚ â”‚           â”‚ â”‚           â”‚                             â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚  â”‚
â”‚   â”‚     Block(0,1)    Block(1,1)                                            â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚  â”‚
â”‚   â”‚   â”‚           â”‚ â”‚           â”‚      æ¯ä¸ªBlockè´Ÿè´£                         â”‚  â”‚
â”‚   â”‚   â”‚           â”‚ â”‚           â”‚      CçŸ©é˜µçš„ä¸€ä¸ª                           â”‚  â”‚
â”‚   â”‚   â”‚           â”‚ â”‚           â”‚      128Ã—128 åŒºåŸŸ                          â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚  â”‚
â”‚   â”‚   ...                                                                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                                 â”‚
â”‚   Single Block å†…éƒ¨ Thread å¸ƒå±€ (256 threads)                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   Blockå¤„ç†çš„CåŒºåŸŸ [BM Ã— BN] = [128 Ã— 128]                               â”‚  â”‚
â”‚   â”‚   è¢«åˆ’åˆ†ç»™ 256 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç† [TM Ã— TN] = [8 Ã— 8] = 64 ä¸ªå…ƒç´         â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   çº¿ç¨‹å¸ƒå±€: (BM/TM) Ã— (BN/TN) = 16 Ã— 16 = 256 threads                    â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€...â”€â”€â”                      â”‚  â”‚
â”‚   â”‚   â”‚T000â”‚T001â”‚T002â”‚T003â”‚T004â”‚T005â”‚T006â”‚T007â”‚      â”‚  â—€â”€ row 0           â”‚  â”‚
â”‚   â”‚   â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚ ...  â”‚     (16 threads)    â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤                      â”‚  â”‚
â”‚   â”‚   â”‚T016â”‚T017â”‚T018â”‚T019â”‚T020â”‚T021â”‚T022â”‚T023â”‚      â”‚  â—€â”€ row 1           â”‚  â”‚
â”‚   â”‚   â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚ ...  â”‚                      â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤                      â”‚  â”‚
â”‚   â”‚   â”‚ ...â”‚ ...â”‚ ...â”‚ ...â”‚ ...â”‚ ...â”‚ ...â”‚ ...â”‚ ...  â”‚                      â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤                      â”‚  â”‚
â”‚   â”‚   â”‚T240â”‚T241â”‚T242â”‚T243â”‚T244â”‚T245â”‚T246â”‚T247â”‚      â”‚  â—€â”€ row 15          â”‚  â”‚
â”‚   â”‚   â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚8Ã—8 â”‚ ...  â”‚                      â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   Thread ID (tid) â†’ ä½ç½®è®¡ç®—:                                            â”‚  â”‚
â”‚   â”‚   thread_row = (tid / 16) * 8    // ç¬¬å‡ ä¸ª8Ã—8å—çš„è¡Œ                       â”‚  â”‚
â”‚   â”‚   thread_col = (tid % 16) * 8    // ç¬¬å‡ ä¸ª8Ã—8å—çš„åˆ—                       â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. åŒæ­¥ç­–ç•¥æ·±åº¦åˆ†æ

### 5.1 åŒæ­¥ç‚¹åˆ†ç±»ä¸æƒè¡¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          åŒæ­¥ç­–ç•¥åˆ†æ                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        åŒæ­¥ç±»å‹å¯¹æ¯”                                        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â”‚  åŒæ­¥ç±»å‹              â”‚ å¼€é”€    â”‚ ç²’åº¦    â”‚ ä½¿ç”¨åœºæ™¯                       â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  __syncthreads()      â”‚ ä¸­ç­‰   â”‚ Block  â”‚ ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå…±äº«å†…å­˜è®¿é—®      â”‚ â”‚
â”‚  â”‚  __syncwarp()         â”‚ ä½     â”‚ Warp   â”‚ Warpå†…åŒæ­¥ï¼ˆéšå¼shuffleç­‰ï¼‰      â”‚ â”‚
â”‚  â”‚  cp.async.wait_group  â”‚ ä½     â”‚ å¼‚æ­¥   â”‚ ç­‰å¾…å¼‚æ­¥æ‹·è´å®Œæˆ                 â”‚ â”‚
â”‚  â”‚  __threadfence()      â”‚ é«˜     â”‚ å…¨å±€   â”‚ ç¡®ä¿å…¨å±€å†…å­˜å¯è§æ€§               â”‚ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     PingPongä¸­çš„åŒæ­¥æ—¶åºå›¾                                  â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â”‚  Time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â”‚  Buffer 0:  â”Œâ”€Loadâ”€â”      â”Œâ”€â”€â”€â”€â”€â”€Computeâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€Loadâ”€â”            â”‚ â”‚
â”‚  â”‚             â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ             â”‚ â”‚
â”‚  â”‚                    â”‚                         â”‚             â”‚             â”‚ â”‚
â”‚  â”‚  Buffer 1:         â”‚    â”Œâ”€Loadâ”€â”      â”Œâ”€â”€â”€â”€â”€â”€Computeâ”€â”€â”€â”€â”€â”€â”â”‚             â”‚ â”‚
â”‚  â”‚                    â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â”‚â”‚             â”‚ â”‚
â”‚  â”‚                    â”‚           â”‚                         â”‚â”‚             â”‚ â”‚
â”‚  â”‚  Sync:             â–¼           â–¼                         â–¼â–¼             â”‚ â”‚
â”‚  â”‚               __sync()    __sync()                   __sync()           â”‚ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â”‚  âœ… æ­£ç¡®åŒæ­¥ç‚¹ï¼š                                                           â”‚ â”‚
â”‚  â”‚  1. Loadç»“æŸåã€Computeå¼€å§‹å‰ï¼šç¡®ä¿æ•°æ®å°±ç»ª                                 â”‚ â”‚
â”‚  â”‚  2. åˆ‡æ¢bufferæ—¶ï¼šç¡®ä¿ä¸Šä¸€è½®Loadå®Œæˆ                                       â”‚ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â”‚  âŒ è¿‡åº¦åŒæ­¥ï¼ˆåº”é¿å…ï¼‰ï¼š                                                    â”‚ â”‚
â”‚  â”‚  - æ¯æ¬¡Loadåç«‹å³syncï¼ˆå¦‚æœå¯ä»¥overlapå°±ä¸éœ€è¦ï¼‰                            â”‚ â”‚
â”‚  â”‚  - Computeå†…éƒ¨syncï¼ˆå¯„å­˜å™¨æ“ä½œä¸éœ€è¦ï¼‰                                      â”‚ â”‚
â”‚  â”‚                                                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ•°æ®ç«äº‰åˆ†æ

```cpp
// ============================================================================
// æ•°æ®ç«äº‰åœºæ™¯åˆ†æ
// ============================================================================

/**
 * åœºæ™¯1ï¼šè¯»åå†™(RAW)å†²çª
 * 
 * Thread A: æ­£åœ¨è¯»å– smem[0][i] è¿›è¡Œè®¡ç®—
 * Thread B: æ­£åœ¨å†™å…¥ smem[0][i] åŠ è½½ä¸‹ä¸€ä¸ªtile
 * 
 * é—®é¢˜ï¼šBè¦†ç›–äº†Aè¿˜æ²¡è¯»å®Œçš„æ•°æ®
 * è§£å†³ï¼šä½¿ç”¨åŒç¼“å†²ï¼ŒAè¯»buffer[0]æ—¶ï¼ŒBå†™buffer[1]
 */

/**
 * åœºæ™¯2ï¼šå†™åè¯»(WAR)å†²çª
 * 
 * Thread A: åˆšå†™å®Œ smem[1][i]
 * Thread B: æƒ³è¯»å– smem[1][i] ä½†Aè¿˜æ²¡å®Œå…¨å†™å®Œ
 * 
 * é—®é¢˜ï¼šBè¯»åˆ°ä¸å®Œæ•´çš„æ•°æ®
 * è§£å†³ï¼šåœ¨åˆ‡æ¢bufferå‰ä½¿ç”¨__syncthreads()
 */

// æ­£ç¡®çš„åŒæ­¥æ¨¡å¼ç¤ºä¾‹
__global__ void correct_sync_pattern() {
    __shared__ float buf[2][SIZE];
  
    // Prologue: åŠ è½½ç¬¬ä¸€ä¸ªtile
    load_tile(buf[0], ...);
    __syncthreads();  // åŒæ­¥ç‚¹1: ç¡®ä¿åŠ è½½å®Œæˆ
  
    for (int k = 0; k < K_TILES; k++) {
        int curr = k % 2;
        int next = (k + 1) % 2;
      
        // å¼‚æ­¥é¢„å–ä¸‹ä¸€ä¸ªï¼ˆä¸é˜»å¡ï¼‰
        if (k + 1 < K_TILES) {
            async_load_tile(buf[next], ...);
        }
      
        // ä½¿ç”¨å½“å‰bufferè®¡ç®—ï¼ˆè¿™é‡Œä¸éœ€è¦é¢å¤–åŒæ­¥ï¼‰
        compute_with(buf[curr], ...);
      
        // åŒæ­¥ç‚¹2: ç¡®ä¿ä¸‹ä¸€ä¸ªtileåŠ è½½å®Œæˆï¼Œä¸”è®¡ç®—å®Œæˆåæ‰èƒ½åˆ‡æ¢
        __syncthreads();
    }
  
    // å†™å›ç»“æœ
    store_result(...);
}
```

---

## 6. CPU-GPU å¼‚æ­¥ç¼–æ’

### 6.1 Stream å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CUDA Stream å¼‚æ­¥æ‰§è¡Œæ¨¡å‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                          å•Streamæ‰§è¡Œ                                    â”‚  â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   CPUä»£ç æ‰§è¡Œ:                                                           â”‚  â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚  â”‚
â”‚   â”‚   â”‚ cudaMemcpyAsync â”‚ kernel<<<>>> â”‚ cudaMemcpyAsync â”‚ ç»§ç»­å…¶ä»–ä»»åŠ¡...   â”‚  â”‚
â”‚   â”‚   â”‚    (æ’é˜Ÿ)       â”‚   (æ’é˜Ÿ)      â”‚    (æ’é˜Ÿ)       â”‚                  â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚  â”‚
â”‚   â”‚            â”‚ Streamå†…       â”‚ é¡ºåºæ‰§è¡Œ        â”‚                          â”‚  â”‚
â”‚   â”‚            â–¼                â–¼                â–¼                          â”‚  â”‚
â”‚   â”‚   GPUæ‰§è¡Œ:                                                               â”‚  â”‚
â”‚   â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚   â”‚        â”‚   H2D Copy  â”‚â–¶â”‚   Kernel    â”‚â–¶â”‚   D2H Copy  â”‚                  â”‚  â”‚
â”‚   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        å¤šStreamå¹¶è¡Œæ‰§è¡Œ                                   â”‚  â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   CPU:                                                                  â”‚  â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚  â”‚
â”‚   â”‚   â”‚ setup stream0 â”‚ setup stream1 â”‚ setup stream2 â”‚ ... â”‚sync (å¯é€‰)   â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚
â”‚   â”‚           â”‚               â”‚               â”‚                             â”‚  â”‚
â”‚   â”‚   GPU:    â–¼               â–¼               â–¼                             â”‚  â”‚
â”‚   â”‚   Stream0: â”Œâ”€â”€H2Dâ”€â”€â”â”Œâ”€kernelâ”€â”â”Œâ”€â”€D2Hâ”€â”€â”                                 â”‚  â”‚
â”‚   â”‚   Stream1:      â”Œâ”€â”€H2Dâ”€â”€â”â”Œâ”€kernelâ”€â”â”Œâ”€â”€D2Hâ”€â”€â”    â—€â”€â”€ å¹¶è¡Œæ‰§è¡Œ!           â”‚  â”‚
â”‚   â”‚   Stream2:           â”Œâ”€â”€H2Dâ”€â”€â”â”Œâ”€kernelâ”€â”â”Œâ”€â”€D2Hâ”€â”€â”                       â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â”‚   ç¡¬ä»¶å¼•æ“:                                                              â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚   â”‚   â”‚ Copy Engine:  [stream0_H2D][stream1_H2D][stream2_H2D]...         â”‚ â”‚  â”‚
â”‚   â”‚   â”‚ Compute Engine: â–â–â–â–â–â–â–â–[s0_kernel][s1_kernel][s2_kernel]...    â”‚ â”‚  â”‚
â”‚   â”‚   â”‚ Copy Engine:  â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–[s0_D2H][s1_D2H][s2_D2H]...     â”‚ â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚   â”‚                                                                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 CUDA Graph ä¼˜åŒ–

```cpp
// ============================================================================
// CUDA Graph å·¥ä½œæµç¨‹ç¤ºä¾‹
// ============================================================================

/**
 * CUDA Graph è§£å†³çš„é—®é¢˜ï¼š
 * 
 * ä¼ ç»Ÿæ–¹å¼æ¯æ¬¡kernelå¯åŠ¨éƒ½éœ€è¦:
 * 1. CPUå‡†å¤‡å‚æ•°
 * 2. CPUä¸GPUé©±åŠ¨é€šä¿¡
 * 3. GPUè°ƒåº¦å™¨æ¥æ”¶ä»»åŠ¡
 * 
 * å½“kernelå¾ˆå¤šæˆ–å¾ˆå¿«æ—¶ï¼Œè¿™ä¸ªå¼€é”€ä¼šæˆä¸ºç“¶é¢ˆ
 * 
 * CUDA Graph: é¢„å…ˆå½•åˆ¶æ•´ä¸ªæ‰§è¡Œæµç¨‹ï¼Œä¸€æ¬¡æ€§æäº¤
 */

class GemmPipeline {
public:
    // å¯¹äºéœ€è¦é‡å¤æ‰§è¡Œçš„GEMMæµæ°´çº¿ï¼ŒGraphéå¸¸æœ‰æ•ˆ
    void create_execution_graph(int num_iterations) {
        cudaStream_t stream;
        cudaStreamCreate(&stream);
      
        // å¼€å§‹æ•è·
        cudaStreamBeginCapture(stream, cudaStreamCaptureModeGlobal);
      
        // å½•åˆ¶ä¸€ç³»åˆ—æ“ä½œï¼ˆè¿™äº›ä¸ä¼šçœŸæ­£æ‰§è¡Œï¼‰
        for (int i = 0; i < num_iterations; i++) {
            // å¤šä¸ªè¿ç»­çš„GEMM
            gemm_kernel<<<grid, block, 0, stream>>>(...);
        }
      
        // ç»“æŸæ•è·
        cudaGraph_t graph;
        cudaStreamEndCapture(stream, &graph);
      
        // å®ä¾‹åŒ–ï¼ˆç¼–è¯‘ä¼˜åŒ–ï¼‰
        cudaGraphExec_t exec;
        cudaGraphInstantiate(&exec, graph, nullptr, nullptr, 0);
      
        // ç°åœ¨å¯ä»¥å¤šæ¬¡å¯åŠ¨è¿™ä¸ªGraph
        for (int run = 0; run < 1000; run++) {
            cudaGraphLaunch(exec, stream);  // æä½çš„å¯åŠ¨å¼€é”€!
        }
      
        cudaStreamSynchronize(stream);
      
        // æ¸…ç†
        cudaGraphExecDestroy(exec);
        cudaGraphDestroy(graph);
    }
};
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CUDA Graph æ‰§è¡Œå¯¹æ¯”                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   ã€ä¼ ç»Ÿkernelå¯åŠ¨ã€‘                                                             â”‚
â”‚                                                                                 â”‚
â”‚   CPU:  â”Œâ”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â”                               â”‚
â”‚         â”‚L1â”‚ â”‚L2â”‚ â”‚L3â”‚ â”‚L4â”‚ â”‚L5â”‚ â”‚L6â”‚ â”‚L7â”‚ â”‚L8â”‚  L = Launch overhead          â”‚
â”‚         â””â”¬â”€â”˜ â””â”¬â”€â”˜ â””â”¬â”€â”˜ â””â”¬â”€â”˜ â””â”¬â”€â”˜ â””â”¬â”€â”˜ â””â”¬â”€â”˜ â””â”¬â”€â”˜                               â”‚
â”‚          â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚                                  â”‚
â”‚   GPU:   â–¼    â–¼    â–¼    â–¼    â–¼    â–¼    â–¼    â–¼                                  â”‚
â”‚         â”ŒK1â” â”ŒK2â” â”ŒK3â” â”ŒK4â” â”ŒK5â” â”ŒK6â” â”ŒK7â” â”ŒK8â”                               â”‚
â”‚         â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”˜                               â”‚
â”‚                                                                                 â”‚
â”‚         â–²æ¯æ¬¡å¯åŠ¨éƒ½æœ‰å¼€é”€                                                        â”‚
â”‚                                                                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                                 â”‚
â”‚   ã€CUDA Graphå¯åŠ¨ã€‘                                                             â”‚
â”‚                                                                                 â”‚
â”‚   CPU:  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚         â”‚              Graph Launch (ä¸€æ¬¡æ€§)                                 â”‚  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                       â”‚                                        â”‚
â”‚   GPU:                                â–¼                                        â”‚
â”‚         â”ŒK1â”¬K2â”¬K3â”¬K4â”¬K5â”¬K6â”¬K7â”¬K8â”                                             â”‚
â”‚         â”‚  é¢„ç¼–è¯‘çš„æ‰§è¡Œåºåˆ—ï¼Œæ— é—´éš™  â”‚                                          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                                 â”‚
â”‚         â–² å¯åŠ¨å¼€é”€è¢«æ‘Šé”€åˆ°æ•´ä¸ªGraph                                              â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. æ€§èƒ½è°ƒä¼˜å»ºè®®

### 7.1 å…³é”®å‚æ•°è°ƒä¼˜æŒ‡å—

| å‚æ•° | å½±å“ | è°ƒä¼˜å»ºè®® |
|------|------|----------|
| `BM, BN` | Shared Memoryç”¨é‡ï¼Œå¤ç”¨ç‡ | å°½é‡å¤§ï¼ˆå—é™äºsmemå®¹é‡ï¼‰ |
| `BK` | è¿­ä»£ç²’åº¦ï¼Œå¯„å­˜å™¨å‹åŠ› | 8-32ä¹‹é—´ï¼Œå¤ªå¤§å¯„å­˜å™¨ä¸å¤Ÿ |
| `TM, TN` | è®¡ç®—å¯†åº¦ï¼Œå¯„å­˜å™¨ç”¨é‡ | 8Ã—8æ˜¯å¸¸è§é€‰æ‹©ï¼Œæœ€å¤§åŒ–å¯„å­˜å™¨åˆ©ç”¨ |
| `NUM_STAGES` | æµæ°´çº¿æ·±åº¦ | 2-4ï¼Œæ›´å¤šå¯æ©ç›–æ›´é•¿å»¶è¿Ÿ |

### 7.2 æ€§èƒ½åˆ†æ Checklist

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â˜ 1. å ç”¨ç‡ (Occupancy)                                                        â”‚
â”‚     â€¢ ä½¿ç”¨ NVIDIA Nsight Compute åˆ†æ                                           â”‚
â”‚     â€¢ ç›®æ ‡: >50% ç†è®ºå ç”¨ç‡                                                      â”‚
â”‚     â€¢ è°ƒæ•´: Blockå¤§å°ã€å¯„å­˜å™¨ç”¨é‡                                                 â”‚
â”‚                                                                                 â”‚
â”‚  â˜ 2. å†…å­˜å¸¦å®½åˆ©ç”¨ç‡                                                              â”‚
â”‚     â€¢ å…¨å±€å†…å­˜: å‘é‡åŒ–åŠ è½½ (float4)                                               â”‚
â”‚     â€¢ å…±äº«å†…å­˜: é¿å…bankå†²çª (padding)                                            â”‚
â”‚     â€¢ ç›®æ ‡: >80% ç†è®ºå¸¦å®½                                                        â”‚
â”‚                                                                                 â”‚
â”‚  â˜ 3. è®¡ç®—æ•ˆç‡                                                                   â”‚
â”‚     â€¢ FMAåˆ©ç”¨ç‡                                                                  â”‚
â”‚     â€¢ å¯„å­˜å™¨å¤ç”¨                                                                  â”‚
â”‚     â€¢ ç›®æ ‡: æ¥è¿‘ç†è®ºTFLOPS                                                       â”‚
â”‚                                                                                 â”‚
â”‚  â˜ 4. å»¶è¿Ÿéšè—                                                                   â”‚
â”‚     â€¢ åŒç¼“å†²/å¤šé˜¶æ®µæµæ°´                                                           â”‚
â”‚     â€¢ cp.async å¼‚æ­¥æ‹·è´                                                          â”‚
â”‚     â€¢ æ£€æŸ¥: è®¡ç®—ä¸è®¿å­˜overlapç¨‹åº¦                                                 â”‚
â”‚                                                                                 â”‚
â”‚  â˜ 5. åŒæ­¥å¼€é”€                                                                   â”‚
â”‚     â€¢ __syncthreads() æ•°é‡                                                       â”‚
â”‚     â€¢ æ¯ä¸ªsyncçš„å¿…è¦æ€§                                                            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 ä¸ä¸“ä¸šåº“çš„å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ‰‹å†™Kernel vs ä¸“ä¸šåº“                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   æœ¬æ•™ç¨‹å®ç°            cuBLAS              CUTLASS                             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚   æ•™å­¦ç›®çš„              ç”Ÿäº§ç¯å¢ƒé¦–é€‰         å¯å®šåˆ¶é«˜æ€§èƒ½                          â”‚
â”‚   ~20-50% ç†è®ºæ€§èƒ½      ~90-95%ç†è®ºæ€§èƒ½     ~85-95%ç†è®ºæ€§èƒ½                       â”‚
â”‚   ç®€å•æ˜“æ‡‚              é»‘ç›’åº“               æ¨¡æ¿åº“                               â”‚
â”‚   æ— Tensor Core         å…¨é¢ä¼˜åŒ–            Tensor Coreæ”¯æŒ                      â”‚
â”‚                                                                                 â”‚
â”‚   å»ºè®®:                                                                          â”‚
â”‚   â€¢ å­¦ä¹ é˜¶æ®µ: ä½¿ç”¨æœ¬æ•™ç¨‹ç†è§£åŸç†                                                  â”‚
â”‚   â€¢ ç”Ÿäº§ç¯å¢ƒ: ä½¿ç”¨ cuBLAS / CUTLASS                                             â”‚
â”‚   â€¢ é«˜çº§ä¼˜åŒ–: åœ¨CUTLASSåŸºç¡€ä¸Šå®šåˆ¶                                                â”‚
â”‚                                                                                 â”‚
â”‚   cuBLAS ä½¿ç”¨ç¤ºä¾‹:                                                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚   cublasHandle_t handle;                                                        â”‚
â”‚   cublasCreate(&handle);                                                        â”‚
â”‚   cublasSgemm(handle, CUBLAS_OP_N, CUBLAS_OP_N,                                 â”‚
â”‚               N, M, K,                                                          â”‚
â”‚               &alpha, d_B, N, d_A, K,                                           â”‚
â”‚               &beta, d_C, N);                                                   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ€»ç»“

### æœ¬æ•™ç¨‹æ¶µç›–çš„æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          é«˜æ€§èƒ½CUDAç¼–ç¨‹æ ¸å¿ƒæ€æƒ³                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚    â”‚    1. å»¶è¿Ÿæ©ç›–        â”‚                                                    â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                                                    â”‚
â”‚    â”‚  â€¢ åŒç¼“å†² PingPong    â”‚                                                    â”‚
â”‚    â”‚  â€¢ å¼‚æ­¥æŒ‡ä»¤ cp.async  â”‚                                                    â”‚
â”‚    â”‚  â€¢ æ·±åº¦æµæ°´çº¿         â”‚                                                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚               â”‚                                                                 â”‚
â”‚               â–¼                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚   2. å¸¦å®½åˆ©ç”¨         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    3. å­˜å‚¨å±‚æ¬¡ç®¡ç†    â”‚                   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                   â”‚
â”‚    â”‚  â€¢ åˆå¹¶è®¿é—®           â”‚         â”‚  â€¢ Global â†’ Shared   â”‚                   â”‚
â”‚    â”‚  â€¢ å‘é‡åŒ–åŠ è½½         â”‚         â”‚  â€¢ Shared â†’ Register â”‚                   â”‚
â”‚    â”‚  â€¢ Bankå†²çªè§„é¿       â”‚         â”‚  â€¢ æ•°æ®å¤ç”¨æœ€å¤§åŒ–     â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                â”‚                               â”‚
â”‚                                                â–¼                               â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚   4. åŒæ­¥ç­–ç•¥         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”‚   5. CPU-GPUåä½œ      â”‚                   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                   â”‚
â”‚    â”‚  â€¢ æœ€å°åŒ–åŒæ­¥ç‚¹       â”‚         â”‚  â€¢ CUDA Stream       â”‚                   â”‚
â”‚    â”‚  â€¢ æ­£ç¡®ä¿è¯ä¸€è‡´æ€§     â”‚         â”‚  â€¢ CUDA Graph        â”‚                   â”‚
â”‚    â”‚  â€¢ é¿å…è¿‡åº¦åŒæ­¥       â”‚         â”‚  â€¢ æœ€å°åŒ–round-trip   â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼–è¯‘å’Œè¿è¡Œ

```bash
# ç¼–è¯‘ (é’ˆå¯¹ Ampere æ¶æ„, SM80)
nvcc -arch=sm_80 -O3 -lineinfo pingpong_gemm.cu -o pingpong_gemm

# è¿è¡Œé»˜è®¤å°ºå¯¸
./pingpong_gemm

# è‡ªå®šä¹‰çŸ©é˜µå°ºå¯¸
./pingpong_gemm 2048 2048 2048

# ä½¿ç”¨ Nsight Compute åˆ†ææ€§èƒ½
ncu --set full ./pingpong_gemm 1024 1024 1024
```

---

> ğŸ’¡ **è¿›é˜¶å­¦ä¹ è·¯å¾„**:
> 1. æœ¬æ•™ç¨‹ â†’ ç†è§£åŸºæœ¬åŸç†
> 2. CUTLASS æºç  â†’ å­¦ä¹ å·¥ä¸šçº§å®ç°
> 3. Tensor Core GEMM â†’ ä¸‹ä¸€ä»£ç¡¬ä»¶ç‰¹æ€§
> 4. Flash Attention ç­‰å˜ä½“ â†’ åº”ç”¨åˆ°å®é™…åœºæ™¯