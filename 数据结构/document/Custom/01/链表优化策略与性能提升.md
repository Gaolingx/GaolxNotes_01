# é“¾è¡¨ä¼˜åŒ–ç­–ç•¥ä¸æ€§èƒ½æå‡

### ğŸ§‘â€ğŸ’» User

å¦‚ä½•ä¼˜åŒ–é“¾è¡¨çš„æ•°æ®ç»“æ„ï¼ˆå¦‚å‡å°‘tlb missï¼Œllc missç­‰ï¼‰ï¼Œæé«˜æ“ä½œæ€§èƒ½ï¼ˆéå†ï¼Œå¢åˆ ç­‰ï¼‰ï¼Ÿ

---

### ğŸ¤– Assistant

ä¼˜åŒ–é“¾è¡¨æ•°æ®ç»“æ„ä»¥å‡å°‘TLB missã€LLC misså¹¶æé«˜æ“ä½œæ€§èƒ½ï¼ˆéå†ã€å¢åˆ ç­‰ï¼‰ï¼Œéœ€ä»**å†…å­˜å±€éƒ¨æ€§**ã€**ç¼“å­˜å‹å¥½è®¾è®¡**å’Œ**ç¡¬ä»¶ç‰¹æ€§åˆ©ç”¨**å…¥æ‰‹ã€‚ä»¥ä¸‹æ˜¯å…³é”®ä¼˜åŒ–ç­–ç•¥åŠç¤ºä¾‹ï¼š

---

### **1. å†…å­˜å¸ƒå±€ä¼˜åŒ–ï¼šæå‡ç©ºé—´å±€éƒ¨æ€§**
- **å†…å­˜æ± ï¼ˆMemory Poolï¼‰**  
  é¢„åˆ†é…è¿ç»­å†…å­˜å—å­˜å‚¨èŠ‚ç‚¹ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚  
  **ç¤ºä¾‹**ï¼š
  ```c
  #define POOL_SIZE 1000
  typedef struct Node { int data; struct Node* next; } Node;
  Node pool[POOL_SIZE];  // è¿ç»­å†…å­˜å—
  int free_index = 0;

  Node* create_node(int data) {
      if (free_index >= POOL_SIZE) return NULL;
      Node* node = &pool[free_index++];
      node->data = data;
      node->next = NULL;
      return node;
  }
  ```
  **ä¼˜ç‚¹**ï¼šèŠ‚ç‚¹ç‰©ç†ç›¸é‚»ï¼Œéå†æ—¶å‡å°‘Cache LineåŠ è½½æ¬¡æ•°ã€‚

- **ç´§å‡‘èŠ‚ç‚¹ç»“æ„**  
  å‡å°‘èŠ‚ç‚¹å¤§å°ï¼ˆå¦‚ç”¨32ä½åç§»æ›¿ä»£64ä½æŒ‡é’ˆï¼‰ï¼Œä½¿æ›´å¤šèŠ‚ç‚¹è£…å…¥ç¼“å­˜è¡Œã€‚
  ```c
  // åœ¨è¿ç»­å†…å­˜æ± ä¸­ï¼Œç”¨ç›¸å¯¹åç§»ä»£æ›¿ç»å¯¹æŒ‡é’ˆ
  typedef int32_t Ref;
  typedef struct CompactNode {
      int data;
      Ref next;  // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åç§»é‡
  } CompactNode;
  ```

---

### **2. æ•°æ®ç»“æ„æ”¹è¿›ï¼šå‡å°‘æŒ‡é’ˆè·³è½¬**
- **å—çŠ¶é“¾è¡¨ï¼ˆUnrolled Linked Listï¼‰**  
  æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨å°æ•°ç»„ï¼Œå‡å°‘æŒ‡é’ˆè¿½è¸ªæ¬¡æ•°ã€‚  
  **ç¤ºä¾‹**ï¼š
  ```c
  #define BLOCK_SIZE 16
  typedef struct Block {
      int data[BLOCK_SIZE];
      int count;
      struct Block* next;
  } Block;
  ```
  **ä¼˜ç‚¹**ï¼šéå†æ—¶æ¯ä¸ªBlockå†…æ•°æ®è¿ç»­è®¿é—®ï¼Œæ˜¾è‘—é™ä½LLC missã€‚

- **B+æ ‘é£æ ¼é“¾è¡¨**  
  å¤šå±‚é“¾è¡¨ç»“æ„ï¼ˆå¦‚è·³è¡¨Skip Listï¼‰ï¼Œç”¨ç´¢å¼•å—åŠ é€Ÿéå†ï¼Œä½†éœ€æƒè¡¡æ’å…¥å¤æ‚åº¦ã€‚

---

### **3. ç¼“å­˜ä¸TLBä¼˜åŒ–**
- **é¢„å–ï¼ˆPrefetchingï¼‰**  
  æå‰åŠ è½½ä¸‹å‡ ä¸ªèŠ‚ç‚¹åˆ°ç¼“å­˜ï¼Œéšè—å†…å­˜å»¶è¿Ÿã€‚  
  **ç¤ºä¾‹**ï¼š
  ```c
  void traverse(Node* head) {
      Node* curr = head;
      while (curr) {
          // é¢„å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
          if (curr->next) 
              __builtin_prefetch(curr->next, 0, 1); // è¯»æ“ä½œï¼Œä½æ—¶é—´å±€éƒ¨æ€§
          process(curr->data);
          curr = curr->next;
      }
  }
  ```

- **å¯¹é½ä¸å¡«å……**  
  å°†èŠ‚ç‚¹å¤§å°å¯¹é½è‡³ç¼“å­˜è¡Œï¼ˆé€šå¸¸64å­—èŠ‚ï¼‰ï¼Œé¿å…ä¼ªå…±äº«ï¼ˆFalse Sharingï¼‰ã€‚  
  **ç¤ºä¾‹**ï¼š
  ```c
  typedef struct Node {
      int data;
      char padding[60];       // å¡«å……è‡³64å­—èŠ‚
      struct Node* next;
  } __attribute__((aligned(64))) Node;
  ```

- **å¤§é¡µï¼ˆHuge Pagesï¼‰**  
  ä½¿ç”¨2MBå¤§é¡µå‡å°‘TLBæ¡ç›®å‹åŠ›ï¼ˆéœ€OSæ”¯æŒï¼‰ã€‚

---

### **4. ç®—æ³•çº§ä¼˜åŒ–**
- **æ‰¹å¤„ç†æ“ä½œ**  
  æ‰¹é‡æ’å…¥/åˆ é™¤æ—¶ï¼Œå…ˆç¼“å­˜æ“ä½œå†åº”ç”¨ï¼Œå‡å°‘éšæœºè®¿é—®ã€‚
  ```c
  void batch_insert(Node** head, int* values, int n) {
      sort(values, n);        // æŒ‰å†…å­˜åœ°å€æ’åº
      for (int i = 0; i < n; i++) 
          insert_sorted(head, values[i]); // æœ‰åºæ’å…¥æå‡å±€éƒ¨æ€§
  }
  ```

- **çƒ­èŠ‚ç‚¹åˆ†ç¦»**  
  é«˜é¢‘è®¿é—®èŠ‚ç‚¹ï¼ˆHot Nodesï¼‰é›†ä¸­å­˜å‚¨ï¼Œå†·èŠ‚ç‚¹ï¼ˆCold Nodesï¼‰å¦å­˜ã€‚

---

### **5. ç¡¬ä»¶æ„ŸçŸ¥è®¾è®¡**
- **NUMAä¼˜åŒ–**  
  å¤šæ ¸ç³»ç»Ÿä¸‹ï¼ŒèŠ‚ç‚¹åˆ†é…åœ¨è®¿é—®çº¿ç¨‹çš„æœ¬åœ°å†…å­˜åŸŸã€‚
- **RDMAï¼ˆå¯é€‰ï¼‰**  
  åˆ†å¸ƒå¼åœºæ™¯ä¸­ï¼Œç”¨RDMAç»•è¿‡CPUç›´æ¥è®¿é—®è¿œç¨‹å†…å­˜ã€‚

---

### **æ€§èƒ½å¯¹æ¯”ï¼ˆä¼˜åŒ– vs ä¼ ç»Ÿé“¾è¡¨ï¼‰**
| **æŒ‡æ ‡**       | ä¼ ç»Ÿé“¾è¡¨          | ä¼˜åŒ–å               |
|----------------|------------------|---------------------|
| **éå†é€Ÿåº¦**   | æ…¢ï¼ˆéšæœºè®¿é—®ï¼‰     | å¿«ï¼ˆè¿ç»­/å—è®¿é—®ï¼‰     |
| **LLC Miss**   | é«˜               | é™ä½50%+            |
| **TLB Miss**   | é«˜               | é€šè¿‡å¤§é¡µæ˜¾è‘—å‡å°‘     |
| **æ’å…¥/åˆ é™¤**  | O(1)ä½†ç¼“å­˜ä¸å‹å¥½  | æ‰¹é‡æ“ä½œæ›´é«˜æ•ˆ       |

---

### **é€‰æ‹©ç­–ç•¥**
- **è¯»å¤šå†™å°‘** â†’ å—çŠ¶é“¾è¡¨ + é¢„å–  
- **é«˜é¢‘å¢åˆ ** â†’ å†…å­˜æ±  + æ‰¹å¤„ç†  
- **å·¨å‹é“¾è¡¨** â†’ å¤§é¡µ + NUMAæ„ŸçŸ¥åˆ†é…  

é€šè¿‡ç»“åˆä¸Šè¿°ç­–ç•¥ï¼Œå¯æ˜¾è‘—æå‡é“¾è¡¨æ€§èƒ½ã€‚å®é™…æ•ˆæœéœ€é€šè¿‡`perf`å·¥å…·éªŒè¯ï¼ˆ`perf stat -e cache-misses,tlb-misses`ï¼‰ã€‚