## 排序操作符

在 MongoDB 中，聚合操作符 `$sort` 用于对查询结果进行排序。它允许你按照指定的字段对文档进行升序或降序排序。排序操作是聚合管道（aggregation pipeline）中的一个常见阶段，可以帮助你精确控制输出数据的顺序。

### **语法**

在聚合管道中使用 `$sort` 时，可以按一个或多个字段进行排序。排序是通过指定一个或多个键来实现，值为 1 表示升序，-1 表示降序。

```javascript
{
  $sort: {
    field1: 1, // 升序排序
    field2: -1  // 降序排序
    ...
  }
}
```

### **$sort 的详细说明**

- **升序排序（1）**: 1 表示升序排列，意味着从小到大排序。
- **降序排序（-1）**: -1 表示降序排列，意味着从大到小排序。

如果你在 `$sort` 中使用多个字段，MongoDB 会按顺序对字段进行排序，首先按第一个字段排序，如果第一个字段的值相同，则按第二个字段排序，以此类推。

## **例子**

### 准备数据

假设我们有一个名为 `students` 的集合，文档结构如下：

```javascript
db.students.insertMany([{
  "_id": 1,
  "name": "张三",
  "age": 25,
  "class": 1,
  "score": 85
},
{
  "_id": 2,
  "name": "李四",
  "age": 23,
  "class": 1,
  "score": 92
},
{
  "_id": 3,
  "name": "王五",
  "age": 22,
  "class": 2,
  "score": 88
}])
```

#### **按单个字段排序**

如果我们希望按 `age` 字段进行升序排序，可以使用如下的聚合管道：

```javascript
db.students.aggregate([
  { 
    $sort: { age: 1 }
  }
])
```

结果:

```javascript
{
  "_id": 3,
  "name": "王五",
  "age": 22,
  "class": 2,
  "score": 88
},
{
  "_id": 2,
  "name": "李四",
  "age": 23,
  "class": 1,
  "score": 92
},
{
  "_id": 1,
  "name": "张三",
  "age": 25,
  "class": 1,
  "score": 85
}
```

这个例子按年龄从小到大对文档进行了排序。

###  **按多个字段排序**

假设我们需要根据 `score`（成绩）降序排序，如果 `score` 相同，再根据 `age`（年龄）升序排序：

```javascript
db.students.aggregate([
  { 
    $sort: { score: -1, age: 1 }
  }
])
```

结果:

```javascript
{
  "_id": 2,
  "name": "李四",
  "age": 23,
  "class": 1,
  "score": 92
},
{
  "_id": 3,
  "name": "王五",
  "age": 22,
  "class": 2,
  "score": 88
},
{
  "_id": 1,
  "name": "张三",
  "age": 25,
  "class": 1,
  "score": 85
}
```

在这个例子中，首先按成绩从高到低排序，然后对于成绩相同的文档，按年龄从小到大排序。

### **结合其他聚合操作**

`$sort` 还可以与其他聚合操作符结合使用。例如，假设我们想要计算每个班级学生的平均分数，并按平均分数排序：

```javascript
db.students.aggregate([
  { 
    $group: {
      _id: "$class",      // 按班级分组
      avgScore: { $avg: "$score" }
    }
  },
  { 
    $sort: { avgScore: -1 }  // 按平均分降序排序
  }
])
```

## 注意事项

1. **排序性能**: 在大量数据集上使用 `$sort` 时，如果没有索引支持，性能可能会受到影响。通常，MongoDB 会尝试使用已有的索引来优化排序操作，特别是在排序字段上建立索引时，可以显著提高查询效率。
    
2. **内存限制**: MongoDB 聚合操作的默认内存限制为 100MB。如果你的 `$sort` 操作需要更多内存，且数据量较大，可能会遇到错误。在这种情况下，可以使用 `allowDiskUse: true` 选项来启用磁盘空间，允许 MongoDB 将排序操作写入磁盘，从而避免内存溢出：

```javascript
db.students.aggregate([
  { 
    $sort: { score: -1 }
  }
], { allowDiskUse: true })
```

## **总结**

- `$sort` 操作符用于按照指定字段对聚合查询结果进行排序。
- 可以按一个或多个字段排序，支持升序（1）和降序（-1）两种方式。
- 排序时，如果字段值相同，可以继续按其他字段排序。
- 使用 `$sort` 时，需要注意可能出现的性能问题，特别是在没有索引时，操作可能会非常耗时。

