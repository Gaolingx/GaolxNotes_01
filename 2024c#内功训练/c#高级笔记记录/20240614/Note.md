# C#高级编程之——反射（一）基本概念介绍

## 一、什么是反射，反射有什么用，它能干什么？

Reflection，中文翻译为反射，这是.Net中获取运行时类型信息的方式。作为c#高级特性之一，在很多领域都有反射的身影，比如Ioc容器、Json/XML反序列化、ORM框架(EFCore)、ABP框架等，可以说，如果你接触c#高级开发或者想成为一名架构师，反射是一个必须掌握的特性。比如说，我们可以用反射去研究一些黑盒，尝试访问些引擎/SDK等dll没有公开暴露的属性，做黑箱测试。
反射获取的字段、属性、方法 如一个万能钥匙，可以用它操控所有的类型实例。C#泛型 反射都是元编程的能力

</br>

- 官方概念：反射指**程序可以访问、检测和修改它本身（例如元数据）状态或行为的一种能力**。.Net的应用程序结构分为应用程序域(AppDomain)—程序集(Assembly)—模块(Module)—类型(class)—成员(member)几个层次，公共语言运行库(CLR)加载器管理应用程序域，这种管理包括将每个程序集加载到相应的应用程序域以及控制每个程序集中类型层次结构的内存布局。程序集包含模块，而模块包含类型，类型又包含成员（这些信息都是可以运通过反射获取的）。反射则提供了封装程序集、模块和类型的对象。您可以使用反射动态地创建类型的实例，将类型绑定到现有对象，或从现有对象中获取类型、命名空间。然后，可以调用类型的方法或访问其字段和属性。（除了私有构造方法，包括private成员/方法，我们都是可以通过反射查看/调用的。）
- 一句话总结：反射可以看清类/对象的所有信息（知道你是谁、继承了谁，引用了谁等等），我们可以通过反射，在运行时获得.NET中每一个类型（包括类、结构、委托、接口和枚举等）的成员，包括方法、属性、事件，以及构造函数等，还可以获得每个成员的名称、限定符和参数等，类似照妖镜。

- 反射的功能：

1. 查看和遍历类型(及其成员)的基本信息和程序集元数据(metadata)
2. 可以使用反射动态地创建类型的实例，将类型绑定到现有对象，或从现 有对象中获取类型
3. 应用程序需要在运行时从某个特定的程序集中载入一个特定的类型，以便实现某个任务时可以用到反射。
4. 反射主要应用与类库，这些类库需要知道一个类型的定义，以便提供更多的功能。框架（Spring .net/ .Net MVC等）
5. 破坏单例模式 反射可以突破访问限制，直接调用私有构造函数
6. 依赖注入（DI）
7. 序列化

</br>

## 二、程序集、模块和类型概念及关系

2.1 程序集（Assembly）：
先来看看官方概念：程序集构成了 .NET 应用程序的部署、版本控制、重用、激活范围和安全权限的基本单元。 emmm...这说了跟没说一样，简单来说，程序集就像一个文件夹或包裹，**程序集包含了应用程序所需的所有类型（如类、接口等）和资源**，程序集可以包含一个或多个模块。

程序集长啥样呢，通常在文件夹看到的可执行文件（.exe文件）和 类库文件（.dll文件）便是，vs里面一个解决方案可以包含多个项目，而每个项目就是一个程序集，如图所示：
  
程序集包含一个清单，这是一个元数据部分，它描述了程序集的名称、版本、发布者、引用的类型等信息。这个清单使得.NET运行时（CLR）能够确定如何加载和使用程序集中的代码。即每个程序集都有一个版本号和一个清单，用于描述程序集的内容和依赖关系，如图所示：

其中核心元素包括：

1. 类型：程序集中定义的所有类型。
2. 清单文件：包含程序集元数据的信息，例如名称、版本、依赖项等。
3. 资源：程序集中使用的资源，例如图像、声音、文本等。程序集通常对应一个物理文件，例如 EXE 或 DLL 文件。程序集可以显式或隐式地加载到应用程序中。显式加载程序集使用 Assembly.Load() 方法，隐式加载程序集通常发生在应用程序引用其他程序集时。

当然了，我们也可以使用反射，以编程方式获取程序集的相关信息，这也是我们这章要重点研究的。

</br>

2.2 模块（Module）：
模块是程序集中的逻辑单元，它通常对应一个 .cs 源文件。作为构成.NET应用程序的基本单元之一，模块包含以下元素：

1. 类型：模块中定义的所有类型。
2. 中间代码 (IL)：由编译器生成的机器码表示的类型实现。
3. 元数据：有关类型的信息，例如名称、属性、方法等。

模块通常是程序集的一部分，但也可以单独编译和加载。例如，一些库可能会提供多个模块，每个模块包含不同的功能。

</br>

2.3 元数据（Metadata）：

- 元数据是关于数据的数据，或者说是用来描述数据的数据。在C#中，元数据具体指的是描述代码元素（如类、方法、属性、字段等）的信息。
- 我们已经知道反射允许你在运行时获取关于类型的信息，如类的名称、成员（字段、属性、方法、事件等）、基类和实现的接口等。而这些信息就存储在元数据中，但反射提供了API来查询和使用这些元数据，元数据包括methodInfo，TypeInfo，interface，baseClass，attribute等。

How to Understand?

这听起来似乎很抽象对吧，但你可以理解成一个拼图游戏，除了构成拼图的各个块，我们还需要一张图纸，指导我们如何去拼成图纸中的样子。
这个过程中，拼图块就相当于c#中的Behavior，解释器解释他们执行相应的功能，而图纸则相当于元数据，C#中类型的定义、成员（方法、字段、属性等）的描述。通过这张蓝图，我们知道这张拼图的整体结构和每个部分的具体细节。

元数据通常包含以下信息：

1. 程序集信息：包括程序集的名称、版本号、文化信息（区域性）、公钥等，这些信息用于唯一标识程序集。
2. 类型信息：描述程序中定义的类型（如类、接口、结构体等）的信息，包括类型的名称、可见性、基类、实现的接口等。
3. 成员信息：描述类型成员（如方法、字段、属性、事件等）的信息，包括成员的名称、类型、访问级别、参数列表等。
4. 属性信息：这里的“属性”指的是元数据中的属性，用于描述代码元素的额外信息，如自定义属性（Attributes），它们为代码元素提供元数据级别的声明性信息。
5. 关系信息：描述代码元素之间关系的信息，如类的继承关系、接口的实现关系等。

2.4 类型（Type）：
类型是程序集或模块中定义的代码结构，它代表一种实体或行为。类型包含以下元素：

1. 字段：存储数据的成员变量。
2. 属性：提供对字段的封装访问。
3. 方法：实现功能的代码块。
4. 事件：用于通知应用程序中其他部分的事件。
5. 构造函数：用于创建类型实例的代码块。

一句话总结：类型是面向对象编程的核心概念。它们用于表示应用程序中的对象和行为。

## 三、程序集、模块和类型的关系

- 程序集 可以包含多个模块。
- 模块 可以包含多个类型。
- 类型 只能属于一个模块。

他们的关系可以如下图所示：

总结：

- Assembly类可以获得正在运行的装配件信息，也可以动态的加载装配件，以及在装配件中查找类型信息，并且创建该类型的实例。Type类可以获得对象的类型信息，此信息包含对象的所有要素：方法、构造器、属性、字段等等，通过Type类可以得到这些要素的信息，并且调用。除此之外，还有列如FieldInfo、EventInfo等等，这些类都包含在System.Reflection命名空间下。

- 程序集、模块和类型是 C# 中构成 .NET 应用程序的基本单元。它们之间具有层次关系，程序集包含模块，模块包含类型。每个单元都包含特定的元素和功能，共同构成了完整的应用程序。
