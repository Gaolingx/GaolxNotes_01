# Softmax vs sigmoid MoE

### ğŸ§‘â€ğŸ’» User

![](imgs/72c690bc-7e12-48a4-bdc0-a400a2f78c74.png)
![](imgs/f56db137-4906-41d3-a8bb-7b5e151fcc6b.png)

ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨é€‰å– top-K ä¸“å®¶æ—¶ï¼Œæˆ‘ä»¬ä¼šå¯¹ gating layer çš„è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨ softmax functionï¼Œä½†æ˜¯ï¼Œåœ¨ deepseek çš„ Loss-Free Balancing ä¸­ï¼Œä½œè€…é€šè¿‡å®éªŒå‘ç°ï¼Œä½¿ç”¨sigmoidä½œä¸ºæ¿€æ´»å‡½æ•°æ•ˆæœæ›´å¥½ï¼Œå®éªŒç»“æœæ˜¾ç¤ºï¼Œsigmoid function å¯¹äºè¶…å‚æ•°æ›´åŠ  robustï¼Œä¸”è¡¨ç°ä¹Ÿæ›´å¥½ä¸€äº›ã€‚ä¸¤è€…ä½œä¸ºmoe routerçš„activation functionæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæœ‰å“ªäº›moeæ¨¡å‹åˆ†åˆ«ä½¿ç”¨softmax or sigmoidï¼Ÿ

---

### ğŸ¤– Assistant

ä½ çš„é—®é¢˜å¯ä»¥æ‹†æˆä¸‰ä¸ªå±‚æ¬¡æ¥çœ‹ï¼š**ï¼ˆ1ï¼‰softmax vs sigmoid ä½œä¸º MoE router æ¿€æ´»åœ¨â€œæ•°å­¦ä¸ä¼˜åŒ–å±‚é¢â€çš„æ ¹æœ¬å·®å¼‚ï¼›ï¼ˆ2ï¼‰è¿™ç§å·®å¼‚ä¸ºä»€ä¹ˆä¼šç›´æ¥å½±å“ load balance / è¶…å‚æ•°æ•æ„Ÿæ€§ï¼›ï¼ˆ3ï¼‰ä¸»æµ MoE æ¨¡å‹åœ¨å·¥ç¨‹ä¸Šå„è‡ªçš„é€‰æ‹©ä¸å–èˆã€‚**
ä¸‹é¢æˆ‘æŒ‰è¿™ä¸ªé€»è¾‘ç³»ç»Ÿæ€§å›ç­”ã€‚

---

## 1. softmax vs sigmoidï¼šè·¯ç”±å»ºæ¨¡å‡è®¾çš„æ ¹æœ¬ä¸åŒ

### 1.1 softmaxï¼š**â€œå•åˆ†å¸ƒ + ç«äº‰å¼åˆ†é…â€**

[
G(x) = \text{softmax}(W_g x + b),\quad \sum_i G_i(x)=1
]

softmax router éšå«çš„å»ºæ¨¡å‡è®¾æ˜¯ï¼š

> **æ‰€æœ‰ä¸“å®¶åœ¨åŒä¸€ä¸ªæ¦‚ç‡ simplex ä¸­ç«äº‰ token çš„è§£é‡Šæƒ**

å…¶æ ¸å¿ƒç‰¹å¾ï¼š

* **å¼ºè€¦åˆï¼ˆcoupledï¼‰**
  ä»»æ„ä¸€ä¸ª expert çš„ logit å˜åŒ–ï¼Œéƒ½ä¼šå½±å“æ‰€æœ‰å…¶ä»– expert çš„åˆ†é…æ¦‚ç‡ã€‚
* **ç›¸å¯¹æ’åºé©±åŠ¨**
  åªå…³å¿ƒâ€œè°æ›´å¤§â€ï¼Œè€Œä¸å…³å¿ƒç»å¯¹å°ºåº¦ã€‚
* **å½’ä¸€åŒ–çº¦æŸ**
  token çš„â€œä¸“å®¶è´¨é‡â€è¢«å¼ºåˆ¶å‹ç¼©ä¸ºæ€»å’Œ 1 çš„åˆ†å¸ƒã€‚

è¿™åœ¨ç†è®ºä¸Šéå¸¸ä¼˜é›…ï¼Œä½†åœ¨ MoE åœºæ™¯ä¸­ä¼šå¸¦æ¥å‡ ä¸ªåæœï¼š

* è·¯ç”±é€€åŒ–åˆ° **winner-takes-most**
* ææ˜“å‡ºç° **expert collapse / routing imbalance**
* load balance å¯¹ temperatureã€aux loss æƒé‡æå…¶æ•æ„Ÿ

---

### 1.2 sigmoidï¼š**â€œç‹¬ç«‹ Bernoulli gate + éç«äº‰å¼é€‰æ‹©â€**

[
G(x) = \sigma(W_g x + b),\quad G_i(x)\in(0,1)
]

sigmoid router çš„éšå«å‡è®¾å®Œå…¨ä¸åŒï¼š

> **æ¯ä¸ª expert ç‹¬ç«‹åˆ¤æ–­â€œæˆ‘æ˜¯å¦é€‚åˆè¿™ä¸ª tokenâ€**

æ ¸å¿ƒå·®å¼‚ï¼š

* **è§£è€¦ï¼ˆdecoupledï¼‰**
  æ¯ä¸ª expert çš„ gate æ˜¯ç‹¬ç«‹ Bernoulli å˜é‡
* **ç»å¯¹å°ºåº¦æœ‰æ„ä¹‰**
  logit ç»å¯¹å¤§å°å†³å®šæ¿€æ´»æ¦‚ç‡
* **ä¸è¦æ±‚å½’ä¸€åŒ–**
  æ€» gate mass å¯ä»¥å˜åŒ–ï¼ˆç¨€ç–æ€§è‡ªç„¶å‡ºç°ï¼‰

è¿™åœ¨ MoE ä¸­éå¸¸é‡è¦ï¼š
**token-to-expert æ˜¯å¤šå¯¹å¤šçš„â€œåŒ¹é…é—®é¢˜â€ï¼Œè€Œä¸æ˜¯å•åˆ†å¸ƒåˆ†ç±»é—®é¢˜ã€‚**

---

## 2. ä¸ºä»€ä¹ˆ sigmoid åœ¨ DeepSeek çš„ Loss-Free Balancing ä¸­æ›´ç¨³ï¼Ÿ

ä½ æåˆ°çš„ **Loss-Free Balancing** æ˜¯å…³é”®ï¼Œè¿™é‡Œ sigmoid çš„ä¼˜åŠ¿æ˜¯â€œç»“æ„æ€§â€çš„ï¼Œè€Œä¸æ˜¯è°ƒå‚æŠ€å·§ã€‚

---

### 2.1 softmax çš„ä¸ç¨³å®šæ€§æ¥è‡ªâ€œå…¨å±€è€¦åˆæ¢¯åº¦â€

softmax çš„æ¢¯åº¦å½¢å¼ï¼ˆå¯¹ logit (z_i)ï¼‰ï¼š

[
\frac{\partial G_i}{\partial z_j} = G_i(\delta_{ij} - G_j)
]

æ„å‘³ç€ï¼š

* æå‡ä¸€ä¸ª expert â‡’ **å¿…ç„¶å‹åˆ¶å…¶ä»– expert**
* imbalance ä¼šå½¢æˆ **æ­£åé¦ˆå›è·¯**
* éœ€è¦ **æ˜¾å¼çš„ load balancing loss** æ¥æŠµæ¶ˆ

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç»å…¸ MoEï¼ˆGShard / Switch / GLaMï¼‰éƒ½éœ€è¦ï¼š

* importance loss
* load loss
* entropy regularization
* careful temperature tuning

---

### 2.2 sigmoid çš„æ¢¯åº¦æ˜¯â€œå±€éƒ¨ + å¯é¥±å’Œâ€çš„

sigmoid æ¢¯åº¦ï¼š

[
\frac{\partial G_i}{\partial z_i} = G_i(1 - G_i)
]

æ€§è´¨éå¸¸å…³é”®ï¼š

* **ä¸å½±å“å…¶ä»– expert**
* é«˜ç½®ä¿¡åº¦åè‡ªåŠ¨é¥±å’Œï¼ˆæ¢¯åº¦å˜å°ï¼‰
* è‡ªç„¶æŠ‘åˆ¶æç«¯ routing

è¿™æ„å‘³ç€ï¼š

* expert ä¸ä¼šé€šè¿‡â€œå‹åˆ¶åˆ«äººâ€æ¥è·å¾—æ›´å¤š token
* load åˆ†å¸ƒæ›´æ¥è¿‘ **Poisson-like ç‹¬ç«‹é‡‡æ ·**
* ä¸éœ€è¦é¢å¤– balancing loss ä¹Ÿèƒ½ç¨³å®š

ğŸ‘‰ **è¿™æ­£æ˜¯ DeepSeek èƒ½â€œLoss-Free Balancingâ€çš„æ ¹æœ¬åŸå› **

---

### 2.3 å¯¹è¶…å‚æ•°æ›´ robust çš„æœ¬è´¨åŸå› 

sigmoid çš„é²æ£’æ€§æ¥è‡ªä¸‰ç‚¹ï¼š

1. **æ—  temperature ä¾èµ–**

   * softmax æ¸©åº¦ = routing sharpness
   * sigmoid æœ¬èº«å·²æ˜¯ bounded gate
2. **top-K æ˜¯åå¤„ç†ï¼Œä¸å½±å“ gate å­¦ä¹ **

   * å…ˆå­¦â€œæ˜¯å¦é€‚åˆâ€
   * å†é€‰ K ä¸ªæœ€å¤§çš„
3. **æç«¯ logit ä¸ä¼šç ´åå…¨å±€åˆ†å¸ƒ**

   * ä¸ä¼šæŠŠæ‰€æœ‰ token å¸èµ°

---

## 3. Top-K è¡Œä¸ºï¼šsoftmax vs sigmoid çš„æœ¬è´¨å·®å¼‚

| ç»´åº¦           | softmax + top-K | sigmoid + top-K |
| ------------ | --------------- | --------------- |
| æ’åºä¾æ®         | ç›¸å¯¹å¤§å°            | ç»å¯¹ç½®ä¿¡åº¦           |
| K å˜åŒ–å½±å“       | æ”¹å˜æ¦‚ç‡åˆ†å¸ƒ          | åªæ”¹å˜æ¿€æ´»æ•°é‡         |
| expert ç«äº‰    | å¼º               | å¼±               |
| collapse é£é™©  | é«˜               | ä½               |
| balancing éœ€æ±‚ | æ˜¾å¼              | å¯éšå¼             |

ä¸€å¥è¯æ€»ç»“ï¼š

> **softmax æ˜¯â€œé€‰æœ€å¥½çš„ K ä¸ªâ€ï¼›sigmoid æ˜¯â€œæ‰€æœ‰è§‰å¾—è‡ªå·±è¡Œçš„ expert ä¸­é€‰ K ä¸ªæœ€è‡ªä¿¡çš„â€ã€‚**

---

## 4. å…¸å‹ MoE æ¨¡å‹çš„é€‰æ‹©å¯¹æ¯”

### 4.1 ä½¿ç”¨ softmax router çš„ä»£è¡¨

**ç¬¬ä¸€ä»£ / ç»å…¸ MoEï¼š**

* **GShard (Google)**
* **Switch Transformer**
* **GLaM**
* **PaLM-MoE**
* **Mixtralï¼ˆå˜ä½“ä»ç„¶æ˜¯ softmax + aux lossï¼‰**

ç‰¹å¾ï¼š

* å¼ºä¾èµ– load balancing loss
* å¯¹ temperature / loss æƒé‡éå¸¸æ•æ„Ÿ
* å·¥ç¨‹å¤æ‚åº¦é«˜ï¼Œä½†ç†è®ºæ¸…æ™°

---

### 4.2 ä½¿ç”¨ sigmoid / é softmax router çš„ä»£è¡¨

**æ–°ä¸€ä»£ / å·¥ç¨‹é©±åŠ¨ MoEï¼š**

* **DeepSeek-MoE / DeepSeek-V2/V3**

  * sigmoid + loss-free balancing
* **Qwen2-MoEï¼ˆåæœŸå®éªŒåˆ†æ”¯ï¼‰**
* **ä¸€äº› Routing-as-Matching / Independent Gate MoE**
* **éƒ¨åˆ†å¤šæ ‡ç­¾ / sparse activation MoEï¼ˆç ”ç©¶æ¨¡å‹ï¼‰**

è¶‹åŠ¿éå¸¸æ˜æ˜¾ï¼š

> **è¶Šå¤§çš„æ¨¡å‹ã€è¶Šé•¿çš„è®­ç»ƒã€è¶Šè¿½æ±‚ç¨³å®šæ€§ â†’ è¶Šå€¾å‘ sigmoid / ç‹¬ç«‹ gate**

---

## 5. æ›´æ·±ä¸€å±‚çš„ç†è§£ï¼ˆå…³é”®ç»“è®ºï¼‰

### 5.1 softmax router æœ¬è´¨ä¸Šåœ¨åšâ€œå•æ ‡ç­¾åˆ†ç±»â€

* token â†’ expert æ˜¯ mutually exclusive çš„å‡è®¾
* è¿™ä¸å®é™…è¯­ä¹‰ä¸åŒ¹é…ï¼ˆä¸€ä¸ª token å¯ä»¥é€‚åˆå¤šä¸ª expertï¼‰

### 5.2 sigmoid router æ›´åƒâ€œå¤šæ ‡ç­¾åŒ¹é… + ç¨€ç–æ¿€æ´»â€

* expert è¡¨è¾¾çš„æ˜¯èƒ½åŠ›å­ç©ºé—´
* token æ¿€æ´»çš„æ˜¯èƒ½åŠ›é›†åˆ

è¿™åœ¨ scale-up æ—¶æ˜æ˜¾æ›´åˆç†ã€‚

---

## 6. ä¸€å¥è¯æ€»ç»“

> **softmax router æŠŠ MoE å½“æˆâ€œç«äº‰åˆ†ç±»é—®é¢˜â€ï¼Œsigmoid router æŠŠ MoE å½“æˆâ€œç‹¬ç«‹åŒ¹é…é—®é¢˜â€ã€‚**
> åœ¨å¤§è§„æ¨¡è®­ç»ƒä¸‹ï¼Œåè€…å¤©ç„¶æ›´ç¨³å®šï¼Œä¹Ÿæ›´ç¬¦åˆ loss-free balancing çš„ç›®æ ‡ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è®¨è®ºï¼š
**sigmoid router + capacity constraint + dispatch kernel å®ç°ç»†èŠ‚**ï¼Œä»¥åŠå®ƒå¯¹ fused MoE kernelï¼ˆå¦‚ä½ ä¹‹å‰å…³å¿ƒçš„ up/gate èåˆï¼‰çš„å½±å“ã€‚
