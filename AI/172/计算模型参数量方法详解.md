# è®¡ç®—æ¨¡å‹å‚æ•°é‡æ–¹æ³•è¯¦è§£

### ğŸ§‘â€ğŸ’» User

å¦‚ä½•æ ¹æ®æ¨¡å‹metadataï¼Œæ ¹æ®å…¶ä¸­çš„çŸ©é˜µç»´åº¦ï¼Œè®¡ç®—æ¨¡å‹å‚æ•°é‡ï¼Ÿ

---

### ğŸ¤– Assistant

è¦æ ¹æ®æ¨¡å‹ metadata ä¸­çš„çŸ©é˜µç»´åº¦è®¡ç®—å‚æ•°é‡ï¼Œéœ€éå†æ‰€æœ‰å‚æ•°å¼ é‡å¹¶ç´¯åŠ å…¶å…ƒç´ æ€»æ•°ã€‚ä»¥ä¸‹æ˜¯å…·ä½“æ­¥éª¤å’Œä»£ç ç¤ºä¾‹ï¼š

### è®¡ç®—åŸç†
1. **å‚æ•°ç±»å‹**ï¼šæ¨¡å‹å‚æ•°ä¸»è¦åŒ…æ‹¬æƒé‡çŸ©é˜µï¼ˆWeightï¼‰å’Œåç½®å‘é‡ï¼ˆBiasï¼‰ã€‚
2. **å‚æ•°é‡è®¡ç®—**ï¼š
   - æƒé‡çŸ©é˜µï¼š`å‚æ•°é‡ = è¡Œæ•° Ã— åˆ—æ•°`ï¼ˆå…¨è¿æ¥å±‚ï¼‰æˆ– `è¾“å…¥é€šé“ Ã— è¾“å‡ºé€šé“ Ã— æ ¸é«˜ Ã— æ ¸å®½`ï¼ˆå·ç§¯å±‚ï¼‰ã€‚
   - åç½®å‘é‡ï¼š`å‚æ•°é‡ = è¾“å‡ºç»´åº¦`ï¼ˆå…¨è¿æ¥å±‚ï¼‰æˆ– `è¾“å‡ºé€šé“æ•°`ï¼ˆå·ç§¯å±‚ï¼‰ã€‚
3. **æ ¸å¿ƒæ“ä½œ**ï¼šå¯¹æ¯ä¸ªå‚æ•°å¼ é‡ï¼Œè®¡ç®—å…¶å½¢çŠ¶ï¼ˆshapeï¼‰æ‰€æœ‰ç»´åº¦çš„ä¹˜ç§¯ã€‚

### å…³é”®æ­¥éª¤
1. **æå–å…ƒæ•°æ®**ï¼šä»æ¨¡å‹ metadata ä¸­è·å–æ‰€æœ‰å‚æ•°å¼ é‡çš„å½¢çŠ¶ä¿¡æ¯ã€‚
2. **éå†å‚æ•°**ï¼šå¯¹æ¯ä¸ªå‚æ•°å¼ é‡è®¡ç®— `å½¢çŠ¶ç»´åº¦ä¹˜ç§¯`ã€‚
3. **ç´¯åŠ å‚æ•°é‡**ï¼šå°†æ‰€æœ‰ä¹˜ç§¯ç›¸åŠ å¾—åˆ°æ€»å‚æ•°é‡ã€‚

### Python ä»£ç ç¤ºä¾‹
```python
def calculate_params(metadata):
    """
    æ ¹æ®æ¨¡å‹ metadata è®¡ç®—æ€»å‚æ•°é‡
    metadata: å­—å…¸åˆ—è¡¨ï¼Œæ¯ä¸ªå­—å…¸åŒ…å«å‚æ•°åå’Œå½¢çŠ¶ï¼ˆå¦‚ {"name": "weight", "shape": [768, 768]}ï¼‰
    """
    total_params = 0
    for param_info in metadata:
        shape = param_info["shape"]
        param_count = 1
        for dim in shape:
            param_count *= dim  # è®¡ç®—å•ä¸ªå¼ é‡çš„å…ƒç´ æ•°é‡
        total_params += param_count
    return total_params

# ç¤ºä¾‹ï¼šBERT æ¨¡å‹çš„æŸä¸€å±‚ metadata
metadata = [
    {"name": "attention.query.weight", "shape": [768, 768]},
    {"name": "attention.query.bias", "shape": [768]},
    {"name": "attention.key.weight", "shape": [768, 768]},
    {"name": "attention.key.bias", "shape": [768]},
    # ...ï¼ˆå…¶ä»–å‚æ•°ï¼‰
]

total_params = calculate_params(metadata)
print(f"æ¨¡å‹æ€»å‚æ•°é‡: {total_params}")  # è¾“å‡ºç¤ºä¾‹ï¼šæ¨¡å‹æ€»å‚æ•°é‡: 3,145,728
```

### å¸¸è§å±‚å‚æ•°é‡è®¡ç®—
| **å±‚ç±»å‹**       | **å‚æ•°å¼ é‡** | **å½¢çŠ¶ç¤ºä¾‹**        | **è®¡ç®—å¼**             | **å‚æ•°é‡** |
|------------------|-------------|---------------------|-----------------------|-----------|
| å…¨è¿æ¥å±‚ (Dense) | Weight      | `[è¾“å…¥ç»´åº¦, è¾“å‡ºç»´åº¦]` | `in_dim Ã— out_dim`    | 1,000,000 |
|                  | Bias        | `[è¾“å‡ºç»´åº¦]`         | `out_dim`             | 1,000     |
| å·ç§¯å±‚ (Conv2d)  | Weight      | `[è¾“å‡ºé€šé“, è¾“å…¥é€šé“, æ ¸é«˜, æ ¸å®½]` | `out_ch Ã— in_ch Ã— kh Ã— kw` | 27,648    |
|                  | Bias        | `[è¾“å‡ºé€šé“]`         | `out_ch`              | 32        |
| åµŒå…¥å±‚ (Embedding)| Weight     | `[è¯è¡¨å¤§å°, åµŒå…¥ç»´åº¦]` | `vocab_size Ã— embed_dim` | 10,000,000 |

### æ³¨æ„äº‹é¡¹
1. **ä»…è®¡ç®—å¯è®­ç»ƒå‚æ•°**ï¼šç¡®ä¿ metadata ä¸­ä¸åŒ…å«å¸¸æ•°å¼ é‡ï¼ˆå¦‚å½’ä¸€åŒ–å±‚çš„ running_meanï¼‰ã€‚
2. **æ¡†æ¶å·®å¼‚**ï¼š
   - **PyTorch**ï¼šé€šè¿‡ `model.state_dict()` è·å– metadataï¼Œç¤ºä¾‹ï¼š
     ```python
     metadata = [{"name": n, "shape": list(p.shape)} for n, p in model.named_parameters()]
     ```
   - **TensorFlow/Keras**ï¼šé€šè¿‡ `model.trainable_variables` è·å–å½¢çŠ¶ã€‚
3. **å•ä½è½¬æ¢**ï¼šè‹¥å‚æ•°é‡è¿‡å¤§ï¼Œå¯è½¬æ¢ä¸ºç™¾ä¸‡ï¼ˆMï¼‰æˆ–åäº¿ï¼ˆBï¼‰å•ä½ï¼š
   ```python
   print(f"{total_params / 1e6:.2f}M")  # è¾“å‡ºï¼š85.00M
   ```

é€šè¿‡ä»¥ä¸Šæ–¹æ³•ï¼Œå¯å‡†ç¡®è®¡ç®—ä»»ä½•åŸºäºçŸ©é˜µç»´åº¦ metadata çš„æ¨¡å‹å‚æ•°é‡ã€‚å®é™…åº”ç”¨ä¸­ï¼Œç›´æ¥ç´¯åŠ æ‰€æœ‰å¼ é‡å…ƒç´ æ•°é‡æ˜¯æœ€å¯é ä¸”æ¡†æ¶æ— å…³çš„æ–¹å¼ã€‚