# 法律RAG系统分块切割策略

### 🧑‍💻 User

我现在要构建一个法律rag系统。那么法律法规要怎么切割才能既保持上下文，又不让块太大或太小呢？

---

### 🤖 Assistant

构建法律RAG系统时，法律法规文本的切割（分块/Chunking）是**核心环节之一**，直接关系到检索的准确性和生成结果的质量。法律文本有其特殊性（逻辑严密、条款引用、上下文依赖强），切割需要格外讲究策略。

以下是针对法律文本的分块策略建议，力求在**保持上下文完整性**和**控制块大小**之间取得平衡：

## 📌 核心原则

1.  **语义完整性优先：** 确保每个块代表一个相对独立、完整的法律概念、规则、条件或程序。避免将一个完整的意思拆得支离破碎。
2.  **尊重法律文本结构：** 法律文本本身具有清晰的层级结构（篇、章、节、条、款、项、目、段、但书）。切割应尽可能利用这些自然边界。
3.  **考虑引用关系：** 法律条款间常有引用（如“依照前款规定”、“符合本法第X条”）。切割时要尽量让被引用的条款和引用它的条款在同一个块内，或者确保它们能被同时检索到（通过重叠、元数据或关系映射）。
4.  **适应模型限制：** 块大小需在LLM上下文窗口限制内，并考虑检索效率（太多太小块增加检索计算量，太少太大块降低精度）。通常建议在256-1024个token范围内灵活调整。

## 📖 推荐的切割策略（分层细化）

### � 层级1：利用固有结构 - “条”作为基础单元
*   **策略：** 将每“**条**”作为**基础块**或**最小逻辑单元**。在中国、德国、日本等大陆法系国家的法典中，“条”通常是规定一项具体规则或权利义务的最小独立单位。
*   **优点：**
    *   天然语义边界，通常表达一个相对完整的意思。
    *   大小适中（多数条文长度在合理范围内）。
    *   便于定位（引用时直接说“第X条”）。
    *   保持条款内部的完整上下文。
*   **注意：** 对于极长的条文（如包含多项复杂规定的），需要进入下一层切割。

### � 层级2：条内精细化切割 - 款、项、目、段、但书
*   **策略：** 在“条”的基础上，根据其内部结构进一步细分：
    *   **款：** 如果一条有多款，且各款讨论不同方面或条件，可以按“款”切割。用分号或换行标识。
    *   **项：** 对某款或某条的列举性规定，常以“（一）”、“（二）”等标识。如果项的内容独立且较长，可以单独成块。
    *   **目：** 项的进一步细分（较少见），同样可独立成块。
    *   **段：** 同一款/项内的不同句子或语义段落。**谨慎使用！** 仅在句子间逻辑相对独立且块大小需要更小时才在段边界切割。**优先保证语义完整。**
    *   **但书：** “但是……” 或 “……的除外” 部分**必须**与其限制或例外的**主文部分放在同一个块内**！绝不可分割。但书是核心上下文。
*   **原则：**
    *   **优先保持款/项/目的完整性。**
    *   **只有当单一条文过长（超过目标块大小上限）时，才考虑在段或句号边界切割。**
    *   **强制：主文+但书必须同块。**

### 🧩 层级3：处理长条款 - 重叠分块与滑动窗口
*   **场景：** 遇到非常长的款、项或段，其长度超过了设定的理想块大小（如1024 token），且内部无法按自然结构（项、目）拆分。
*   **策略：**
    *   **重叠分块：**
        *   设定一个目标块大小（如512 token）和一个重叠量（如128 token）。
        *   按顺序切割文本块，每个新块从前一个块的结尾处向前重叠一部分（如128 token）。
        *   示例：块1: Token 0-511； 块2: Token 384-895； 块3: Token 768-1279 …
    *   **滑动窗口：** 类似于重叠分块，窗口大小固定，每次滑动固定步长（小于窗口大小）。
*   **优点：** 确保长文本中任何位置的信息都不会因为正好落在块边缘而丢失。检索时，多个重叠块可能被召回，LLM可以综合判断。
*   **缺点：** 增加了块的数量和冗余度，可能略微降低检索效率。需要权衡重叠大小（太小可能解决不了上下文丢失，太大则冗余度高）。

### 📋 层级4：特殊结构处理
*   **定义条款：**
    *   集中定义部分（如某法第X章“术语解释”）：可以单独切割成块，并添加“定义”、“术语”等元数据标签。
    *   条文内嵌定义：**务必**将定义和首次使用该术语的上下文放在**同一个块内**，或者确保定义块能被关联检索到。
*   **援引性条款：**
    *   “依照本法第X条的规定…”：切割时，尽量将被援引的第X条和当前条款放在**同一个大块**（如在同一节/章切割时）或确保它们的块有**强关联元数据**（如章节号）。在元数据中记录引用关系更好。
*   **示例/说明性文字：** 通常附属于主条款，应与其所属的主条款放在同一个块内。

## 🏷 不可或缺：元数据（Metadata）

每个文本块必须附带丰富的元数据，这是维持“大上下文”的关键补偿机制：

1.  **法律标识：** 法律名称、发布机关、生效日期、修订日期。
2.  **层级定位：** 篇、章、节、条、款、项、目的编号/标题。**这是最重要的元数据！**
3.  **主题标签：** 人工或自动标注该块的核心主题（如“合同解除”、“工伤认定”、“证据规则”）。
4.  **实体标签：** 识别块中出现的关键法律实体（如“用人单位”、“劳动者”、“不可抗力”、“专利权”）。
5.  **引用关系：** 记录该块引用了哪些其他法条，或被哪些法条引用（可通过后期处理或NLP识别添加）。
6.  **块类型：** 如“定义”、“责任条款”、“程序规定”、“但书”、“罚则”等。
7.  **切割方式：** 记录该块是“完整条”、“条-款”、“条-项”、“重叠块”等，供检索或LLM参考。

## 🔧 技术实现要点

1.  **结构化解析：** 优先使用能识别法律文本结构的解析器（如解析PDF/Word时识别标题、条号、款号、项号）。正则表达式在匹配条号等方面非常有用。
2.  **基于语义分割：**
    *   在自然句号、分号（常在大陆法系法律中用于分隔不同情形）处切割。
    *   使用NLP模型进行句子边界检测或语义分割（识别话题转换点），作为辅助手段，**但法律文本的逻辑结构通常是更可靠的依据**。
3.  **块大小动态调整：** 不要机械地固定token数。优先在自然结构边界（条、款、项）处切割，即使它略大于平均值（如1200 token）。只有当在自然边界内仍然过长时，才使用重叠分块。
4.  **目标Token范围：** 一个实用的范围是 **256 - 1024 tokens**。
    *   **下限 (256-512 tokens):** 适用于检索精度要求极高、处理速度要求高，且法律条文本身较短小精悍的场景。确保最小的语义单元完整。
    *   **主流/平衡 (512-768 tokens):** 推荐起点。能容纳大多数完整的“条”或“条-款”，上下文较充分。
    *   **上限 (768-1024 tokens):** 用于容纳较长的完整条文，或需要包含更多上下文（如紧密相关的上下条）的情况。需注意LLM上下文窗口限制。
5.  **后处理与验证：**
    *   人工抽检：检查切割点是否破坏了语义（尤其检查但书是否绑定）。
    *   检索测试：模拟真实查询，看检索到的块是否包含回答问题的足够且连贯的信息。
    *   LLM生成测试：用检索到的块喂给LLM，看其生成答案的准确性和连贯性。

## 📌 总结建议方案（推荐工作流）

1.  **基础切割：** 以“**条**”作为**默认的、首要的切割单元**。大部分情况下这是最佳平衡点。
2.  **条内处理：**
    *   如果一条只有一款且长度适中，保留为完整块。
    *   如果一条有多款，且各款相对独立，按“款”切割。
    *   如果某款包含多项详细列举，且项较长/独立，按“项”切割。
    *   如果切割到款或项后，块仍然**显著超过**目标大小（如>1024 tokens），对该款或项内部**谨慎使用重叠分块**（优先在句号/分号处，设置合理重叠如128-256 tokens）。
    *   **强制规则：** 主文和但书必须在同一块内。
3.  **添加丰富元数据：** 重点是层级定位信息和法律标识。
4.  **构建引用图谱（可选但推荐）：** 建立条文之间的引用关系索引，帮助RAG在检索到引用条款时能快速关联到被引用的条款块，即使它们物理上不在同一个块。
5.  **迭代优化：** 基于实际检索和生成效果，调整切割策略（如是否更激进地按项切割，或增大块大小包含更多上下文），重点关注那些导致生成错误或模糊的案例。

## ⚖ 重要权衡

*   **更大块：**
    *   *优点：* 上下文更完整，减少引用丢失风险，可能减少总块数。
    *   *缺点：* 检索精度可能下降（包含无关信息），LLM可能无法有效关注到块内真正相关的片段。
*   **更小块：**
    *   *优点：* 检索精度更高，LLM更容易聚焦相关信息。
    *   *缺点：* 上下文碎片化风险高，容易丢失关键依赖（尤其是引用、但书），增加总块数影响检索效率。

**法律RAG的切割没有绝对完美的“一刀切”方案。** 最有效的方法是**以法律结构（条、款、项）为主干，动态调整大小，辅以重叠分块处理超长单元，并利用丰富的元数据弥补碎片化风险，同时进行充分的测试和迭代优化。** 优先保障核心法律概念和规则（尤其是包含但书、条件、完整程序的条款）的语义完整性是关键中的关键。💪🏻