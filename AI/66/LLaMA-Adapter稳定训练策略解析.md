# LLaMA-Adapterç¨³å®šè®­ç»ƒç­–ç•¥è§£æ

### ğŸ§‘â€ğŸ’» User

LLaMA-adapter å¦‚ä½•å®ç°ç¨³å®šè®­ç»ƒï¼Ÿ

---

### ğŸ¤– Assistant

LLaMA-Adapter æ˜¯ä¸€ç§åŸºäºLLaMAæ¶æ„çš„å‚æ•°é«˜æ•ˆå¾®è°ƒæ–¹æ³•ï¼Œé€šè¿‡å¼•å…¥è½»é‡çº§é€‚é…å™¨æ¨¡å—ï¼Œå®ç°å¯¹å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹çš„é«˜æ•ˆè®­ç»ƒã€‚å…¶å®ç°ç¨³å®šè®­ç»ƒçš„æ ¸å¿ƒç­–ç•¥åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

---

### ä¸€ã€æ¨¡å—åŒ–ç»“æ„è®¾è®¡
1. **é€‚é…å™¨æ’å…¥æ–¹å¼**
   - åœ¨LLaMAçš„Transformerå±‚ä¸­æ’å…¥è½»é‡çº§é€‚é…å™¨ï¼ˆAdapterï¼‰ï¼Œé€šå¸¸ä½äº**æ³¨æ„åŠ›æœºåˆ¶ï¼ˆQ/K/Vï¼‰å’Œå‰é¦ˆç½‘ç»œï¼ˆFFNï¼‰ä¹‹é—´**ã€‚
   - é€‚é…å™¨æ¨¡å—ç»“æ„ï¼šå¤šå±‚æ„ŸçŸ¥æœºï¼ˆMLPï¼‰æˆ–ä½ç§©çŸ©é˜µï¼Œå‚æ•°é‡ä»…ä¸ºåŸå§‹æ¨¡å‹çš„0.1%~1%ã€‚

2. **æ®‹å·®è¿æ¥ä¸å±‚å½’ä¸€åŒ–**
   - åœ¨æ¯ä¸ªé€‚é…å™¨æ¨¡å—ä¸­ä¿ç•™**æ®‹å·®è¿æ¥ï¼ˆResidual Connectionï¼‰**ï¼Œä¿æŒè¾“å…¥ä¸è¾“å‡ºçš„ç»´åº¦åŒ¹é…ã€‚
   - ä½¿ç”¨**å±‚å½’ä¸€åŒ–ï¼ˆLayerNormï¼‰** åŠ é€Ÿè®­ç»ƒå¹¶ç¼“è§£æ¢¯åº¦é—®é¢˜ã€‚

   **ç¤ºä¾‹ä¼ªä»£ç **ï¼š
   ```python
   class Adapter(nn.Module):
       def __init__(self, input_dim, adapter_dim):
           self.linear1 = nn.Linear(input_dim, adapter_dim)
           self.linear2 = nn.Linear(adapter_dim, input_dim)
           self.layernorm = nn.LayerNorm(input_dim)
           
       def forward(self, x):
           h = self.linear2(F.silu(self.linear1(self.layernorm(x))))
           return x + h  # æ®‹å·®è¿æ¥
   ```

---

### äºŒã€è®­ç»ƒç­–ç•¥ä¼˜åŒ–
1. **å†»ç»“ä¸»å¹²å‚æ•°**
   - ä¿æŒLLaMAä¸»å¹²å‚æ•°ï¼ˆå¦‚Q/K/VçŸ©é˜µã€FFNæƒé‡ï¼‰å›ºå®šï¼Œä»…è®­ç»ƒé€‚é…å™¨æ–°å¢å‚æ•°ï¼Œå‡å°‘è®¡ç®—è´Ÿæ‹…ã€‚

2. **å­¦ä¹ ç‡è°ƒåº¦**
   - ä½¿ç”¨**ä½™å¼¦é€€ç«**æˆ–**çº¿æ€§é¢„çƒ­+çº¿æ€§è¡°å‡**ç­–ç•¥ï¼Œé¿å…è®­ç»ƒåˆæœŸä¸ç¨³å®šã€‚
   - é€‚é…å™¨å­¦ä¹ ç‡é€šå¸¸è®¾ç½®ä¸º1e-4è‡³5e-5ä¹‹é—´ï¼Œä¸»å¹²æ¨¡å‹å‚æ•°å†»ç»“æ— éœ€å­¦ä¹ ç‡ã€‚

3. **æ¢¯åº¦è£å‰ªä¸æ­£åˆ™åŒ–**
   - å¯¹é€‚é…å™¨çš„æ¢¯åº¦è¿›è¡Œè£å‰ªï¼ˆå¦‚`max_norm=1.0`ï¼‰ï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ã€‚
   - æ·»åŠ æƒé‡è¡°å‡ï¼ˆL2æ­£åˆ™åŒ–ï¼‰äºé€‚é…å™¨å‚æ•°ã€‚

4. **ä½ç§©çŸ©é˜µåˆå§‹åŒ–**
   - è‹¥ä½¿ç”¨ä½ç§©å‚æ•°çŸ©é˜µï¼Œé‡‡ç”¨SVDæˆ–Xavieråˆå§‹åŒ–ï¼Œç¡®ä¿åˆå§‹å€¼åˆç†åˆ†å¸ƒã€‚

---

### ä¸‰ã€å®éªŒéªŒè¯ä¸è°ƒå‚å»ºè®®
1. **å‚æ•°é‡å¯¹æ¯”**
   - ç¤ºä¾‹ï¼šLLaMA-7Bä¸»å¹²æ¨¡å‹å†»ç»“ï¼Œé€‚é…å™¨å‚æ•°é‡æ§åˆ¶åœ¨800ä¸‡ä»¥å†…ã€‚

2. **ä»»åŠ¡é€‚é…**
   - å¯¹äºä¸‹æ¸¸ä»»åŠ¡ï¼ˆå¦‚æ–‡æœ¬åˆ†ç±»ã€é—®ç­”ï¼‰ï¼Œéœ€å¾®è°ƒé€‚é…å™¨çš„å±‚æ•°å’Œç»´åº¦ã€‚
   - ç®€å•ä»»åŠ¡ä½¿ç”¨æµ…å±‚é€‚é…å™¨ï¼ˆå¦‚1å±‚MLPï¼‰ï¼Œå¤æ‚ä»»åŠ¡å¯å¢åŠ å±‚æ•°æˆ–ç»´åº¦ã€‚

3. **æ¶ˆèå®éªŒ**
   - éªŒè¯ä¸åŒé…ç½®ï¼ˆå¦‚é€‚é…å™¨ä½ç½®ã€å±‚æ•°ã€æ¿€æ´»å‡½æ•°ï¼‰å¯¹æ€§èƒ½çš„å½±å“ã€‚

---

### å››ã€ä»£ç å®ç°ç¤ºä¾‹ï¼ˆPyTorchä¼ªä»£ç ï¼‰
```python
import torch
import torch.nn as nn
import torch.nn.functional as F

class LLaMA_Adapter(nn.Module):
    def __init__(self, llama_model, adapter_dim=64):
        super().__init__()
        self.llama = llama_model  # å‡è®¾å·²åŠ è½½é¢„è®­ç»ƒLLaMAæ¨¡å‹
        for param in self.llama.parameters():
            param.requires_grad = False  # å†»ç»“ä¸»å¹²å‚æ•°
        
        # æ’å…¥é€‚é…å™¨å±‚
        self.adapters = nn.ModuleList()
        for i in range(llama_model.num_layers):
            self.adapters.append(
                Adapter(lla_model.hidden_dim, adapter_dim)
            )
    
    def forward(self, input_ids, attention_mask=None):
        hidden_states = self.llama.embed(input_ids)
        adapter_outputs = []
        for i, (layer, adapter) in enumerate(zip(self.llama.layers, self.adapters)):
            hidden_states = layer(hidden_states, attention_mask)
            if i % 2 == 0:  # æ§åˆ¶æ’å…¥ä½ç½®
                hidden_states = adapter(hidden_states)
        return self.llama.classifier(hidden_states)
```

---

### äº”ã€è¿›é˜¶è°ƒä¼˜æŠ€å·§
1. **åŠ¨æ€é€‚é…å™¨è·¯ç”±**
   - æ ¹æ®ä»»åŠ¡å¤æ‚åº¦è‡ªåŠ¨é€‰æ‹©æ€§æ¿€æ´»éƒ¨åˆ†é€‚é…å™¨æ¨¡å—ã€‚

2. **å¤šä»»åŠ¡å­¦ä¹ **
   - ä¸ºä¸åŒä»»åŠ¡åˆ†é…ç‹¬ç«‹é€‚é…å™¨ï¼Œå…±äº«ä¸»å¹²å‚æ•°ï¼Œæå‡å‚æ•°å¤ç”¨ç‡ã€‚

3. **æ··åˆç²¾åº¦è®­ç»ƒ**
   - ä½¿ç”¨`torch.cuda.amp`æˆ–`DeepSpeed`è¿›è¡Œæ··åˆç²¾åº¦è®­ç»ƒï¼ŒåŠ é€Ÿæ”¶æ•›ã€‚

4. **çŸ¥è¯†è’¸é¦**
   - ç”¨åŸå§‹LLaMAè¾“å‡ºçš„logitsä½œä¸ºè½¯æ ‡ç­¾ï¼Œè’¸é¦é€‚é…å™¨æ¨¡å‹ã€‚

---

é€šè¿‡ä¸Šè¿°æ–¹æ³•ï¼ŒLLaMA-Adapteråœ¨ä¿æŒä¸»å¹²å‚æ•°å†»ç»“çš„å‰æä¸‹ï¼Œä»…é€šè¿‡å¾®è°ƒè½»é‡çº§é€‚é…å™¨å‚æ•°ï¼ˆ<1%åŸå§‹æ¨¡å‹å‚æ•°é‡ï¼‰ï¼Œå³å¯åœ¨å¤šç§ä¸‹æ¸¸ä»»åŠ¡ä¸Šè¾¾åˆ°æ¥è¿‘å…¨é‡å¾®è°ƒçš„æ•ˆæœï¼ŒåŒæ—¶æ˜¾è‘—æå‡è®­ç»ƒç¨³å®šæ€§ã€‚