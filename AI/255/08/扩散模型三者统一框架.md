# 扩散模型三者统一框架

### 🧑‍💻 User

DDIM/score-SDE/score-ODE 三者的统一框架是怎么样的？

---

### 🤖 Assistant

DDIM、Score-SDE 和 Score-ODE 三者被统一在 **基于分数的随机微分方程（Score-based Stochastic Differential Equations, Score-SDE）** 这一框架下。这个统一框架主要由 Song Yang 等人在 ICLR 2021 的论文《Score-Based Generative Modeling through Stochastic Differential Equations》中提出。

简单来说，它们的关系如下：
1.  **Score-SDE** 是最通用的连续时间框架，描述了扩散模型的前向加噪和反向去噪过程。
2.  **Score-ODE** (即 Probability Flow ODE) 是 Score-SDE 的一个特例，它是一个**确定性**的微分方程，但拥有与 SDE 相同的边缘概率分布。
3.  **DDIM** 本质上是 **Score-ODE 的一种离散化求解器（Euler Discretization）**。

下面详细推导它们是如何在数学上统一的。

---

### 1. 顶层框架：Score-SDE

在连续时间下，扩散过程（前向过程）可以被建模为一个随机微分方程（SDE）。假设数据分布为 $p_0(\mathbf{x})$，随着时间 $t \in [0, T]$ 增加，我们加入噪声：

$$ d\mathbf{x} = \mathbf{f}(\mathbf{x}, t) dt + g(t) d\mathbf{w} $$

其中：
*   $\mathbf{f}(\mathbf{x}, t)$ 是**漂移系数（Drift coefficient）**。
*   $g(t)$ 是**扩散系数（Diffusion coefficient）**。
*   $\mathbf{w}$ 是标准维纳过程（布朗运动）。

#### 反向 SDE（生成过程）
Anderson (1982) 证明了上述 SDE 有一个对应的**反向时间 SDE**，可以用于从噪声分布 $p_T(\mathbf{x})$ 恢复数据分布 $p_0(\mathbf{x})$：

$$ d\mathbf{x} = [\mathbf{f}(\mathbf{x}, t) - g(t)^2 \nabla_\mathbf{x} \log p_t(\mathbf{x})] dt + g(t) d\bar{\mathbf{w}} $$

这里 $d\bar{\mathbf{w}}$ 是反向时间的布朗运动，$dt$ 是负的时间步。
关键在于其中的 $\nabla_\mathbf{x} \log p_t(\mathbf{x})$，这就是**分数函数（Score Function）**。我们在训练时用神经网络 $s_\theta(\mathbf{x}, t)$ 来近似它。

这就是 **Score-SDE** 的核心形式：通过求解这个反向 SDE 进行采样，且包含随机噪声项 $g(t) d\bar{\mathbf{w}}$。

---

### 2. 桥梁：Probability Flow ODE (Score-ODE)

Score-SDE 框架的一个重要发现是：对于任意一个扩散 SDE，都存在一个**确定性**的常微分方程（ODE），其轨迹虽然没有随机性，但在任意时刻 $t$ 的边缘分布 $p_t(\mathbf{x})$ 与原来的 SDE 完全一致。

这个 ODE 被称为 **Probability Flow ODE (Score-ODE)**。其推导基于 Fokker-Planck 方程，其形式为：

$$ d\mathbf{x} = [\mathbf{f}(\mathbf{x}, t) - \frac{1}{2}g(t)^2 \nabla_\mathbf{x} \log p_t(\mathbf{x})] dt $$

**注意观察区别：**
*   **反向 SDE:** 系数是 $-g(t)^2$，且有噪声项 $g(t)d\bar{\mathbf{w}}$。
*   **Score-ODE:** 系数是 $-\frac{1}{2}g(t)^2$，且**没有**噪声项（确定性过程）。

这个 Score-ODE 允许我们使用任何现成的 ODE 求解器（如 Euler, Runge-Kutta）来进行采样，这使得从噪声生成图像的过程变成了在一个平滑的轨迹上移动。

---

### 3. 具体化：DDIM 的位置

DDIM (Denoising Diffusion Implicit Models) 最初是通过非马尔可夫变分推断推导出来的，但在 Score-SDE 的框架下，它可以被非常直观地解释。

DDIM 等价于 **Score-ODE 的一阶欧拉离散化（Euler Discretization）**。

#### 具体的对应关系：
如果我们考虑经典的 DDPM 中的 VP-SDE (Variance Preserving SDE)，其对应的 ODE 形式经过变量代换后，其更新公式与 DDIM 的更新公式完全一致。

1.  **DDPM** 对应于求解 **反向 SDE**（每一步都注入随机噪声）。
2.  **DDIM** 对应于求解 **Score-ODE**（每一步都是确定性的，没有随机噪声注入，或者说 $\sigma=0$）。

在数学上，Score-ODE 的更新规则如下（离散化后）：
$$ \mathbf{x}_{t-1} = \mathbf{x}_t - [\mathbf{f}(\mathbf{x}_t, t) - \frac{1}{2}g(t)^2 s_\theta(\mathbf{x}_t, t)] \Delta t $$

这正是 DDIM 论文中当 $\sigma_t = 0$ 时的采样公式。

---

### 总结：三者的统一视图

我们可以用一个公式概括这三者。考虑如下通用的反向更新方程：

$$ d\mathbf{x} = [\mathbf{f}(\mathbf{x}, t) - (1 + \lambda) \frac{1}{2} g(t)^2 \nabla_\mathbf{x} \log p_t(\mathbf{x})] dt + \sqrt{\lambda} g(t) d\bar{\mathbf{w}} $$

其中 $\lambda \in [0, 1]$ 是一个控制随机性的参数。

| 名称 | $\lambda$ 值 | 物理含义 | 特点 |
| :--- | :--- | :--- | :--- |
| **Score-ODE** | $\lambda = 0$ | 确定性 ODE | 采样速度快，可逆，对应 **DDIM** |
| **Score-SDE** | $\lambda = 1$ | 完整 SDE | 采样质量通常略高，抗干扰强，对应 **DDPM/SMLD** |
| **中间状态** | $0 < \lambda < 1$ | 部分随机 SDE | 在确定性和随机性之间折衷 |

**结论：**
*   **Score-SDE** 是描述扩散模型物理过程的**母体（Parent）**。
*   **Score-ODE** 是 Score-SDE 对应的**概率流（Probability Flow）**，共享边缘分布但没有随机性。
*   **DDIM** 是 **Score-ODE** 在特定离散化策略下的**数值实现（Solver）**。