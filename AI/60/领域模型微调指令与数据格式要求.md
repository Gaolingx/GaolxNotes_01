# 领域模型微调指令与数据格式要求

### 🧑‍💻 User

领域模型对微调指令以及数据输入格式有哪些要求？

---

### 🤖 Assistant

领域模型的微调与数据输入格式需遵循一定的规范，并根据任务目标进行调整。以下是关键要求和注意事项，结构清晰、便于执行：

---

### **一、微调（Fine-tuning）阶段的核心要求**
1. **模型架构适配**
   - **输入格式**：需符合预训练模型的输入规范（如BERT的`[CLS]`、`[SEP]`标记，GPT系的`<|endoftext|>`结束符）。
   - **序列长度**：控制最大长度（如512个token），避免溢出或计算资源浪费。
   - **特殊标记处理**：根据任务类型添加特殊符号（如[CLS]用于分类，[MASK]用于完形填空）。

2. **数据标注与预处理**
   - **标注格式**：
     - **分类任务**：文本对分类（如`[CLS]` + 句子A + `[SEP]` + 句子B）。
     - **NER/序列标注**：token级标签（BIO格式，如`["I``-``like`", `["O`", `["B-PER`", `["I-PER`"]`）。
     - **生成任务**：格式（如T5的前缀模板：`"translate: %s"`）。
   - **数据清洗**：
     - 移除重复、低质量数据。
     - 处理领术语（如医学缩写、化学式）或特殊符号（如法律文档中的长句分隔符）。

3. **训练策略优化**
   - **两阶段微调**：
     1. **领预训练（Domain Pre-training）**：在目标领域未标注语料上继续预训练（如Wikipedia数据）。
     2. **任务微调**：冻结部分底层参数，微调顶层适配特定任务。
   - **参数配置**：
     - 学习 rate：通常设置为2e-5至5e-5（比预训练阶段更小）。
     - 批量大小：根据硬件资源调整，建议从小批量开始（如8/16）。
     - 梯度累积：处理内存不足问题。

4. **领适配技术**
   - **自定义分词器**：若领域含特殊符号（如化学式H₂O），需扩展分词器词汇表。
   - **前缀/前缀微调**：冻结主干模型，仅微调前缀参数（如Prefix-Tuning）。
   - **持续学习**：防止灾难性遗忘，采用弹性参数正则化（Elastic Weight Consolidation, EWC）。

---

### **二、数据输入格式的标准化要求**
1. **通用规则**
   - **文本表示**：小写化、特殊符号标准化（如日期、单位）。
   - **tokenization**：使用模型对应分词器（如BERT的WordPiece，GPT的BPE）。  
   - **填充与截断**：固定长度填充（如Pad到128/512），避免动态长度导致效率下降。

2. **任务特定格式示例**
   - **句子对分类（如MNLI）**：
     ```plaintext
     [CLS] 药品A治疗有效吗？ [SEP] 患者使用后症状缓解。[SEP]
     标签：有效
     ```
   - **序列标注（如医学NER）**：
     ```plaintext
     输入：患者于2023-05-01服用华法林5mg/d。
     输出：O O O O B-DRUG I-DRUG I-DRUG O O O O O O
     ```
   - **生成任务（如法律文本摘要）**：
     ```plaintext
     输入："总结以下条款：根据第X条，卖方应保证货物符合ISO 9001认证。"
     输出：卖方需确货品符合ISO 9001标准。
     ```

3. **领词表扩展**
   - **自定义特殊符号**：添加领域专业术语到分词器（如`[CIMICINE]`）。
   - **处理罕见词**：通过字节对编码（BPE）拆分未登录领域词汇。

---

### **三、评估与迭代优化**
1. **评估指标**
   - **结构化任务**：准确率（Accuracy）、F1值（如NER的实体级F1）。
   - **生成任务**：BLEU、ROUGE等自动生成评价指标，结合人工评估（连贯性、相关性）。
   - **领反馈**：医学领需专家标注数据验证模型输出的临床意义。

2. **持续优化**
   - **数据增强**：
     - 领域同义词替换（如同义词词林、医学领词典）。
     - 回译（Back-translation）生成对抗数据。
   - **错误分析**：构建错误案例集，补充数据或调整标注规则。
   - **合规性**：医疗、金融等领域需确保数据脱敏（如GDPR、HIPAA）。

3. **工程实现**
   - **框架选择**：Hugging Face Transformers、DeepSpeed（支持大模型训练）。
   - **压缩技术**：知识蒸馏（如DistilBERT）、量化（如INT8）。

---

### **四、关键注意事项**
1. **数据平衡**：避免类别不平衡（如医疗数据中罕见病样本过少），可采用重采样或过采样技术（如SMOTE）。
2. **版本控制**：使用DVC、MLflow追踪数据和模型版本。
3. **可解释性**：使用LIME、SHAP分析模型决策依据，尤其在高风险领（如法律、医疗）。

---

通过以上步骤，可以系统性地微调领模型，并确保输入数据的规范性与高效性。实际应用中需根据具体需求（如计算资源、领域特性）灵活调整方案。