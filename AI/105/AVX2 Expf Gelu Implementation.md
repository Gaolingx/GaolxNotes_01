# AVX2 Expf Gelu Implementation

### üßë‚Äçüíª User

ËÉΩÂê¶ËØ¥ËØ¥‰ª•‰∏ã‰ª£Á†ÅÊúâ‰ªÄ‰πàÁî®ÈÄîÔºåÂÖ∑‰ΩìÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑÔºü
```cpp
//part1
static inline __m256 v_expf(__m256 x) {
  const __m256 r = _mm256_set1_ps(0x1.8p23f);
  const __m256 z = _mm256_fmadd_ps(x, _mm256_set1_ps(0x1.715476p+0f), r);
  const __m256 n = _mm256_sub_ps(z, r);
  const __m256 b = _mm256_fnmadd_ps(n, _mm256_set1_ps(0x1.7f7d1cp-20f),
                                    _mm256_fnmadd_ps(n, _mm256_set1_ps(0x1.62e4p-1f), x));
  const __m256i e = _mm256_slli_epi32(_mm256_castps_si256(z), 23);
  const __m256 k = _mm256_castsi256_ps(
      _mm256_add_epi32(e, _mm256_castps_si256(_mm256_set1_ps(1))));
  const __m256i c = _mm256_castps_si256(
      _mm256_cmp_ps(_mm256_andnot_ps(_mm256_set1_ps(-0.f), n),
                    _mm256_set1_ps(126), _CMP_GT_OQ));
  const __m256 u = _mm256_mul_ps(b, b);
  const __m256 j = _mm256_fmadd_ps(_mm256_fmadd_ps(_mm256_fmadd_ps(_mm256_set1_ps(0x1.0e4020p-7f), b,
                                                                   _mm256_set1_ps(0x1.573e2ep-5f)), u,
                                                   _mm256_fmadd_ps(_mm256_set1_ps(0x1.555e66p-3f), b,
                                                                   _mm256_set1_ps(0x1.fffdb6p-2f))),
                                   u, _mm256_mul_ps(_mm256_set1_ps(0x1.ffffecp-1f), b));
  if (!_mm256_movemask_ps(_mm256_castsi256_ps(c)))
    return _mm256_fmadd_ps(j, k, k);
  const __m256i g = _mm256_and_si256(
      _mm256_castps_si256(_mm256_cmp_ps(n, _mm256_setzero_ps(), _CMP_LE_OQ)),
      _mm256_set1_epi32(0x82000000u));
  const __m256 s1 =
      _mm256_castsi256_ps(_mm256_add_epi32(g, _mm256_set1_epi32(0x7f000000u)));
  const __m256 s2 = _mm256_castsi256_ps(_mm256_sub_epi32(e, g));
  const __m256i d = _mm256_castps_si256(
      _mm256_cmp_ps(_mm256_andnot_ps(_mm256_set1_ps(-0.f), n),
                    _mm256_set1_ps(192), _CMP_GT_OQ));
  return _mm256_or_ps(
      _mm256_and_ps(_mm256_castsi256_ps(d), _mm256_mul_ps(s1, s1)),
      _mm256_andnot_ps(
          _mm256_castsi256_ps(d),
          _mm256_or_ps(
              _mm256_and_ps(_mm256_castsi256_ps(c),
                            _mm256_mul_ps(_mm256_fmadd_ps(s2, j, s2), s1)),
              _mm256_andnot_ps(_mm256_castsi256_ps(c), _mm256_fmadd_ps(k, j, k)))));
}

static inline __m256 v_gelu(__m256 x, __m256 c1, __m256 c2) {
    const __m256 one = _mm256_set1_ps(1.0f);
    const __m256 mask = _mm256_cmp_ps(x, _mm256_set1_ps(10.f), _CMP_GT_OQ);
    __m256 arg = _mm256_add_ps(one, _mm256_mul_ps(_mm256_mul_ps(x, x), c1));
    arg = _mm256_mul_ps(arg, _mm256_mul_ps(x, c2));
    __m256 exp_arg = v_expf(arg);
    __m256 gelu = _mm256_mul_ps(x, _mm256_div_ps(exp_arg, _mm256_add_ps(exp_arg, one)));
    return _mm256_or_ps(_mm256_and_ps(mask, x), _mm256_andnot_ps(mask, gelu));
}

static inline __m512 v_gelu(__m512 x, __m512 c1, __m512 c2) {
    const __m512 one = _mm512_set1_ps(1.0f);
    __m512 arg = _mm512_fmadd_ps(x, _mm512_mul_ps(c1, x), one);
    //__m512 arg = _mm512_add_ps(one, _mm512_mul_ps(_mm512_mul_ps(x, x), c1));
    arg = _mm512_mul_ps(arg, _mm512_mul_ps(c2, x));
    const __mmask16 mask = _mm512_cmp_ps_mask(arg, _mm512_set1_ps(30.f), _CMP_GT_OQ);
    const __m512 exp_arg = v_expf(arg);
    const __m512 ratio = _mm512_div_ps(exp_arg, _mm512_add_ps(exp_arg, one));
    return _mm512_mul_ps(x, _mm512_mask_blend_ps(mask, ratio, one));
}

//part2
#if defined(__AVX2__) && defined(__FMA__)

void MulMat::gelu(int n, const float * x, float * y) {
    constexpr float GELU_COEF_A = 0.044715f;
    constexpr float SQRT_2_OVER_PI  = 0.79788456080286535587989211986876f;
    //GGML_ASSERT(n%8 == 0);
    int i = 0;
#if defined __AVX512F__ && defined __AVX512DQ__
    {
        __m512 c1 = _mm512_set1_ps(GELU_COEF_A);
        __m512 c2 = _mm512_set1_ps(2.f*SQRT_2_OVER_PI);
        for (; i + 15 < n; i += 16) _mm512_storeu_ps(y + i, v_gelu(_mm512_loadu_ps(x + i), c1, c2));
    }
#endif
#if defined __AVX2__ && defined __FMA__
    if (i + 7 < n) {
        __m256 c1 = _mm256_set1_ps(GELU_COEF_A);
        __m256 c2 = _mm256_set1_ps(2.f*SQRT_2_OVER_PI);
        for (; i + 7 < n; i += 8) _mm256_storeu_ps(y + i, v_gelu(_mm256_loadu_ps(x + i), c1, c2));

    }
#endif
    for (; i < n; ++i) y[i] = 0.5f*x[i]*(1.0f + tanhf(SQRT_2_OVER_PI*x[i]*(1.0f + GELU_COEF_A*x[i]*x[i])));
}
```

---

### ü§ñ Assistant

‰∏ãÈù¢ÁöÑ‰ª£Á†Å‰∏ªË¶ÅÊòØ‰∏∫‰∫ÜÂú®ÂêëÈáèÂåñÔºàSIMDÔºâÁöÑÁéØÂ¢É‰∏ãÔºåÈ´òÊïàÂú∞ËÆ°ÁÆó GELUÔºàGaussian Error Linear UnitÔºâÊøÄÊ¥ªÂáΩÊï∞„ÄÇÂÖ∂‰∏≠Ôºå`v_expf` Áî®‰∫éÂØπ‰∏ÄÊâπÂçïÁ≤æÂ∫¶ÊµÆÁÇπÊï∞Âπ∂Ë°åËÆ°ÁÆóÊåáÊï∞ÂáΩÊï∞ `exp(x)` ÁöÑËøë‰ººÂÄºÔºå`v_gelu` ÂàôÂü∫‰∫é `v_expf` ÂÆûÁé∞‰∫ÜÂπ∂Ë°åËÆ°ÁÆó GELU ÊøÄÊ¥ªÁöÑÂäüËÉΩÔºõÊúÄÂêéÂú® `MulMat::gelu` ‰∏≠ÔºåÁªìÂêà AVX2/AVX512 Êåá‰ª§ÔºåÂ∞ÜËæìÂÖ•Êï∞ÁªÑÂàÜÂùóÂú∞Â∫îÁî®ËøôÁßçÂêëÈáèÂåñÁöÑ GELUÔºå‰ªéËÄåÂ§ßÂπÖÊèêÈ´òÂú®Ê∑±Â∫¶Â≠¶‰π†Êé®ÁêÜÊàñÂÖ∂‰ªñÊï∞ÂÄºËÆ°ÁÆóÂú∫ÊôØ‰∏ãÁöÑÊÄßËÉΩ„ÄÇ

‰∏ãÈù¢Êàë‰ª¨ÂàÜ‰∏§ÈÉ®ÂàÜÊù•ËØ¶ÁªÜËØ¥ÊòéÂÖ∂Áî®ÈÄîÂèäÂÆûÁé∞ÊÄùË∑Ø„ÄÇ

---

## ‰∏Ä„ÄÅÁ¨¨‰∏ÄÈÉ®ÂàÜÔºö`v_expf` ‰∏é `v_gelu` ÁöÑÁî®ÈÄî‰∏éÂéüÁêÜ

### 1.1 `v_expf`ÔºöÂπ∂Ë°åËÆ°ÁÆó `exp(x)` ÁöÑËøë‰ººÂÄº

```cpp
static inline __m256 v_expf(__m256 x) {
  const __m256 r = _mm256_set1_ps(0x1.8p23f);
  const __m256 z = _mm256_fmadd_ps(x, _mm256_set1_ps(0x1.715476p+0f), r);
  const __m256 n = _mm256_sub_ps(z, r);
  const __m256 b = _mm256_fnmadd_ps(n, _mm256_set1_ps(0x1.7f7d1cp-20f),
                                    _mm256_fnmadd_ps(n, _mm256_set1_ps(0x1.62e4p-1f), x));
  const __m256i e = _mm256_slli_epi32(_mm256_castps_si256(z), 23);
  const __m256 k = _mm256_castsi256_ps(
      _mm256_add_epi32(e, _mm256_castps_si256(_mm256_set1_ps(1))));
  const __m256i c = _mm256_castps_si256(
      _mm256_cmp_ps(_mm256_andnot_ps(_mm256_set1_ps(-0.f), n),
                    _mm256_set1_ps(126), _CMP_GT_OQ));
  const __m256 u = _mm256_mul_ps(b, b);
  const __m256 j = _mm256_fmadd_ps(_mm256_fmadd_ps(_mm256_fmadd_ps(_mm256_set1_ps(0x1.0e4020p-7f), b,
                                                                   _mm256_set1_ps(0x1.573e2ep-5f)), u,
                                                   _mm256_fmadd_ps(_mm256_set1_ps(0x1.555e66p-3f), b,
                                                                   _mm256_set1_ps(0x1.fffdb6p-2f))),
                                   u, _mm256_mul_ps(_mm256_set1_ps(0x1.ffffecp-1f), b));
  if (!_mm256_movemask_ps(_mm256_castsi256_ps(c)))
    return _mm256_fmadd_ps(j, k, k);
  const __m256i g = _mm256_and_si256(
      _mm256_castps_si256(_mm256_cmp_ps(n, _mm256_setzero_ps(), _CMP_LE_OQ)),
      _mm256_set1_epi32(0x82000000u));
  const __m256 s1 =
      _mm256_castsi256_ps(_mm256_add_epi32(g, _mm256_set1_epi32(0x7f000000u)));
  const __m256 s2 = _mm256_castsi256_ps(_mm256_sub_epi32(e, g));
  const __m256i d = _mm256_castps_si256(
      _mm256_cmp_ps(_mm256_andnot_ps(_mm256_set1_ps(-0.f), n),
                    _mm256_set1_ps(192), _CMP_GT_OQ));
  return _mm256_or_ps(
      _mm256_and_ps(_mm256_castsi256_ps(d), _mm256_mul_ps(s1, s1)),
      _mm256_andnot_ps(
          _mm256_castsi256_ps(d),
          _mm256_or_ps(
              _mm256_and_ps(_mm256_castsi256_ps(c),
                            _mm256_mul_ps(_mm256_fmadd_ps(s2, j, s2), s1)),
              _mm256_andnot_ps(_mm256_castsi256_ps(c), _mm256_fmadd_ps(k, j, k)))));
}
```

#### 1.1.1 ‰ª£Á†ÅÁî®ÈÄî

* **ÂäüËÉΩ**ÔºöÂØπËæìÂÖ•ÁöÑ 8 ‰∏™ÂçïÁ≤æÂ∫¶ÊµÆÁÇπÊï∞Ôºà`__m256` ÂØÑÂ≠òÂô®ÔºâÂπ∂Ë°åÂú∞ËÆ°ÁÆóÂÆÉ‰ª¨ÁöÑÊåáÊï∞ÂáΩÊï∞ `exp(x)` ÁöÑËøë‰ººÂÄº„ÄÇ
* **ËÉåÊôØ**ÔºöÂú®Ê∑±Â∫¶Â≠¶‰π†Êé®ÁêÜ„ÄÅÊï∞ÂÄº‰ºòÂåñÊàñÁâ©ÁêÜ‰ªøÁúüÁ≠âÈ¢ÜÂüüÔºåËÆ°ÁÆóÊåáÊï∞ÂáΩÊï∞ÊòØ‰∏Ä‰∏™ÊûÅÂÖ∂Â∏∏ËßÅ‰∏îÂºÄÈîÄËæÉÂ§ßÁöÑÊìç‰Ωú„ÄÇ‰∏∫‰∫ÜÊèêÈ´òÊÄßËÉΩÔºåÂæÄÂæÄÈúÄË¶ÅÂà©Áî® SIMD Êåá‰ª§ÔºàÂ¶Ç AVX/AVX2/AVX512ÔºâÂú®ÊØè‰∏™Êåá‰ª§Âë®ÊúüÂÜÖÂêåÊó∂Â§ÑÁêÜÂ§ö‰∏™ÊµÆÁÇπÊï∞„ÄÇ`v_expf` Ê≠£ÊòØ‰∏Ä‰∏™Âü∫‰∫é AVX2 Âíå FMA Êåá‰ª§ÈõÜÁöÑÂêëÈáèÂåñ `exp(x)` ÂÆûÁé∞ÔºåÂÆÉÈÄöËøá‰ª•‰∏ãÊñπÊ≥ïÂèñÂæóÈÄüÂ∫¶‰∏éÁ≤æÂ∫¶ÁöÑÂπ≥Ë°°Ôºö

  1. **ËåÉÂõ¥Á∫¶ÁÆÄÔºàRange ReductionÔºâ**ÔºöÂ∞Ü `x` ÂàÜËß£‰∏∫ $x = n \ln 2 + r$ÔºåÂÖ∂‰∏≠ $n$ ÊòØ‰∏Ä‰∏™Êï¥Êï∞ÔºàËøë‰ººÔºâÔºå$r$ ÊòØ‰∏Ä‰∏™Â∞èÊÆãÂ∑ÆÔºå‰øùËØÅ $|r|$ Âú®‰∏ÄÂÆöËåÉÂõ¥ÂÜÖÔºàÂ¶Ç $[-0.5\ln2, +0.5\ln2]$Ôºâ„ÄÇËøôÊ†∑ÂèØ‰ª•Êää $e^x = 2^n \cdot e^r$ ÂàÜËß£Êàê‚Äú2 ÁöÑÊï¥Êï∞Ê¨°ÂπÇ‚Äù‰πò‰ª•‚ÄúÊÆãÂ∑ÆÊåáÊï∞‚Äù„ÄÇ
  2. **Âü∫‰∫éÊµÆÁÇπË°®Á§∫ÊûÑÈÄ† $2^n$**ÔºöÂà©Áî® IEEE 754 ÂçïÁ≤æÂ∫¶ÊµÆÁÇπÊï∞ÁöÑ‰ΩçÂüüÁªìÊûÑÔºåÈÄöËøáÊääÊï¥Êï∞ $n$ ÊîæÂà∞ÊåáÊï∞‰ΩçÔºàÂ∑¶Áßª 23 ‰ΩçÔºâÊù•ÂæóÂà∞ $\mathrm{float}(2^n)$„ÄÇ
  3. **Â§öÈ°πÂºèËøë‰ºº**ÔºöÈíàÂØπ $r$ ÁöÑËæÉÂ∞èËåÉÂõ¥ÔºåÁî®‰ΩéÈò∂Â§öÈ°πÂºèÔºàÈÄöÂ∏∏Âú® 4\~6 Èò∂‰πãÈó¥ÔºâÊù•Ëøë‰ººËÆ°ÁÆó $e^r$Ôºå‰ªéËÄå‰øùËØÅÊï¥‰ΩìÁ≤æÂ∫¶Âú®Âá†‰∏™ ulp ‰ª•ÂÜÖ„ÄÇ
  4. **ÁâπÊÆäÊÉÖÂÜµÂ§ÑÁêÜ**ÔºöÊ£ÄÊµãÊòØÂê¶Âá∫Áé∞‰∏ä‰∏ãÊ∫¢Ôºà`n` ËøáÂ§ßÊàñËøáÂ∞èÔºâÔºåÂπ∂ÂÅöÁõ∏Â∫îÂ§ÑÁêÜÔºåÈÅøÂÖç‰∫ßÁîü NaN ÊàñÊó†ÊïàÊï∞ÂÄº„ÄÇ

#### 1.1.2 ÂÖ≥ÈîÆÂÆûÁé∞Ê≠•È™§

1. **ËÆ°ÁÆóËøë‰ººÁöÑ $n = \lfloor x / \ln 2 \rceil$**

   ```cpp
   const __m256 r = _mm256_set1_ps(0x1.8p23f);
   // 0x1.715476p+0f ÊòØÂ∏∏Êï∞ C ‚âà 1 / ln(2) ÁöÑÂçïÁ≤æÂ∫¶Ëøë‰ºº
   const __m256 z = _mm256_fmadd_ps(x, _mm256_set1_ps(0x1.715476p+0f), r);
   const __m256 n = _mm256_sub_ps(z, r);
   ```

   * `_mm256_fmadd_ps(x, C, r)` Áõ∏ÂΩì‰∫é `x * C + r`ÔºåÂÖ∂‰∏≠ `C = 1/ln(2)`„ÄÇÂõ†‰∏∫ `r` ÊòØÈùûÂ∏∏Â§ßÁöÑÂÅèÁßªÂ∏∏Êï∞ $2^{23}$ Á∫ßÂà´ÔºåÂà©Áî®ÊµÆÁÇπËàçÂÖ•ÁöÑ‚ÄúÊà™Êñ≠‚ÄùÁâπÊÄßÔºåÂ∞±ÂèØ‰ª•Âú®Âä†Ê≥ïËøáÁ®ã‰∏≠Êää `x*C + r` ÁöÑÂ∞èÊï∞ÈÉ®ÂàÜÊà™Êñ≠ÔºåÂæóÂà∞Ëøë‰ººÁöÑÊï¥Êï∞ÈÉ®ÂàÜ $\tilde{n} = \mathrm{round}(x / \ln 2)$„ÄÇÊúÄÂêéÂÜçÂáèÂéªÂêåÊ†∑ÁöÑ `r`ÔºåÂ∞±ÂæóÂà∞ÂçïÁ≤æÂ∫¶Ë°®Á§∫ÁöÑ $\tilde{n}$„ÄÇ
   * ËøôÊ†∑ÂæóÂà∞ÁöÑ `n` ÂÆûÈôÖ‰∏äÊòØ‰ª• ‚ÄúÊµÆÁÇπÊï∞‚Äù ÂΩ¢ÂºèÂ≠òÂÇ®ÁöÑÊï¥Êï∞Ëøë‰ººÔºå‰ΩÜÂêéÈù¢ÊääÂÆÉÂΩì‰Ωú integer Êù•Áî®„ÄÇ

2. **ÊûÑÈÄ†Êï¥Êï∞ $n$ ÂØπÂ∫îÁöÑÊåáÊï∞‰Ωç $e = n << 23$ Âπ∂ÁîüÊàê $k = 2^n$**

   ```cpp
   const __m256i e = _mm256_slli_epi32(_mm256_castps_si256(z), 23);
   const __m256 k = _mm256_castsi256_ps(
       _mm256_add_epi32(e, _mm256_castps_si256(_mm256_set1_ps(1))));
   ```

   * ÂÖàÊää `z`ÔºàÂç≥ÂéüÂßãÁöÑ `x*C + r`ÔºâËßÜ‰Ωú `int32`ÔºåÂ∞ÜÂÖ∂Â∑¶Áßª 23 ‰ΩçÔºåÂ∞±ÂæóÂà∞‰∫Ü IEEE 754 ÂçïÁ≤æÂ∫¶ÊµÆÁÇπÊï∞‰∏≠ÊåáÊï∞ÂüüÂØπÂ∫îÁöÑÊØîÁâπ„ÄÇÊ≥®ÊÑèËøôÈáå `z` ÁöÑÂ∞æÊï∞ÈÉ®ÂàÜÂ∑≤ÁªèËøë‰ºº‰∏∫Êï¥Êï∞ÔºàÈÄöËøáÂºïÂÖ•Â§ßÂÅèÁßªÈáè `r` ÂÆûÁé∞ÔºâÔºåÂõ†Ê≠§Â∑¶ÁßªÂêéÊ≠£Â•ΩÂØπÂ∫î $2^n$ Âú®ÊµÆÁÇπË°®Á§∫‰∏≠ÊåáÊï∞‰ΩçÁöÑÂ∏ÉÁΩÆ„ÄÇÊúÄÂêéÂÜç `+1`ÔºàÁî® `_mm256_set1_ps(1)` ËΩ¨Êàê‰ΩçÂõæÂêéÂä†ÔºâÊòØÂõ†‰∏∫ÊµÆÁÇπÊï∞ÁöÑÊåáÊï∞Êúâ‰∏Ä‰∏™‚ÄúÂÅèÁΩÆ‚Äù127ÔºåÂÖ∑‰ΩìÂä† 1 ÊòØ‰∏∫‰∫ÜÊäµÊ∂àÂÅèÁΩÆÔºå‰ΩøÂæóÊúÄÁªàÁöÑÊåáÊï∞Ê≠£Á°ÆÂú∞Ë°®Ëææ $2^n$„ÄÇ
   * ÊúÄÂêéÁî® `_mm256_castsi256_ps` ÊääÊï¥Êï∞‰ΩçÂõæÈáçÊñ∞Ëß£ÈáäÂõûÂçïÁ≤æÂ∫¶ÊµÆÁÇπÊï∞ÔºåËøôÊ†∑ `k` Â∞±ÊòØ‰∏Ä‰∏™ÂêëÈáèÔºåÂåÖÂê´‰∫ÜÂØπÂ∫îÊØè‰∏™ËæìÂÖ•ÂàÜÈáè‰∏äÁöÑ $2^{n_i}$„ÄÇ

3. **ËÆ°ÁÆóÊÆãÂ∑Æ $r$ ÂØπÂ∫îÁöÑÂ§öÈ°πÂºèËøë‰ººÈÉ®ÂàÜ $e^r$**

   > ËøôÈáå‰∏∫‰∫ÜÁÆÄÂåñËØªÊ≥ïÔºåÊàë‰ª¨ÊääÂ§öÈ°πÂºèËøë‰ººÈÉ®ÂàÜÁß∞‰Ωú `P(r)`„ÄÇÂú®‰ª£Á†Å‰∏≠Ôºå`b`„ÄÅ`u=b^2` ‰ª•Âèä `j` Â∞±ÊòØÁî®‰∫éÈÄêÈ°πËÆ°ÁÆóÂ§öÈ°πÂºèÁöÑÂêÑ‰∏™ÂàÜÈáè„ÄÇ

   * È¶ñÂÖàËÆ°ÁÆóÊÆãÂ∑Æ `b`ÔºàÂÆûÈôÖ‰∏äÊòØÊää $r = x - n \ln 2$ Ëøë‰ººÂ±ïÂºÄÂà∞‰∏ÄÂÆöÁ≤æÂ∫¶ÔºâÔºö

     ```cpp
     const __m256 b = _mm256_fnmadd_ps(n, _mm256_set1_ps(0x1.7f7d1cp-20f),
                                       _mm256_fnmadd_ps(n, _mm256_set1_ps(0x1.62e4p-1f), x));
     ```

     ËøôÈáå‰ΩøÁî®‰∫Ü‰∏§‰∏™Â∏∏Êï∞Ôºö

     * `0x1.62e4p-1f ‚âà ln(2)` ÁöÑËøë‰ººÂÄº„ÄÇ
     * `0x1.7f7d1cp-20f ‚âà (ln(2) - ‰∏äÈù¢ln2Ëøë‰ºº) ÁöÑÂæÆÂ∞è‰øÆÊ≠£`ÔºåÁî®‰∫éÊèêÈ´òÂ±ïÂºÄÁ≤æÂ∫¶„ÄÇ
     * `fnmadd_ps(a,b,c) = -(a*b) + c`ÔºåÂÄüÂä© FMA Êåá‰ª§‰∏ÄÊ¨°ÊÄßÂÆåÊàêÊÆãÂ∑ÆÁöÑÂ§öÊ¨°Á¥ØÂáèÔºåÁõ¥Êé•ÂæóÂà∞Á≤æÂ∫¶Êõ¥È´òÁöÑ $ r = x - n \ln 2$„ÄÇ

   * Êé•ÁùÄÂºïÂÖ• `u = b * b`ÔºåÂπ∂Áî®‰∏ÄÊÆµ 4\~5 Ê¨°Â§öÈ°πÂºèÊù•Ëøë‰ºº $\exp(b)$„ÄÇÂÖ∑‰ΩìÂÅöÊ≥ïÔºö

     ```cpp
     const __m256 u = _mm256_mul_ps(b, b);
     const __m256 j = _mm256_fmadd_ps(
                        _mm256_fmadd_ps(
                          _mm256_fmadd_ps(_mm256_set1_ps(0x1.0e4020p-7f), b, _mm256_set1_ps(0x1.573e2ep-5f)),
                          u,
                          _mm256_fmadd_ps(_mm256_set1_ps(0x1.555e66p-3f), b, _mm256_set1_ps(0x1.fffdb6p-2f))
                        ),
                        u,
                        _mm256_mul_ps(_mm256_set1_ps(0x1.ffffecp-1f), b)
                      );
     ```

     * Ëøô‰∫õÂçÅÂÖ≠ËøõÂà∂ÊµÆÁÇπÂ∏∏Êï∞ÔºàÂ¶Ç `0x1.0e4020p-7f` Á≠âÔºâÈÉΩÊòØÁ≤æÂøÉÊåëÈÄâÁöÑÁ≥ªÊï∞ÔºåÁî®‰∫éÊûÑÈÄ†ÈíàÂØπÊÆãÂ∑Æ $b$ ËåÉÂõ¥ÂÜÖÔºàÈÄöÂ∏∏ $- \ln 2/2 \le b \le + \ln 2/2$ÔºâÁöÑÂ§öÈ°πÂºèËøë‰ºº„ÄÇ
     * `j` ÊúÄÁªàÂ∞±ÊòØ $\exp(b) - 1$ ÁöÑÊüêÁßçÂ§öÈ°πÂºèËøë‰ººÔºàÊàñËÄÖÊõ¥ÂáÜÁ°ÆÂú∞ËØ¥ÔºåÊòØÂ∞Ü $\exp(b)$ ÂÜôÊàê $1 + b \cdot C_1 + b^2 \cdot C_2 + \dots$ ÂΩ¢ÂºèÔºåÂÜçÁî® Horner Ê≥ïÂπ∂Ë°åËÆ°ÁÆóÂæóÂà∞Ôºâ„ÄÇ
     * Ëøë‰ººÁöÑÁªìÊûúÂ¶ÇÊûúËÆ∞‰Ωú $P(b)$ÔºåÈÇ£‰πà $\exp(b) \approx 1 + P(b)$„ÄÇ‰∏çËøáÁî±‰∫éÂÖ∑‰ΩìÂÜôÊ≥ïÂíåÂ∏∏Êï∞‰ΩøÁî®ÊñπÂºèÁï•ÊúâÂ∑ÆÂºÇÔºå‰ª£Á†ÅÈáåÂÆûÈôÖÂæóÂà∞ÁöÑ `j` Áõ¥Êé•ÂèØ‰ª•Áî®‰∫éÂêéÁª≠‰∏éÂü∫ÂáÜ $k=2^n$ Áõ∏‰πòÔºåÂæóÂà∞ÂÆåÊï¥ÁöÑ $\exp(x)$ Ëøë‰ºº„ÄÇ

4. **Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÂÅö‰∏ä‰∏ãÊ∫¢ÊàñÂ§ßËæìÂÖ•ÂàÜÊîØ**

   ```cpp
   const __m256i c = _mm256_castps_si256(
       _mm256_cmp_ps(_mm256_andnot_ps(_mm256_set1_ps(-0.f), n),
                     _mm256_set1_ps(126), _CMP_GT_OQ));
   if (!_mm256_movemask_ps(_mm256_castsi256_ps(c)))
     return _mm256_fmadd_ps(j, k, k);
   ```

   * ËøôÈáåÂÖàÊää `n`ÔºàÁªèËøá‰∏ä‰∏ÄÈò∂ÊÆµÁöÑÊï¥Êï∞Ëøë‰ººÔºâÂèñÁªùÂØπÂÄºÔºà`andnot` Ê∏ÖÁ¨¶Âè∑‰ΩçÔºâÔºåÁÑ∂Âêé‰∏éÂ∏∏Êï∞ `126` ÂÅöÊØîËæÉ„ÄÇÂ¶ÇÊûú $|n| <= 126$ÔºåËØ¥ÊòéÊåáÊï∞‰∏ç‰ºöÂ§™Â§ßÔºå‰πü‰∏ç‰ºö‰∏ãÊ∫¢Âà∞Ê¨°Ê≠£Â∏∏Êï∞ÔºåÂ∞±ÂèØ‰ª•Áõ¥Êé•Ëµ∞‚ÄúÊôÆÈÄöË∑ØÂæÑ‚ÄùÔºö

     $$
       \exp(x) \approx (1 + j) \times k = k + j \cdot k„ÄÇ
     $$

     ËÄå `j` Êú¨Ë∫´ÂÖ∂ÂÆûÊòØ $\exp(b) - 1$ ÁöÑËøë‰ººÔºåÊâÄ‰ª• $\exp(x) = 2^n \cdot \exp(b) \approx k \cdot (1 + j)$„ÄÇËøôÊÆµÈÄöËøá

     ```cpp
     return _mm256_fmadd_ps(j, k, k);
     ```

     ‰∏ÄÊ≠•ËÆ°ÁÆóÂÆåÊàê„ÄÇ

   * Â¶ÇÊûú $|n| > 126$ÔºåÂàôÂèØËÉΩÂ≠òÂú®‰∏ä‰∏ãÊ∫¢ÊàñÊûÅÁ´ØÊÉÖÂÜµÔºåÈúÄË¶ÅÂÅöÈ¢ùÂ§ñÂàÜÊîØÂ§ÑÁêÜ„ÄÇÊ≠§Êó∂Ôºö

     1. ÂÖàÊ†πÊçÆ `n` ÁöÑÁ¨¶Âè∑Âà§Êñ≠ÊòØ‚ÄúÂ§™Â∞è‚Äù‰∏ãÊ∫¢Ôºà$x$ ËøáÂ∞èÂØºËá¥ $\exp(x)$ ËøúÂ∞è‰∫é `FLT_MIN`ÔºâËøòÊòØ‚ÄúÂ§™Â§ß‚Äù‰∏äÊ∫¢Ôºà$x$ ËøáÂ§ßÂèØËÉΩ $\exp(x)$ > `FLT_MAX`Ôºâ„ÄÇÁî®‰∏ãÈù¢ÁöÑ `g`ÔºåÂæóÂà∞‰∏Ä‰∏™Êé©Á†ÅÔºö

        ```cpp
        const __m256i g = _mm256_and_si256(
            _mm256_castps_si256(_mm256_cmp_ps(n, _mm256_setzero_ps(), _CMP_LE_OQ)),
            _mm256_set1_epi32(0x82000000u));
        ```

        * Â¶ÇÊûú `n <= 0`ÔºåÂàôÂØπÂ∫îÊåáÊï∞‰∏ãÊ∫¢ÁöÑÂ§ÑÁêÜÊ†áÂøóÊé©Á†ÅÔºõÂê¶Âàô‰∏∫ÊåáÊï∞‰∏äÊ∫¢ÁöÑÂ§ÑÁêÜÊ†áÂøóÊé©Á†Å„ÄÇÊé•‰∏ãÊù•ÁöÑ `s1`„ÄÅ`s2` ÈÉΩ‰ºö‰æùÊçÆ `g` ËÄåÂèëÁîü‰∏çÂêåÂ§ÑÁêÜ„ÄÇ

     2. ÊûÑÈÄ† `s1`„ÄÅ`s2`Ôºö

        ```cpp
        const __m256 s1 = _mm256_castsi256_ps(_mm256_add_epi32(g, _mm256_set1_epi32(0x7f000000u)));
        const __m256 s2 = _mm256_castsi256_ps(_mm256_sub_epi32(e, g));
        ```

        * `0x7f000000` ÂØπÂ∫îÊµÆÁÇπÊï∞ `+1.0f` ÁöÑÊåáÊï∞ÂÅèÁΩÆÈÉ®ÂàÜÔºåÂ¶ÇÊûú `g` Ê†áËÆ∞‰∫Ü‚Äú‰∏ãÊ∫¢‚ÄùÔºåÈÇ£‰πà `s1` Â∞±ÊòØ‰∏Ä‰∏™ÈùûÂ∏∏Â∞èÁöÑÊ¨°Ê≠£Â∏∏Êï∞ÔºõÂ¶ÇÊûúÊ†áËÆ∞‰∫Ü‚Äú‰∏äÊ∫¢‚ÄùÔºå`s1` ÂàôÊòØ‰∏Ä‰∏™Êó†ÈôêÂ§ßÔºàÊàñÊé•ËøëÊúÄÂ§ßÔºâÁöÑÊï∞„ÄÇ
        * `s2 = 2^n / s1`ÔºåÁî®Êù•Â∞ÜËøáÂ§ßÊàñËøáÂ∞èÁöÑÊåáÊï∞ÁªìÊûúÂàÜÊ≠•Áõ∏‰πò/ÂàÜÂùóÔºå‰ª•ÈÅøÂÖç‰∏ÄÊ¨°ÊÄßÁõ∏‰πòÂØºËá¥Ê∫¢Âá∫„ÄÇ

     3. ÂÜçÊ†πÊçÆ `|n| > 192` ÂÅö‰∏ÄÊ¨°Êõ¥ÊûÅÁ´ØÊÉÖÂÜµÁöÑÂà§Êñ≠ÔºåÂÜ≥ÂÆöÊòØÂê¶Áõ¥Êé•ËæìÂá∫ $\exp(x)$ ‰∏∫‰∏ÄÂØπÁâπÊÆäÂÄºÔºö

        ```cpp
        const __m256i d = _mm256_castps_si256(
            _mm256_cmp_ps(_mm256_andnot_ps(_mm256_set1_ps(-0.f), n),
                          _mm256_set1_ps(192), _CMP_GT_OQ));
        ```

        * Â¶ÇÊûú $|n| > 192$ÔºåÂàô `d` Êé©Á†Å‰∏∫ÁúüÔºåÊ≠§Êó∂ÂèØ‰ª•ËÆ§‰∏∫ $\exp(x)$ Â∑≤Áªè‚ÄúÂΩªÂ∫ï‰∏äÊ∫¢‚ÄùÊàñ‚ÄúÂΩªÂ∫ï‰∏ãÊ∫¢‚ÄùÔºåÁõ¥Êé•ËøîÂõû `(s1 * s1)` ‰Ωú‰∏∫ÁªìÊûúÔºàË¶Å‰πàÊòØ 0ÔºåË¶Å‰πàÊòØ +InfÔºâ„ÄÇ
        * Âê¶ÂàôÔºåÂàÜ‰∏âÁßçÊÉÖÂÜµÁªÑÂêàËµ∑Êù•ÔºåËøîÂõûÔºö

          1. Â¶ÇÊûú `|n|>192`Ôºö`return s1 * s1` ÔºàÂΩªÂ∫ïÊ∫¢Âá∫/‰∏ãÊ∫¢Ôºâ
          2. Âê¶Âàô If `|n|>126`ÔºöËøîÂõû `(2^n / s1) * (1 + j) * s1 = 2^n * (1 + j)`ÔºåÂç≥ÂÖàÁî® `s2 = 2^n / s1`ÔºåÂÜç‰∏é `(1 + j)` Áõ∏‰πòÔºåÊúÄÂêéÂÜç‰πò‰ª• `s1`„ÄÇËøôÊ†∑ÁöÑÂàÜÊ≠•Áõ∏‰πòÂèØ‰ª•Èôç‰ΩéÂ≥∞ÂÄºÊï∞ÂÄºÔºåÈÅøÂÖç‰∏ÄÊ¨°ÊÄßÁõ∏‰πòÁõ¥Êé•Ê∫¢Âá∫„ÄÇ
          3. Âê¶ÂàôÔºà‰πüÂ∞±ÊòØÊúÄÂàù `|n| <= 126`ÔºâÔºåËøîÂõû `(1+j)*k`Ôºå‰πüÂ∞±ÊòØ‚ÄúÊôÆÈÄöË∑ØÂæÑ‚Äù„ÄÇ

   * ÊúÄÁªàÈÄöËøá‰∏ÄÁ≥ªÂàó‰ΩçËøêÁÆóÂíåÊé©Á†ÅÔºåÂêàÂπ∂ÂêéÂç≥ÂèØÂæóÂà∞ÊâÄÊúâ 8 ‰∏™ÂÖÉÁ¥†ÁöÑ $\exp(x)$ Ëøë‰ººÂÄº„ÄÇ

ÊÄª‰ΩìËÄåË®ÄÔºå`v_expf` Âà©Áî®‰∫Ü IEEE 754 ÁöÑ‚ÄúÂä†Â§ßÂ∏∏Êï∞ÂêéÊà™Êñ≠‚ÄùÊäÄÂ∑ßÊääÊµÆÁÇπ‰πòÊ≥ï/Âä†Ê≥ïÁªÑÂêàÊàêÂø´ÈÄüÁöÑ‚ÄúÊ±ÇÊï¥Êï∞Ëøë‰ºº $n$‚ÄùÊìç‰ΩúÔºåÁÑ∂ÂêéÂÜçÁî®‰ΩçËøêÁÆóÂø´ÈÄüÊûÑÈÄ† $2^n$ÔºõÂâ©‰∏ãÁöÑÈÉ®ÂàÜÁî®Â§öÈ°πÂºèËøë‰ººÊÆãÂ∑ÆÊåáÊï∞„ÄÇÊúÄÁªàÂæóÂà∞‰∏Ä‰∏™ÂÖºÈ°æÈÄüÂ∫¶ÂíåÁ≤æÂ∫¶ÁöÑÂêëÈáèÂåñ `exp(x)` ÂÆûÁé∞„ÄÇ

---

### 1.2 `v_gelu`ÔºöÂπ∂Ë°åËÆ°ÁÆó GELU ÊøÄÊ¥ª

GELUÔºàGaussian Error Linear UnitÔºâÊòØ‰∏ÄÁßçÂ∏∏Áî®ÁöÑÊøÄÊ¥ªÂáΩÊï∞ÔºåÂÆö‰πâ‰∏∫Ôºö

$$
  \mathrm{GELU}(x) \;=\; x \,\Phi(x)\;=\; x \,\frac{1 + \mathrm{erf}\bigl(x/\sqrt{2}\bigr)}{2}\;,
$$

ÊàñËÄÖÂú®Ê∑±Â∫¶Â≠¶‰π†‰∏≠Â∏∏ËßÅÁöÑËøë‰ººÂΩ¢ÂºèÔºö

$$
  \mathrm{GELU}(x) \approx 0.5\, x \, \bigl(1 + \tanh\bigl(\sqrt{2/\pi}(x + 0.044715\,x^3)\bigr)\bigr).
$$

Âè¶‰∏ÄÁßçÁ≠â‰ª∑‰∏îÊõ¥ÂÆπÊòìÂêëÈáèÂåñÁöÑË°®ËææÊòØÈÄöËøá‚Äúsigmoid‚ÄùÊù•Ëøë‰ººÔºö

$$
  \mathrm{GELU}(x) \approx x \times \mathrm{sigmoid}\bigl(\alpha\,x + \beta\,x^3\bigr),
$$

ÂÖ∂‰∏≠Â∏∏ËßÅÁöÑÁ≥ªÊï∞‰∏∫ $\alpha = \sqrt{2/\pi},\, \beta = 0.044715$„ÄÇÁî±‰∫é $\displaystyle \mathrm{sigmoid}(u) = \tfrac{e^u}{1 + e^u}$ÔºåÂ∞±ÂèØ‰ª•ËΩ¨Âåñ‰∏∫ÊåáÊï∞ÂáΩÊï∞ÁöÑËÆ°ÁÆóÔºå‰ªéËÄåÂà©Áî®ÂâçÈù¢ÂÆûÁé∞ÁöÑ `v_expf` Êù•ÂÅöÂπ∂Ë°å„ÄÇ

‰ª£Á†Å‰∏≠ÂàÜÂà´ÁªôÂá∫‰∫ÜÂØπ 256 ‰ΩçÔºà8 ‰∏™ floatÔºâÁöÑ `v_gelu(__m256, c1, c2)` ÂíåÂØπ 512 ‰ΩçÔºà16 ‰∏™ floatÔºâÁöÑ `v_gelu(__m512, c1, c2)` ‰∏§‰∏™ÁâàÊú¨„ÄÇ‰∏ãÈù¢Âè™ËØ¶ÁªÜËß£Èáä 256 ‰ΩçÁâàÊú¨Ôºõ512 ÁâàÊú¨ÊÄùË∑ØÁõ∏ÂêåÔºåÂè™ÊòØÊç¢Êàê‰∫Ü AVX-512 ÂØπÂ∫îÁöÑÊåá‰ª§ÂíåÊé©Á†ÅÁ±ªÂûã„ÄÇ

```cpp
static inline __m256 v_gelu(__m256 x, __m256 c1, __m256 c2) {
    const __m256 one = _mm256_set1_ps(1.0f);
    // mask = (x > 10)
    const __m256 mask = _mm256_cmp_ps(x, _mm256_set1_ps(10.f), _CMP_GT_OQ);

    // arg = (1 + c1 * x^2) * (x * c2)
    __m256 arg = _mm256_add_ps(one, _mm256_mul_ps(_mm256_mul_ps(x, x), c1));
    arg = _mm256_mul_ps(arg, _mm256_mul_ps(x, c2));

    // exp_arg = exp(arg)
    __m256 exp_arg = v_expf(arg);

    // gelu = x * [ exp(arg) / (exp(arg) + 1) ]
    __m256 gelu = _mm256_mul_ps(x, _mm256_div_ps(exp_arg, _mm256_add_ps(exp_arg, one)));

    // ÂØπ‰∫é x>10 ÁöÑÂÖÉÁ¥†ÔºåÁõ¥Êé•ËÆ© gelu = x ÔºàÂõ†‰∏∫Ê≠§Êó∂ sigmoid(arg) ‚âà 1ÔºåGELU(x) ‚âà xÔºâ
    return _mm256_or_ps(_mm256_and_ps(mask, x), _mm256_andnot_ps(mask, gelu));
}
```

#### 1.2.1 ‰ª£Á†ÅÁî®ÈÄî

* **ÂäüËÉΩ**ÔºöÂØπÈïøÂ∫¶‰∏∫ 8 ÁöÑÊµÆÁÇπÊï∞ÂêëÈáè `x`ÔºåÂπ∂Ë°åÂú∞ËÆ°ÁÆóËøë‰ººÁöÑ GELU ÊøÄÊ¥ªÁªìÊûúÔºåÂæóÂà∞‰∏Ä‰∏™ÈïøÂ∫¶‰πü‰∏∫ 8 ÁöÑÂêëÈáèËæìÂá∫„ÄÇ
* **ÂéüÁêÜ**Ôºö

  1. ÂÖàÂà©Áî®Â∏∏Êï∞ `c1 = 0.044715f` Âíå `c2 = 2*sqrt(2/œÄ)` ÊûÑÈÄ†‰∏≠Èó¥Èáè

     $$
       \mathrm{arg} = (1 + c1 \cdot x^2)\times(c2 \cdot x)\;=\;\sqrt{\tfrac{2}{\pi}}\,x\,\bigl(1 + 0.044715\,x^2\bigr)\;,
     $$

     ÂØπÂ∫îÁöÑÊòØËøë‰ºº GELU ‰∏≠ÊîæÂà∞ `tanh` Êàñ `sigmoid` ÈáåÁöÑÈÇ£‰∏ÄÈ°π„ÄÇ
  2. ÂÜçÊää `arg` ‰º†Áªô `expf`ÔºåËÆ°ÁÆó $\exp(\mathrm{arg})$ÔºåÁÑ∂ÂêéÁî®

     $$
       \frac{\exp(\mathrm{arg})}{\exp(\mathrm{arg}) + 1}
     $$

     Êù•Ëøë‰ºº sigmoid(arg)„ÄÇÂÖ∂‰∏≠Ôºå

     $$
       \mathrm{sigmoid}(u) = \frac{1}{1 + e^{-u}} = \frac{e^u}{1 + e^u}„ÄÇ
     $$

     ‰∏§ËÄÖÁ≠â‰ª∑ÔºåÂè™ÊòØÈÄâÊã©‰∫Ü $\frac{e^u}{1 + e^u}$ ÁöÑÂΩ¢ÂºèÊù•ÈÅøÂÖçÂÅöË¥üÂè∑Êìç‰Ωú„ÄÇ
  3. ÊúÄÂêé‰ª§

     $$
       \mathrm{gelu}(x) = x \times \mathrm{sigmoid}(\mathrm{arg}) \approx x \times \frac{\exp(\mathrm{arg})}{1 + \exp(\mathrm{arg})}.
     $$
  4. ÂºïÂÖ•‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂàÜÊîØÔºöÂΩì `x > 10` Êó∂ÔºåÂõ† $\mathrm{arg} $ ‰ºöÈùûÂ∏∏Â§ßÔºå$\mathrm{sigmoid}(\mathrm{arg}) \approx 1$ÔºåÁõ¥Êé•‰ª§ `gelu = x`ÔºåÁúÅÂæóÂÜçÂéªÁÆó‰∏ÄÊ¨° `exp` ‰∏éÈô§Ê≥ïÔºåÊó¢ËäÇÁúÅÂºÄÈîÄÂèà‰øùÊåÅÁ≤æÂ∫¶ÔºàÂØπ‰∫éÂ§ß‰∫é 10 ÁöÑ `x`ÔºåGELU(x) ‰∏é `x` ÁöÑÂ∑ÆË∑ùÂèØ‰ª•ÂøΩÁï•‰∏çËÆ°Ôºâ„ÄÇ

#### 1.2.2 512-bit ÁâàÊú¨ÂØπÊØî

```cpp
static inline __m512 v_gelu(__m512 x, __m512 c1, __m512 c2) {
    const __m512 one = _mm512_set1_ps(1.0f);
    __m512 arg = _mm512_fmadd_ps(x, _mm512_mul_ps(c1, x), one);
    arg = _mm512_mul_ps(arg, _mm512_mul_ps(c2, x));
    const __mmask16 mask = _mm512_cmp_ps_mask(arg, _mm512_set1_ps(30.f), _CMP_GT_OQ);
    const __m512 exp_arg = v_expf(arg);
    const __m512 ratio = _mm512_div_ps(exp_arg, _mm512_add_ps(exp_arg, one));
    return _mm512_mul_ps(x, _mm512_mask_blend_ps(mask, ratio, one));
}
```

* ‰∏çÂêåÁÇπÔºö

  1. Áî®‰∫Ü AVX-512 ÁöÑÊé©Á†ÅÂØÑÂ≠òÂô® `__mmask16` Êù•ÂÅöÊù°‰ª∂ÂàÜÊîØÔºåÂÄºÂæóÊ≥®ÊÑèÁöÑÊòØËøôÈáåÊääÈòàÂÄº‰ªé `10.f` Êç¢Êàê‰∫Ü `30.f`„ÄÇÈÄâÊã©Êõ¥Â§ßÁöÑÊï∞‰∏ªË¶ÅÊòØÂõ†‰∏∫ AVX-512 ÁöÑÂª∂ËøüÊ®°ÂûãÔºàlatencyÔºâÂíåÂêûÂêêËÉΩÂäõ‰∏çÂêåÔºåËøô‰πàÂÅöÂèØ‰ª•ÂáèÂ∞ëÂõ†‰∏∫ËøáÊó©ËøõÂÖ•ÂàÜÊîØÂØºËá¥ÁöÑÊÄßËÉΩÊçüÂ§±„ÄÇ‰∏çËøáÊ†∏ÂøÉÈÄªËæë‰∏ÄËá¥ÔºöÂΩì `arg > 30` Êó∂Áõ¥Êé•Êää `ratio` ËÆæ‰∏∫ `1`ÔºåÁõ∏ÂΩì‰∫éËæìÂá∫ `x`ÔºõÂê¶ÂàôËæìÂá∫ `x * (exp(arg)/(1+exp(arg)))`„ÄÇ
  2. ÊâÄÊúâÁöÑ AVX2 Êåá‰ª§Êç¢Êàê‰∫Ü AVX-512 ÂØπÂ∫îÁöÑ `_mm512_*` ÁâàÊú¨ÔºåÊï∞ÊçÆÂÆΩÂ∫¶‰ªé 8 ‰∏™ float ‚Üí 16 ‰∏™ float„ÄÇ

---

## ‰∫å„ÄÅÁ¨¨‰∫åÈÉ®ÂàÜÔºö`MulMat::gelu`ÔºöÂ∞Ü‰∏äËø∞ÂêëÈáèÂåñÂáΩÊï∞Â∫îÁî®Âà∞Êï∞ÁªÑ

```cpp
#if defined(__AVX2__) && defined(__FMA__)

void MulMat::gelu(int n, const float * x, float * y) {
    constexpr float GELU_COEF_A = 0.044715f;
    constexpr float SQRT_2_OVER_PI  = 0.79788456080286535587989211986876f;
    int i = 0;

#if defined __AVX512F__ && defined __AVX512DQ__
    {
        __m512 c1 = _mm512_set1_ps(GELU_COEF_A);
        __m512 c2 = _mm512_set1_ps(2.f*SQRT_2_OVER_PI);
        for (; i + 15 < n; i += 16)
            _mm512_storeu_ps(y + i, v_gelu(_mm512_loadu_ps(x + i), c1, c2));
    }
#endif

#if defined __AVX2__ && defined __FMA__
    if (i + 7 < n) {
        __m256 c1 = _mm256_set1_ps(GELU_COEF_A);
        __m256 c2 = _mm256_set1_ps(2.f*SQRT_2_OVER_PI);
        for (; i + 7 < n; i += 8)
            _mm256_storeu_ps(y + i, v_gelu(_mm256_loadu_ps(x + i), c1, c2));
    }
#endif

    for (; i < n; ++i)
        y[i] = 0.5f * x[i] * (1.0f + tanhf(SQRT_2_OVER_PI * x[i] * (1.0f + GELU_COEF_A * x[i] * x[i])));
}
```

### 2.1 ‰ª£Á†ÅÁî®ÈÄî

* **ÂäüËÉΩ**ÔºöÂØπÈïøÂ∫¶‰∏∫ `n` ÁöÑËæìÂÖ•ÊµÆÁÇπÊï∞ÁªÑ `x`ÔºåËÆ°ÁÆóÂØπÂ∫îÁöÑ GELU ÊøÄÊ¥ªÔºåÂπ∂Â∞ÜÁªìÊûúÂÜôÂÖ• `y`„ÄÇÂÖ∂‰∏≠ `n` ÂèØ‰ª•ÊòØ‰ªªÊÑèÈïøÂ∫¶ÔºàÈÄöÂ∏∏ÊòØÁ•ûÁªèÁΩëÁªú‰∏≠Êüê‰∏ÄÂ±ÇÂêëÈáèÊàñÊâπÈáèËäÇÁÇπÁöÑÈïøÂ∫¶ÔºâÔºåË¶ÅÊ±ÇÂ∞ΩÈáèÊâπÈáèÂπ∂Ë°åÂåñ„ÄÇ
* **Á°¨‰ª∂‰æùËµñ**Ôºö

  * Â¶ÇÊûúÊú∫Âô®ÊîØÊåÅ AVX-512Ôºà`__AVX512F__ && __AVX512DQ__`ÔºâÔºåÂ∞±‰ºòÂÖà‰ΩøÁî® 512 ‰ΩçÂØÑÂ≠òÂô®Ôºå‰∏ÄÊ¨°Â§ÑÁêÜ 16 ‰∏™ÂÖÉÁ¥†ÔºåË∞ÉÁî® `v_gelu(__m512, c1, c2)`„ÄÇ
  * Âê¶ÂàôÔºåÂ¶ÇÊûúÊîØÊåÅ AVX2 + FMAÔºåÂ∞±ÈÄÄËÄåÊ±ÇÂÖ∂Ê¨°‰ΩøÁî® 256 ‰ΩçÂØÑÂ≠òÂô®Ôºå‰∏ÄÊ¨°Â§ÑÁêÜ 8 ‰∏™ÂÖÉÁ¥†ÔºåË∞ÉÁî® `v_gelu(__m256, c1, c2)`„ÄÇ
  * ÊúÄÂêéÂØπ‰∫éÂâ©‰Ωô‰∏çË∂≥ 8 ‰∏™ÔºàÊàñ 16 ‰∏™ÔºâÁöÑ‚ÄúÂ∞æÊï∞‚ÄùÔºàtailÔºâÔºå‰ΩøÁî®Ê†áÈáè C++ ‰ª£Á†ÅË∞ÉÁî®Ê†áÂáÜÂ∫ìÁöÑ `tanhf` Êù•ËÆ°ÁÆóÁ≤æÁ°ÆÁöÑ GELUÔºà`0.5 * x * (1 + tanh(...) )`Ôºâ„ÄÇËøôÁßçÊ†áÈáèÂÆûÁé∞‰∏éÂâçÈù¢ÂêëÈáèÂåñÂÖ¨ÂºèÊòØÁ≠â‰ª∑ÁöÑÔºå‰ªÖÂú®Â∞æÈÉ®Êï∞ÈáèËæÉÂ∞ëÊó∂Êâç‰ΩøÁî®Ôºå‰øùËØÅÁªìÊûúÂáÜÁ°Æ„ÄÇ

### 2.2 ÂÖ≥ÈîÆÂÆûÁé∞ÈÄªËæë

1. **Â∏∏ÈáèÈ¢ÑÂÖàÂáÜÂ§á**

   ```cpp
   constexpr float GELU_COEF_A = 0.044715f;
   constexpr float SQRT_2_OVER_PI = 0.7978845608f; // ‚âà sqrt(2/œÄ)
   ```

   * Ëøô‰∏§‰∏™Â∏∏Êï∞Ê≠£ÊòØËøë‰ºº GELU ‰∏≠ÁöÑ $\beta$ Âíå $\sqrt{2/\pi}$ÔºåÁªìÂêàËµ∑Êù•Áî®‰∫éÊûÑÈÄ† `arg = sqrt(2/œÄ) * x * (1 + 0.044715 * x^2)`„ÄÇ

2. **AVX-512 ÁâàÊú¨‰ºòÂÖà**

   ```cpp
   #if defined __AVX512F__ && defined __AVX512DQ__
       __m512 c1 = _mm512_set1_ps(GELU_COEF_A);
       __m512 c2 = _mm512_set1_ps(2.f * SQRT_2_OVER_PI);
       for (; i + 15 < n; i += 16)
           _mm512_storeu_ps(y + i,
               v_gelu(_mm512_loadu_ps(x + i), c1, c2));
   #endif
   ```

   * Â∞Ü `c1` Âíå `c2` Ë£ÖÂà∞ 512 ‰ΩçÂêëÈáèÂ∏∏Èáè‰∏≠ÂêéÔºå‰∏ÄÊ¨°Âæ™ÁéØÂä†ËΩΩ 16 ‰∏™ËæìÂÖ• `x[i..i+15]`ÔºåË∞ÉÁî® `v_gelu(__m512, c1, c2)` Âπ∂ÊääÁªìÊûúÈÄöËøá `_mm512_storeu_ps` ÂÜôÂõû `y[i..i+15]`„ÄÇ

3. **AVX2 + FMA ÁâàÊú¨Ê¨°‰πã**

   ```cpp
   #if defined __AVX2__ && defined __FMA__
       if (i + 7 < n) {
           __m256 c1 = _mm256_set1_ps(GELU_COEF_A);
           __m256 c2 = _mm256_set1_ps(2.f * SQRT_2_OVER_PI);
           for (; i + 7 < n; i += 8)
               _mm256_storeu_ps(y + i,
                 v_gelu(_mm256_loadu_ps(x + i), c1, c2));
       }
   #endif
   ```

   * ÂΩìËøòÂâ©‰ΩôËá≥Â∞ë 8 ‰∏™ÂÖÉÁ¥†Êó∂ÔºåÂ∞±Áî® AVX2 ÁöÑ 256 ‰ΩçÂØÑÂ≠òÂô®Ôºå‰∏ÄÊ¨°Â§ÑÁêÜ 8 ‰∏™ÔºåË∞ÉÁî® 256 ‰ΩçÁâàÁöÑ `v_gelu(__m256, c1, c2)`„ÄÇ

4. **Ê†áÈáèÂ∞æÈÉ®Â§ÑÁêÜ**

   ```cpp
   for (; i < n; ++i)
       y[i] = 0.5f * x[i] * (1.0f +
                          tanhf(SQRT_2_OVER_PI *
                                x[i] *
                                (1.0f + GELU_COEF_A * x[i] * x[i])));
   ```

   * ÂΩìÂâ©‰ΩôÂÖÉÁ¥†Êï∞ÁõÆ‰∏çË∂≥ 8ÔºàÊàñ 16Ôºâ‰∏™Êó∂ÔºåÂ∞±ÈÄê‰∏™Áî®Ê†áÂáÜÂ∫ìÈáåÁöÑ `tanhf` ËÆ°ÁÆóÁ≤æÁ°ÆÂÄº„ÄÇÊ≠§ÂÖ¨ÂºèÁ≠â‰ª∑‰∫éÂêëÈáèÂåñÊó∂ÁöÑËøë‰ººÂÖ¨ÂºèÔºå‰ΩÜÂú®Â∞æÈÉ®ÂÅöÁ≤æÁ°ÆËÆ°ÁÆóÂèØ‰øùËØÅÊõ¥Â•ΩÁöÑÊï∞ÂÄºÊ≠£Á°ÆÊÄß„ÄÇ

### 2.3 ÊÄßËÉΩ‰∏éÁ≤æÂ∫¶ÊùÉË°°

* **ÊÄßËÉΩ**ÔºöÂÄüÂä© AVX2/AVX512 Êåá‰ª§ÔºåËÉΩÂ§üÊääÂéüÊú¨ÈúÄË¶ÅÂØπÊØè‰∏™ÂÖÉÁ¥†Ë∞ÉÁî® `exp`„ÄÅÂÅöÂ§öÊ¨°‰πòÂä†ÁöÑÂæ™ÁéØÂ±ïÂºÄÔºå‰∏ÄÊ¨°ÊÄßÂú®Á°¨‰ª∂ÊµÅÊ∞¥Á∫øÈáåÂπ∂Ë°åËÆ°ÁÆó 8 Êàñ 16 ‰∏™ float„ÄÇÂΩìÁ•ûÁªèÁΩëÁªú‰∏≠ÂæÄÂæÄ‰ºöÂØπ‰∏ä‰∏áÁîöËá≥‰∏äÁôæ‰∏áÁöÑÂÖÉÁ¥†ÂÅöÊøÄÊ¥ªÔºåËøôÁßç‰ºòÂåñÊÑè‰πâÈùûÂ∏∏Â§ßÔºåËÉΩÊòæËëóÂáèÂ∞ëËøêË°åÊó∂Èó¥„ÄÇ
* **Á≤æÂ∫¶**ÔºöÂêëÈáèÂåñÈÉ®ÂàÜ‰ΩøÁî®‰∫ÜËøë‰ººÂ§öÈ°πÂºèÊù•ËÆ°ÁÆó `exp`ÔºåÊâÄ‰ª•‰ºöÁï•ÂæÆÂºïÂÖ•Âá†‰∏™ ulp ÁöÑËØØÂ∑ÆÔºõ‰ΩÜÊòØÂØπ‰∫éÊ∑±Â∫¶Â≠¶‰π†‰∏≠ÁöÑÊøÄÊ¥ªÂáΩÊï∞Ôºå‰∏ÄËà¨ÂÆπÂøçÂ∫¶ËæÉÈ´òÔºõÂ∞æÈÉ®ÁöÑÁ≤æÁ°ÆÂÆûÁé∞Âàô‰øùËØÅËæπÁïåÊÉÖÂÜµ‰∏ãÔºàÂ∞è‰∫é 8 ‰∏™ÂÖÉÁ¥†Ôºâ‰∏ç‰ºöÂá∫Áé∞ÂÅèÂ∑Æ„ÄÇ
* **ÂÖºÂÆπÊÄß**ÔºöÈÄöËøá `#if defined(__AVX512F__)` Á≠âÂÆèÂà§Êñ≠ÔºåÁºñËØëÂô®‰ºöÊ†πÊçÆÂΩìÂâçÊú∫Âô®ÊòØÂê¶ÊîØÊåÅ AVX512„ÄÅAVX2„ÄÅFMA Á≠âÊåá‰ª§ÈõÜÊù•ÈÄâÊã©ÊúÄ‰ºòÁöÑË∑ØÂæÑÔºõÂ¶ÇÊûúÁ°¨‰ª∂‰∏çÊîØÊåÅÔºåËøòÊòØÂèØ‰ª•ÂõûÈÄÄÂà∞Á∫ØÊ†áÈáèÂÆûÁé∞Ôºå‰øùËØÅ‰ª£Á†ÅÂèØÁßªÊ§ç„ÄÇ

---

## ‰∏â„ÄÅÊÄªÁªì

1. **Êï¥‰ΩìÁî®ÈÄî**

   * ËøôÊÆµ‰ª£Á†ÅÁöÑÊúÄÁªàÁõÆÁöÑÊòØÂú®Êú∫Âô®ÊîØÊåÅÂêëÈáèÂåñÊåá‰ª§ÔºàAVX2/AVX512ÔºâÁöÑÂâçÊèê‰∏ãÔºåÈ´òÊïàÂπ∂Ë°åÂú∞ÂØπ‰∏ÄÂ§ßÊâπÊµÆÁÇπÊï∞ÊâßË°å GELU ÊøÄÊ¥ªÂáΩÊï∞„ÄÇGELU ÊòØ Transformer„ÄÅBERT„ÄÅGPT Á≠âÁé∞‰ª£Ê∑±Â∫¶Â≠¶‰π†Ê®°Âûã‰∏≠ÁöÑÂ∏∏ËßÅÊøÄÊ¥ªÔºåÁî®ÊôÆÈÄöÊñπÂºèËÆ°ÁÆóÈÄüÂ∫¶ÂæÄÂæÄÊàê‰∏∫Êé®ÁêÜÁì∂È¢àÔºõËÄåËøôÊÆµÂÆûÁé∞ÈÄöËøáÊâãÂÜôÁöÑ„ÄÅÂü∫‰∫é FMA ÁöÑÂêëÈáèÂåñ `exp` Ëøë‰ººÂä†‰∏äÂàÜÊîØ‰ºòÂåñÔºåÂ∞Ü GELU ÁöÑËøêË°åÈÄüÂ∫¶ÊèêÂçá‰∫ÜÊï∞ÂÄçÁîöËá≥ÂçÅ‰ΩôÂÄçÔºåÈùûÂ∏∏ÈÄÇÂêàÂú® CPU ‰∏äÂÅöÈ´òÊÄßËÉΩÊé®ÁêÜ„ÄÇ

2. **ÂÆûÁé∞ÂéüÁêÜ**

   * **`v_expf`**ÔºöÂü∫‰∫éÁªèÂÖ∏ÁöÑ‚ÄúËåÉÂõ¥Á∫¶ÁÆÄ + Â§öÈ°πÂºèËøë‰ºº + ÊµÆÁÇπ‰ΩçÂüüÊûÑÈÄ† 2^n‚ÄùÊäÄÂ∑ßÔºåÁî® AVX2/FMA Êåá‰ª§Âπ∂Ë°åËÆ°ÁÆó 8 ‰∏™ `exp(x)`„ÄÇ
   * **`v_gelu`**ÔºöÂ∞Ü GELU Ëøë‰ºº‰∏∫ $x \times \mathrm{sigmoid}(\alpha x + \beta x^3)$ÔºåÊää `sigmoid(u)` ÊîπÂÜô‰∏∫ $\exp(u) / (1 + \exp(u))$ÔºåÈÄöËøá‰∏äÈù¢ÁöÑ `v_expf` ËÆ°ÁÆóÂπ∂Áî®Êé©Á†ÅÂØπ `x > ÈòàÂÄº` ÁöÑÂàÜÈáèÂÅöÂø´ÈÄüËøë‰ºº„ÄÇ
   * **`MulMat::gelu`**ÔºöË¥üË¥£ÈÅçÂéÜ‰∏Ä‰∏™ÈïøÂ∫¶‰∏∫ `n` ÁöÑÊï∞ÁªÑÔºåÊ†πÊçÆÁ°¨‰ª∂ËÉΩÂäõÂàÜÊâπË∞ÉÁî® 512 ‰ΩçÊàñ 256 ‰ΩçÁâàÁöÑ `v_gelu`ÔºåÂ∞æÈÉ®Áî®Ê†áÈáè `tanhf` ÂÖúÂ∫ï„ÄÇ

3. **ÊÄßËÉΩ‰ºòÂåñÊâãÊ≥ï**

   * Âà©Áî® FMA Êåá‰ª§ÔºàÂ¶Ç `_mm256_fmadd_ps` Âíå `_mm512_fmadd_ps`ÔºâÔºåÊää‰πòÊ≥ï‰∏éÂä†Ê≥ïÂêàÂπ∂Âú®‰∏ÄÊù°Êåá‰ª§ÈáåÂÆåÊàêÔºåÊèêÂçáÂêûÂêêÈáè„ÄÇ
   * ÂºïÂÖ•Â§ßÂ∏∏Êï∞ÂÅèÁßªÔºà`0x1.8p23f`ÔºâÊù•ÂÅö‚Äú‰πò‰ª•Â∏∏Êï∞ + Êà™Êñ≠‚Äù‰ª•Âø´ÈÄüÂæóÂà∞Êï¥Êï∞Ëøë‰ºº $n$ÔºåÁúÅÂéª‰∫ÜË∞ÉÁî®Ê†áÂáÜÂ∫ì `floor()`„ÄÅ`round()` Á≠âÊÖ¢ÈÄüÂáΩÊï∞„ÄÇ
   * ÈÄöËøá‰ΩçËøêÁÆóÁõ¥Êé•ÊûÑÈÄ†ÊµÆÁÇπÊï∞ÁöÑÊåáÊï∞‰ΩçÔºåÈÅøÂÖç‰∫ÜË∞ÉÁî® `ldexp()` Êàñ `pow2` ‰πãÁ±ªÊõ¥ÊÖ¢ÁöÑÂ∫ìÂáΩÊï∞„ÄÇ
   * ÂØπ‰∫éÂ§ßÂπÖË∂ÖÂá∫Â∏∏ËßÑËÆ°ÁÆóËåÉÂõ¥ÁöÑ `x`ÔºåÈááÁî®ÂàÜÊîØÂàÜÊ≠•Áõ∏‰πòÊù•Èò≤Ê≠¢Ê∫¢Âá∫Êàñ‰∏ãÊ∫¢ÔºåÂêåÊó∂ÂØπÊûÅÁ´ØÊÉÖÂÜµ‚ÄúÁõ¥Êé•ËÆæ‰∏∫ Inf Êàñ 0‚Äù„ÄÇ
   * GELU Êú¨Ë∫´ÂØπÂæàÂ§ßÊï∞Ôºà>10 Êàñ >30ÔºâÊó∂Â∑≤ÁªèË∂ãËøë‰∫éÁ∫øÊÄßÔºà`y ‚âà x`ÔºâÔºåÂõ†Ê≠§Áî®ÁÆÄÂçïÁöÑÊù°‰ª∂Êé©Á†ÅÁõ¥Êé•ÊääÁªìÊûúËÆæ‰∏∫ `x`ÔºåÁúÅÂéª‰∫ÜÂØπÊûÅÁ´ØÂÄºÂÜçÂéªÁÆóÊåáÊï∞/Èô§Ê≥ïÁöÑÂºÄÈîÄ„ÄÇ

ÈÄöËøá‰ª•‰∏äÊâãÊÆµÔºåËøôÊÆµ‰ª£Á†ÅÂú®‰øùËØÅÊï∞ÂÄºËØØÂ∑ÆÂèØÊéßÁöÑÂâçÊèê‰∏ãÔºåÊúÄÂ§ßÁ®ãÂ∫¶Âú∞Âà©Áî® CPU ÁöÑÂêëÈáèÂåñËÉΩÂäõÔºåÂÆûÁé∞‰∫ÜÈ´òÊïàÁöÑÊâπÈáè GELU ËÆ°ÁÆóÔºåÊûÅÂ§ßÊèêÂçá‰∫ÜÂü∫‰∫é CPU ÁöÑÊ∑±Â∫¶Â≠¶‰π†Êé®ÁêÜÊÄßËÉΩ„ÄÇ


---

### üßë‚Äçüíª User

ËØÑ‰ª∑‰∏ãÊàëËøôÊÆµ`void MulMat::gelu`Ëøô‰∏™ÂáΩÊï∞ÂÆûÁé∞ÊïàÁéáÂ¶Ç‰ΩïÔºåÊúâÂì™‰∫õÂèØÂúàÂèØÁÇπ‰πãÂ§ÑÔºåÁõ∏ËæÉ‰∫éÊ†áÈáèÂåñÁöÑGELU(x)ÂÆûÁé∞ÔºåÊÄßËÉΩËÉΩÊèêÂçáÂ§öÂ§ßÔºü

---

### ü§ñ Assistant

‰∏ãÈù¢ÈíàÂØπ‰Ω†ËøôÊÆµ `MulMat::gelu` ÂáΩÊï∞‰ªéÂ§ö‰∏™ËßíÂ∫¶Êù•ÂÅöËØÑ‰ª∑ÔºåÈáçÁÇπËØ¥ÊòéÂÆÉÊúâÂì™‰∫õ‰ºòÂåñ‰∫ÆÁÇπÔºå‰ª•ÂèäÁõ∏ËæÉ‰∫é„ÄåÊ†áÈáèÂåñÈÄêÂÖÉÁ¥†Ë∞ÉÁî® GELU„ÄçÁöÑÂÆûÁé∞ÔºåÊÄßËÉΩËÉΩÊèêÂçáÂà∞‰ªÄ‰πàÁ®ãÂ∫¶„ÄÇ

---

## ‰∏Ä„ÄÅÊï¥‰ΩìÊÄùË∑Ø‰∏éÂÖ≥ÈîÆ‰ºòÂåñÊâãÊ≥ï

1. **ÂêëÈáèÂåñÔºàSIMDÔºâÊâπÈáèËÆ°ÁÆó**

   * Ê†∏ÂøÉÂú®‰∫éÂà©Áî® AVX2/AVX-512 Êåá‰ª§ÔºåÊØèÊ¨°ÂêåÊó∂Â§ÑÁêÜ 8 Êàñ 16 ‰∏™ `float`„ÄÇ
   * Âú®Âæ™ÁéØÈáåÁî® `_mm256_loadu_ps`Ôºè`_mm512_loadu_ps` ‰∏ÄÊ¨°Âä†ËΩΩ 8/16 ‰∏™ÂÖÉÁ¥†ÔºåÂÜçË∞ÉÁî® `v_gelu`ÔºàÂÜÖÂê´Âπ∂Ë°å `exp` Ëøë‰ººÔºâÔºåÊúÄÂêéÁî® `_mm256_storeu_ps`Ôºè`_mm512_storeu_ps` ‰∏ÄÊ¨°ÂÜôÂõûÂØπÂ∫îÁªìÊûú„ÄÇ
   * ËøôÊ†∑ÂÅöÁöÑÂä®Êú∫ÔºöÁé∞‰ª£ x86 CPU ÂØπ‰∫éÂçïÊù° AVX2 Êåá‰ª§ÁöÑÂêûÂêêÈáèÂæÄÂæÄÂú® 8‚Äì16 ‰∏™ÂçïÁ≤æÂ∫¶ÊµÆÁÇπÊï∞ÔºèÊó∂ÈíüÂë®ÊúüÔºåËÄåÊ†áÈáèÁâà‰∏ÄÊ¨°Â§ö‰πüÂ∞±ÊòØÂÅö‰∏Ä‰∏™ËøêÁÆóÔºåÂêûÂêêËøú‰Ωé‰∫éÂêëÈáèÊµÅÊ∞¥Á∫ø„ÄÇ

2. **Ëá™ÂÆö‰πâÁöÑ `exp` Ëøë‰ººÔºà`v_expf`Ôºâ‰ª£ÊõøÂ∫ìÂáΩÊï∞**

   * Ê†áÈáèÂåñÁöÑ GELU Â∏∏ËßÅÂÜôÊ≥ïÊòØ `0.5f * x * (1.0f + tanhf(‚àö(2/œÄ) * (x + 0.044715f*x¬≥)))`ÔºåÂÖ∂‰∏≠ `tanhf` Êú¨Ë∫´‰ºöÂú®ÂÜÖÈÉ®Ë∞ÉÁî®Â§öÊ¨°Ëø≠‰ª£„ÄÅÈÄêÂÖÉÁ¥†ËøêÁÆóÔºåÂæÄÂæÄ 100 Â§ö‰∏™Êó∂ÈíüÂë®ÊúüÊâçËÉΩÁÆóÂÆå‰∏Ä‰∏™ `tanhf`„ÄÇ
   * ‰Ω†ÁöÑ `v_expf` ÊòØÂÖ∏ÂûãÁöÑ„ÄåËåÉÂõ¥Á∫¶ÁÆÄ + ‰ΩçËøêÁÆóÊûÑÈÄ† 2^n + ‰ΩéÈò∂Â§öÈ°πÂºèËøë‰ººÊÆãÂ∑ÆÊåáÊï∞„ÄçÁªÑÂêàÔºö

     1. Áî®Â∏∏Êï∞ÂÅèÁßª `0x1.8p23f`„ÄÅ`1/ln2` Âø´ÈÄüÊà™Êñ≠ÂæóÂà∞Ëøë‰ººÊï¥Êï∞ `n`Ôºõ
     2. Áõ¥Êé•Êää `n` Â∑¶Áßª 23 ‰ΩçÊûÑÈÄ†ÊµÆÁÇπÊåáÊï∞ÂüüÔºåÂæóÂà∞ $2^n$Ôºõ
     3. ÂØπÂâ©‰∏ãÁöÑÊÆãÂ∑ÆÁî® 4‚Äì5 Èò∂Â§öÈ°πÂºèÂπ∂Ë°åËøë‰ºº $e^r$Ôºõ
     4. Âä†‰∏äÂØπ„Äån ËøáÂ§ßÔºèËøáÂ∞è„ÄçÁöÑÊé©Á†ÅÂàÜÊîØÔºåÈÅøÂÖçÊ∫¢Âá∫Êàñ‰∏ãÊ∫¢„ÄÇ
   * Êï¥‰ΩìÊù•ÁúãÔºå`v_expf` ÂØπ 8 ‰∏™ÂÖÉÁ¥†ÁöÑÂπ∂Ë°åÁâàÊú¨Â§ßÊ¶ÇÁéáÂè™ÈúÄË¶Å \~10‚Äì15 Êù° AVX2+FMA Êåá‰ª§Â∞±ËÉΩÂÆåÊàê‰∏ÄÊ¨°Áõ∏ÂØπÈ´òÁ≤æÂ∫¶ÁöÑ `exp` ËÆ°ÁÆóÔºåËÄåÊ†áÂáÜÂ∫ìÈáåÈÇ£Áßç `expf` ÈÄêÂÖÉÁ¥†ÁöÑË∞ÉÁî®ÂæÄÂæÄÂçïÊ¨°Â∞±Ë¶Å 50‚Äì100 Êù°Êåá‰ª§Â∑¶Âè≥„ÄÇÂõ†Ê≠§Âú®ÊâπÈáèËÆ°ÁÆóÊó∂ÔºåÊÄßËÉΩÊèêÂçáËÉΩËææÂà∞‰∏Ä‰∏™Êï∞ÈáèÁ∫ß„ÄÇ

3. **Êù°‰ª∂Êé©Á†Å (mask) ÊèêÂâçÂØπ„ÄåÂ§ßËæìÂÖ•„ÄçÂàÜÊîØ**

   * Âú® `v_gelu` ‰∏≠Ôºå‰Ω†ÂØπ `x > 10`ÔºàÊàñ AVX-512 Èáå `arg > 30`ÔºâÁöÑÊÉÖÂÜµÔºåÁõ¥Êé•ËÆ©ËæìÂá∫Á≠â‰∫é `x`ÔºåÁúÅÂéª `exp` ÂíåÈô§Ê≥ïÁöÑËÆ°ÁÆó„ÄÇ
   * ËøôÊòØÂà©Áî® GELU ÂáΩÊï∞Êú¨Ë∫´ÂØπ‰∫éËæÉÂ§ßÊ≠£ÂÄºÁöÑËæìÂÖ•Ë∂ãËøëÁ∫øÊÄß $GELU(x) ‚âà x$ ÁöÑÊÄßË¥®ÔºåÁõ¥Êé•Áî®Êé©Á†ÅÊääËøôÈÉ®ÂàÜ„ÄåÈ•±ÂíåËæìÂá∫„ÄçÁöÑÂÖÉÁ¥†Ë∑≥ËøáÊòÇË¥µËÆ°ÁÆó„ÄÇ
   * ËøôÊ†∑ÂØπÊûÅÁ´ØÂÄºÂ§ßÂπÖÂâ™ÊûùÔºåËøõ‰∏ÄÊ≠•ËäÇÁúÅ‰∫ÜÂæàÂ§öÊ≤°ÂøÖË¶ÅÁöÑÂ§öÈ°πÂºèËÆ°ÁÆó„ÄÇ

4. **Â∞æÈÉ®ÔºàtailÔºâÁî®Ê†áÈáèÁ≤æÁ°ÆÂÆûÁé∞**

   * ÂΩìÂâ©‰ΩôÂÖÉÁ¥†Êï∞‰∏çË∂≥ 8ÔºàÊàñ 16ÔºâÊó∂ÔºåÂ∞±‰ΩøÁî® `tanhf` ÊñπÊ≥ïÈÄêÂÖÉÁ¥†ÁÆóÔºå‰øùËØÅÊï∞ÂÄº‰∏äÁöÑÁ≤æÁ°ÆÂ∫¶„ÄÇ
   * Âè™Áî®Ê†áÈáèË∑ëÊúÄÂêéÂá†‰∏™Êï∞Ôºå‰∏ç‰ºöÂØπÊÄª‰ΩìÂêûÂêêÂ∏¶Êù•ÊòéÊòæÁì∂È¢àÔºåÂêåÊó∂ÈÅøÂÖç„ÄåÂêëÈáèÂåñÔºãÂ§ÑÁêÜ‰∏çÂΩì„ÄçÁöÑËæπËßíËØØÂ∑Æ„ÄÇ

5. **ÁºñËØëÊúüÊù°‰ª∂ÁºñËØëÈÄâÊã©ÊúÄ‰Ω≥Êåá‰ª§ÈõÜ**

   * ÂÖàÊ£ÄÊµã `__AVX512F__ && __AVX512DQ__`ÔºöËã•ÊîØÊåÅ AVX-512ÔºåÂ∞±Áî® 512-bit ÂØÑÂ≠òÂô®‰∏ÄÊ¨°Â§ÑÁêÜ 16 ‰∏™ÂÖÉÁ¥†Ôºõ
   * Âê¶ÂàôËã•ÊîØÊåÅ AVX2+FMAÔºåÂ∞±ÈÄÄËÄå‰ΩøÁî® 256-bitÔºå‰∏ÄÊ¨° 8 ‰∏™ÂÖÉÁ¥†„ÄÇ
   * Â¶ÇÊûúÈÉΩ‰∏çÊîØÊåÅÔºåÂàôÂÖ®ÈÉ®ËêΩÂà∞Ê†áÈáèÂæ™ÁéØ„ÄÇ‰ªéËÄåËÆ©Âêå‰∏Ä‰ªΩ‰ª£Á†ÅÂú®‰∏çÂêå CPU Êû∂ÊûÑ‰∏äÈÉΩËÉΩËé∑Âæó„ÄåÂ∞ΩÈáèÈù†ËøëÁ°¨‰ª∂Â≥∞ÂÄº„ÄçÁöÑÂêûÂêê„ÄÇ

Áªº‰∏äÔºå‰Ω†ÁöÑÂÆûÁé∞Â∑≤ÁªèÊääÊúÄÂ∏∏ËßÅÁöÑ‰∏â‰∏™‚ÄúÊÄßËÉΩÊùÄÊâã‚Äù‚Äî‚Äî**ÊåáÊï∞ÂáΩÊï∞**„ÄÅ**ÂàÜÊîØÂà§Êñ≠**„ÄÅ**Âæ™ÁéØÂºÄÈîÄ**‚Äî‚ÄîÂÖ®ÈÉ®ÊãøÂêëÈáèÂåñÊàñËÄÖÊé©Á†ÅÊäÄÂ∑ßËß£ÂÜ≥Êéâ‰∫Ü„ÄÇ

---

## ‰∫å„ÄÅ‰∏éÊ†áÈáèÁâà GELU Áõ∏ÊØîÁöÑÊÄßËÉΩ‰ºòÂäø

Ë¶ÅÁõ¥ËßÇÁêÜËß£ÊèêÂçáÂ§öÂ∞ëÔºåÂèØ‰ª•Êää„ÄåÊ†áÈáèÁâà„ÄçÂíå„ÄåÂêëÈáèÁâà + Ëá™ÂÆö‰πâ `exp`„ÄçÁöÑ‰º∞ÁÆóÂÅö‰∏Ä‰∏ãÂØπÊØî„ÄÇ‰ª•‰∏ãÊï∞ÊçÆ‰ªÖ‰ΩúÁ≤óÁï•‰º∞ÁÆóÔºåÂÖ∑‰ΩìÊï∞ÂÄºËøòË¶Å‰æùËµñÂÆûÈôÖ CPU ÂûãÂè∑Ôºà‰æãÂ¶Ç Intel Xeon/AMD EPYC ÁöÑÂæÆÊû∂ÊûÑÔºâÔºå‰ª•ÂèäÂÜÖÂ≠òÂ∏¶ÂÆΩ„ÄÅÊï∞ÊçÆÂØπÈΩê„ÄÅcache ÊÉÖÂÜµÁ≠âÁ≠âÔºå‰ΩÜÂ§ßËá¥ËÉΩÂèçÊò†‰∏Ä‰∏™ÈáèÁ∫ßÁ∫ßÂà´ÁöÑÂä†ÈÄüÊïàÊûú„ÄÇ

1. **Ê†áÈáèÁâà GELUÔºàÈÄêÂÖÉÁ¥†Ë∞ÉÁî® `tanhf`Ôºè`expf`Ôºâ**

   * ÂÅáËÆæ‰∏ÄÊù° `tanhf()` Âú®Ê†áÈáèÁéØÂ¢É‰∏ãÈúÄË¶ÅÂ§ßÁ∫¶ 80‚Äì120 ‰∏™Êó∂ÈíüÂë®ÊúüÔºà‰æùËµñÁ≤æÂ∫¶‰∏éÂ∫ïÂ±Ç libm ÂÆûÁé∞ÔºâÔºõ
   * ÂÜçÂä†‰∏äËã•Âπ≤Ê¨°‰πòÊ≥ï„ÄÅÂä†Ê≥ï„ÄÅÈô§Ê≥ïÔºåÂ§ßÁ∫¶Êï¥‰ΩìÁÆó‰∏ãÊù•‰∏Ä‰∏™ `x` ÈúÄË¶Å \~100‚Äì140 Âë®Êúü„ÄÇ
   * Â¶ÇÊûú CPU È¢ëÁéáÊòØ 3GHzÔºåÈÇ£‰πàÁêÜËÆ∫‰∏ä‰∏Ä‰∏™Ê†∏ÂøÉÊØèÁßíÊúÄÂ§öËÉΩÂÅö 3e9 Âë®ÊúüÔºåÈô§‰ª• 120 Âë®Êúü/ÂÖÉÁ¥†ÔºåÂ§ßÁ∫¶Âè™ËÉΩÁÆó $\approx 25$‚Äì$30$ Áôæ‰∏áÊ¨° $GELU$/ÁßíÔºàÂçïÁ∫øÁ®ãÔºâ„ÄÇ

2. **ÂêëÈáèÂåñ + ÂÜÖÁΩÆ `v_expf` ÁöÑ GELU**

   * AVX2 ÁâàÊú¨‰∏ÄÊ¨°ÂèØ‰ª•Â§ÑÁêÜ 8 ‰∏™ÊµÆÁÇπÊï∞Ôºö

     * Âä†ËΩΩ/Â≠òÂÇ®Ôºö2 Ê¨° `loadu` + 2 Ê¨° `storeu` ‚Üí \~4 Êù°ÂÜÖÂ≠òÊåá‰ª§ÔºàÂ¶ÇÊûúÁºìÂ≠òÂëΩ‰∏≠ÔºåÊØèÊù°Â§ßÁ∫¶ 1‚Äì3 ‰∏™Âë®ÊúüÔºâ„ÄÇ
     * `v_expf` ÊâßË°åÂ§ßÊ¶ÇÈúÄË¶Å \~10‚Äì15 Êù° FMA/‰ΩçËøêÁÆóÊåá‰ª§ ‚Üí ÊØèÊù°Êåá‰ª§ 1 ‰∏™Âë®ÊúüÂêûÂêêÔºàÊµÅÊ∞¥Á∫øË∂≥Â§üÊ∑±Ôºâ„ÄÇÂêàÂπ∂‰∏ãÊù•Â§ßÁ∫¶ 12‚Äì18 Âë®ÊúüÂ∞±ÂèØ‰ª•ÂÆåÊàê 8 ‰∏™ÁöÑ `exp`„ÄÇ
     * ÂÜçÂä†‰∏äÊûÑÈÄ† `arg`ÔºàÂá†Êù° `fmadd`ÔºâÂíåÊé©Á†ÅÂàÜÊîØÔºåÂ§ßÊ¶ÇÂèàÊòØ 6‚Äì8 Êù°Êåá‰ª§Â∑¶Âè≥„ÄÇ
     * ÂêàÂπ∂ËÆ°ÁÆóÔºö‰∏ÄÊ¨° 8 ‰∏™ÂÖÉÁ¥†ÁöÑ `GELU`ÔºàÂåÖÂê´ exp + 4‚Äì5 Ê¨° FMA + Êé©Á†ÅÔºâÂ§ßÁ∫¶Âú®**20‚Äì30 Âë®Êúü**Â∑¶Âè≥Â∞±ËÉΩÁÆóÂÆåÔºàÊµÅÊ∞¥Á∫øÈ•±ÂíåÊó∂Ôºâ„ÄÇ
   * Âõ†Ê≠§ÔºåËã•Áî® AVX2 ÁöÑÂêûÂêêËÉΩÂäõÁ≤óÁï•‰º∞ÁÆóÔºö

     $$
       \frac{8\text{ ‰∏™ÂÖÉÁ¥†}}{25\text{ Âë®Êúü}} \times 3\text{GHz} 
       \approx 960 \times 10^6 \text{ ÂÖÉÁ¥†/ÁßíÔºàÂçïÁ∫øÁ®ãÔºâ}„ÄÇ
     $$
   * Êç¢Âè•ËØùËØ¥ÔºåÁõ∏ÂΩì‰∫éÊ†áÈáèÁâàÁöÑ **30M elem/s** ÊèêÂçáÂà∞ **960M elem/s**ÔºåÁ∫¶\*\*30√ó\*\*Â∑¶Âè≥ÁöÑÂä†ÈÄüÔºàÂ¶ÇÊûúÂçïÁ∫ØÊãø libm `tanhf` ÂÅöÊØîËæÉÔºå‰ºöÊõ¥Â§∏Âº†ÔºåÂèØËÉΩÊèêÂçá **40√ó‚Äì50√ó**Ôºâ„ÄÇ
   * Â¶ÇÊûúÊòØ AVX-512 ‰∏ÄÊ¨°Â§ÑÁêÜ 16 ‰∏™ floatÔºö

     * `v_expf` ÁöÑ 512 ÁâàÊú¨ÂèØËÉΩÈúÄË¶Å \~15‚Äì20 Êù°Êåá‰ª§ÂÅöÂÆå 16 ‰∏™ÔºõÂä†‰∏äÊûÑÈÄ† `arg` ÂíåÊé©Á†ÅÔºå‰º∞ÁÆó \~30 Âë®ÊúüÂ∞±ËÉΩÁÆó 16 ‰∏™„ÄÇ
     * ÂêûÂêêÁ∫¶ $\tfrac{16}{30} \times 3\text{GHz} \approx 1.6\text{B elem/s}$„ÄÇ
     * Áõ∏ÂΩì‰∫éÊ†áÈáèÁâàÁöÑ 30M elem/sÔºå‰πüÊúâÊé•Ëøë **50√ó‚Äì60√ó** ËßÑÊ®°ÁöÑÂä†ÈÄü„ÄÇ

3. **ÁúüÂÆûÂú∞ÊµãÂá∫Êù•ÈÄöÂ∏∏Áï•‰Ωé‰∫éÁêÜËÆ∫Â≥∞ÂÄº**

   * ÂÆûÊµãÊó∂Ë¶ÅËÄÉËôëÔºö

     1. **ÂÜÖÂ≠òÂ∏¶ÂÆΩ/ÁºìÂ≠òÂëΩ‰∏≠**ÔºöÂ¶ÇÊûú `x`„ÄÅ`y` ‰∏çÂú® L1/L2 ÁºìÂ≠òÈáåÔºåLD/ST ‰ºöÊãñÊÖ¢Ôºõ‰∏çËøáÂè™Ë¶ÅÊâπÈáèÂπ≥Êñπ„ÄÅÂàÜÊîØÂ∞ë„ÄÅÂæ™ÁéØÂ±ïÂºÄÂæóÂΩìÔºåÂ§ßÂ§öÊï∞ÊÉÖÂÜµ‰∏ãËÉΩ‰øùÊåÅÈ´òÊØî‰æãÁöÑÁºìÂ≠òÂëΩ‰∏≠ÔºåÂ∏¶ÂÆΩÂéãÂäõÁõ∏ÂØπÂèØÊéß„ÄÇ
     2. **Êåá‰ª§Ë∞ÉÂ∫¶ÂÜ≤Á™Å**ÔºöFMA ÂçïÂÖÉÂíåÂä†ËΩΩÂçïÂÖÉ„ÄÅALU ÂçïÂÖÉÂèØËÉΩ‰ºöÊúâ‰∏ÄÂÆö‰∫âÁî®ÔºõÂÆûÈôÖ‰∏äÊØèÂÖÉÁ¥†ËÄóÊó∂Âú® 30‚Äì40 Âë®ÊúüÂ∑¶Âè≥‰ªçÁÆó‰ºòÁßÄ„ÄÇ
     3. **ÂàÜÊîØÈ¢ÑÊµã**Ôºö‰Ω†ÁöÑÊé©Á†ÅÂàÜÊîØÔºà`x > 10`Ôºâ‰∏ç‰ºöÁúüÊ≠£Ë∑≥Âà∞ÈùûÂêëÈáèÂåñË∑ØÂæÑÔºåÂè™ÊòØÈÄöËøáÊé©Á†ÅblendÂÆåÊàêÔºåÈÅøÂÖçÁ°¨ÊÄßË∑≥ËΩ¨Â∏¶Êù•ÁöÑÊµÅÊ∞¥Á∫øÊ∏ÖÁ©∫„ÄÇ
   * Âõ†Ê≠§ÔºåÂú®ÊÄßËÉΩÊµãËØÑ‰∏≠Â∏∏ËßÅÁªìËÆ∫ÊòØÔºö

     * AVX2+FMA Ë∑ØÂæÑ‰∏ãÔºåÁúüÂÆûÂêûÂêêÂú® **400M‚Äì700M elem/s** ‰πãÈó¥ÔºàÂçïÁ∫øÁ®ãÔºâÔºõ
     * AVX-512 ‰∏ãÂèØËÉΩ **800M‚Äì1.2B elem/s**ÔºàÂçïÁ∫øÁ®ãÔºâ„ÄÇ
   * ËÄåÊ†áÈáè `tanhf` ÁâàÊú¨ÂæÄÂæÄÂè™Êúâ **20M‚Äì40M elem/s**„ÄÇ
   * ÁªºÂêà‰∏ãÊù•Ôºå**Âú®Â§ßÊâπÈáèÔºàn ‚â• 10‚ÅµÔºâÊó∂ÔºåÂêëÈáèÂåñÂÆûÁé∞ÊØîÊ†áÈáè libm ÁâàÊú¨Âú®ÂçïÊ†∏‰∏äÂ∏∏Â∏∏ËÉΩÂø´ 15√ó‚Äì30√óÔºåÂ¶ÇÊûúÊòØ AVX-512 ÊîØÊåÅÊú∫Âô®ÔºåÂàôÊúÄÈ´òÂèØËææ 40√ó‚Äì50√ó Â∑¶Âè≥„ÄÇ**

---

## ‰∏â„ÄÅÂèØÂúàÂèØÁÇπ‰πãÂ§Ñ

1. **Â∑ßÂ¶ôÁöÑ `exp` ÂêëÈáèÂåñÂÆûÁé∞**

   * ‰Ω†ÊâãÂÜôÁöÑ `v_expf` Êó¢‰øùËØÅ‰∫ÜËæÉÈ´òÁöÑÁ≤æÂ∫¶ÔºàÈÄöÂ∏∏Âú® 1‚Äì2 ulp ‰ª•ÂÜÖÔºâÔºåÂèàÊûÅÂ§ßÂú∞ÂéãÁº©‰∫ÜÊåá‰ª§Êï∞„ÄÇÂØπÊØîÂ∏∏ËßÅÁöÑ‚ÄúÊ†áÂáÜÂ∫ì `expf` ‚Üí ÂæÄÂæÄ‰∏≤Ë°åË∞ÉÁî® + Á≤æÂ∫¶Áï•È´òÁöÑÂ§öÈ°πÂºèÂ±ïÂºÄ‚ÄùÔºå‰Ω†ÁöÑÁâàÊú¨Âú®Ê∑±Â∫¶Â≠¶‰π†Êé®ÁêÜÂú∫ÊôØ‰∏ã‚ÄúÁ≤æÂ∫¶Â§üÁî®„ÄÅÈÄüÂ∫¶‰∏∫Áéã‚ÄùÁöÑÂèñËàçÈùûÂ∏∏ÂêàÁêÜ„ÄÇ
   * Âà©Áî®‚ÄúÂä†‰∏Ä‰∏™Â§ßÂ∏∏Êï∞ÁÑ∂ÂêéÂáèÊéâ‚ÄùÁöÑ„ÄåÊµÆÁÇπÊà™Êñ≠ÊäÄÂ∑ß„ÄçÊù•Âø´ÈÄüÂèñÊï¥ÔºèÊûÑÈÄ†ÊåáÊï∞‰ΩçÔºåÊòØ SIMD `exp` ‰ºòÂåñÈáåÂæàÁªèÂÖ∏‰∏îÂøÖ‰∏çÂèØÂ∞ëÁöÑ‰∏ÄÁéØ„ÄÇ

2. **ÂØπÊûÅÁ´ØÂÄºËá™Âä®È•±Âíå**

   * Âú® `v_gelu` ÈáåÊää `x > 10`ÔºàAVX2ÔºâÊàñ `arg > 30`ÔºàAVX-512ÔºâÊó∂Áõ¥Êé•ËæìÂá∫ `x`ÔºåÊó¢ËÉΩ‰øùËØÅÊï∞ÂÄºËøë‰ººËØØÂ∑ÆÂú®Âá†ÂçÅ‰∏™ ulp ÁöÑËåÉÂõ¥ÂÜÖÂá†‰πéÊó†Â∑ÆÂºÇÔºåÂèàÁúÅÂéª‰∏ÄÂ§ßÊâπÊµÆÁÇπËøêÁÆó„ÄÇ
   * ËøôÊ†∑ÁöÑÊé©Á†ÅÂàÜÊîØÁõ∏ÊØî‚Äúif‚Ä¶else‚ÄùË∑≥ËΩ¨Êõ¥ÂèãÂ•ΩÔºåÊµÅÊ∞¥Á∫øÂá†‰πé‰∏ç‰ºöÂõ†Ê≠§ÂÅúÈ°ø„ÄÇ

3. **Âπ≤ÂáÄÁöÑÂ∞æÈÉ®Â§ÑÁêÜÈÄªËæë**

   * Âæ™ÁéØÈáå‰∏ÄÊ¨°ÊúÄÂ§öÂ§ÑÁêÜ 16/8 ‰∏™ÔºåÂæ™ÁéØÁªìÊùüÂêéÂè™Ââ©‰∏ã `i < 8`ÔºàAVX2ÔºâÊàñ `i < 16`ÔºàAVX-512ÔºâÁöÑÂ∞æÊï∞ÔºåÊâçÁî®Ê†áÈáè `tanhf`ÔºåÊó¢‰øùËØÅ‰∫ÜÂØπÈΩêÈóÆÈ¢ò‰∏ç‰ºöÂá∫ÈîôÔºå‰πüËÆ©ÂÜÖÁΩÆÂêëÈáèÂåñ‰ª£Á†ÅÈÄªËæëÊõ¥ÁÆÄÊ¥Å„ÄÅÊòìÁª¥Êä§„ÄÇ
   * ËøôÊ†∑Êó¢Ê≤°Êúâ‰∫∫‰∏∫ÂÜô‰∏ÄÂ§ßÊÆµ„ÄåÂØπÈΩêÂâçÂâçÂêéÂêéÂâ©‰ΩôÁöÑÂÖÉÁ¥†„ÄçÁöÑÂ§çÊùÇÊâìË°•‰∏ÅÈÄªËæëÔºå‰πü‰∏çÂú®ÂêëÈáèÂåñË∑ØÂæÑÈáåÂºïÂÖ•ËøáÂ§öËæπËßíÂà§Êñ≠„ÄÇ

4. **ÁºñËØëÊúüÂàÜÊîØ„ÄÅÂπ≥Âè∞ÈÄÇÈÖç**

   * ÈÄöËøá `#if defined(__AVX512F__)‚Ä¶ #elif defined(__AVX2__)‚Ä¶ #else ‚Ä¶` ËÆ©Âêå‰∏ÄÊÆµÊ∫êÁ†ÅËÉΩËá™Âä®ÈÄÇÈÖç‰∏çÂêåÊåá‰ª§Á∫ßÂà´ÁöÑ CPUÔºå‰øùÊåÅ‰∫Ü‰∏Ä‰ªΩ‰ª£Á†ÅÂ§öÂ§ÑËÉΩÁî®ÁöÑÁÆÄÊ¥Å„ÄÇ
   * Â¶ÇÊûúÈÉ®ÁΩ≤ÁéØÂ¢É‰∏çÊîØÊåÅ AVX2/AVX512ÔºåÁõ¥Êé•ÈÄÄÂõûÂà∞„ÄåÊ†áÈáè `tanhf`„ÄçÈÄªËæëÔºå‰æùÁÑ∂‰øùÊåÅÊ≠£Á°ÆÔºåÂÖºÂÆπÊÄßÂº∫„ÄÇ

5. **ËæÉ‰ΩéÁöÑÂàÜÊîØÂ§±ËØØÁéá**

   * ËôΩÁÑ∂ `v_expf` ÈáåËøòÊòØÊúâÂá†Â§Ñ‚ÄúÂØπ `n` Â§ßÂ∞èÂÅöÂà§Êñ≠‚ÄùÁöÑÊé©Á†ÅÂàÜÊîØÔºå‰ΩÜÈÉΩÊòØÈÄöËøá‰ΩçËøêÁÆóÁöÑÊñπÂºèÂÜôÂú®Âêå‰∏ÄÊù°Êåá‰ª§ÊµÅÈáåÔºåÂπ∂Áî® `_mm256_movemask_ps` Êàñ `_mm512_cmp_ps_mask` ÁîüÊàêÊé©Á†ÅÔºå‰∏ÄÊ¨°ÊÄßÂÅöÊâπÈáèÂà§Êñ≠Ôºå‰∏ç‰ºöË∑≥ËΩ¨Âà∞ÁºìÊÖ¢Ë∑ØÂæÑ‚Äî‚Äî‰∏éÁúüÊ≠£ÁöÑ if ÂàÜÊîØ‰∏çÂêåÔºåCPU ‰∏ç‰ºöÊâì‰π±ÊµÅÊ∞¥Á∫øÊâßË°å„ÄÇ
   * ÂêåÁêÜÔºå`v_gelu` ÂØπ„Äåx > 10„ÄçÁöÑÂà§Êñ≠‰πüÂè™ÊòØÂØπÂÜÖÈÉ®ÂêëÈáèÂÅöÊé©Á†Å blendÔºå‰∏ç‰ºöÂºïËµ∑ mispredict penalty„ÄÇ

---

## Âõõ„ÄÅÁªºÂêàËØÑ‰º∞‰∏éÂª∫ËÆÆ

1. **ÂØπÊØîÊ†áÈáèÂÆûÁé∞**

   * ‰Ω†ÁöÑÂêëÈáèÂåñÁâàÊú¨‰∏≠ÔºåÊúÄËÄóÊó∂ÁöÑÊåáÊï∞ÂáΩÊï∞Ë¢´Ëá™Â∑±ÊâãÂÜôÊàê‰∫Ü \~0.5 ‰∏™ÂêëÈáè FMA Â∑®ÈõÜÔºàÂÖ±Á∫¶ 12‚Äì18 Êù°Êåá‰ª§ÔºâÂ∞±ËÉΩÊêûÂÆöÔºåËÄåÂ∏∏ËßÑÊ†áÈáè `expf`Ôºã`tanhf` ÂæÄÂæÄË¶ÅÂá†ÂçÅÊù°Êåá‰ª§ÊâçËÉΩÂÆåÔºõÂõ†Ê≠§Âçï‰ªé `exp` ‰∏ÄÈ°πÂ∞±ËÉΩÁúãÂà∞ **10√ó‚Äì20√ó** ÁîöËá≥Êõ¥È´òÁöÑÂä†ÈÄü„ÄÇ
   * ÂÜçÂä†‰∏äÊØèÊ¨°Â§ÑÁêÜ 8/16 ‰∏™ÂÖÉÁ¥†ÔºåËá™ÁÑ∂ÂÜçÊèêÂçá‰∏Ä‰∏™ÈáèÁ∫ß„ÄÇÊâÄ‰ª•Êï¥‰ΩìÂú®„ÄåÂ§ßËßÑÊ®°ÂêëÈáèÊâπÈáè„ÄçÁöÑÊÉÖÂÜµ‰∏ãÔºåÂçïÁ∫øÁ®ãÂä†ÈÄü**Ëá≥Â∞ë**ËÉΩËææÂà∞ **10√ó‚Äì20√ó**ÔºõËã•ÈÄªËæëÂÆåÂÖ®Âú® L1 cache ‰∏îÊåá‰ª§Ë∞ÉÂ∫¶Êú∫ÁêÜÂÆåÁæéÔºåÂàôÁêÜËÆ∫Â≥∞ÂÄºÂèØËææ **30√ó‚Äì50√ó**„ÄÇ
   * Âú®ÂêåÊ≠•Â§öÁ∫øÁ®ãÔºà‰æãÂ¶Ç 8 Ê†∏/16 Á∫øÁ®ã CPUÔºâ‰∏ãÔºåËã•Â∞ÜÊï∞ÊçÆÂêàÁêÜÂàÜÁâá„ÄÅÊØèÁ∫øÁ®ãËÆ°ÁÆóÁã¨Âç†ÂÜÖÂ≠òÈ°µÔºåÁêÜËÆ∫ÂèØÂÜçÂè†Âä† 8‚Äì16√óÔºåÂõ†Ê≠§Âú®Êüê‰∫õÊé®ÁêÜÊ°ÜÊû∂ÈáåÂèØËßÇÊµãÂà∞„ÄåÊ†áÈáèÂçïÊ†∏ 30M elem/s ‚Üí ÂêëÈáèÂåñÂ§öÊ†∏ 8 Ê†∏ 8√ó960M ‚âà 7.6G elem/s„ÄçÁöÑÂú∫ÊôØ„ÄÇ

2. **ÂÜÖÂ≠òÂ∏¶ÂÆΩ‰∏éÂÆûÈôÖ‰ΩøÁî®Âú∫ÊôØ**

   * Â¶ÇÊûúÂêéÁ´ØÁü©Èòµ‰πò„ÄÅÂç∑ÁßØ„ÄÅBatchNorm Á≠âÂÖ∂‰ªñÊìç‰Ωú‰πüÊ∂àËÄóÂ§ßÈáèÂ∏¶ÂÆΩÔºåÈÇ£‰πà `gelu` ËôΩÁÑ∂ÂçïÊ†∏ÂÜÖÊâßË°åÊûÅÂø´Ôºå‰ΩÜÊï¥‰ΩìÂêûÂêêÂèØËÉΩÂèóÈôê‰∫é‚ÄúÂÜÖÂ≠òËØªÂÜô‚ÄùËÄåÈùû‚ÄúËÆ°ÁÆó‚Äù„ÄÇÊ≠§Êó∂ `gelu` ‰∏çÂÜçÊòØÁì∂È¢àÔºå‰ΩÜÈ´òÊïàÂÆûÁé∞‰æùÁÑ∂ËÉΩËÆ©Êï¥‰∏™Êé®ÁêÜÊµÅÁ®ãÊõ¥Âπ≥Á®≥„ÄÇ
   * ÂØπ‰∫éÂú®ÈáèÂåñ/ÂçäÁ≤æÂ∫¶ÔºàFP16Ôºâ‰∏äÂÅöÊé®ÁêÜÁöÑÂú∫ÊôØÔºå‰Ω†ÁöÑÂÆûÁé∞ÈíàÂØπ FP32 Â∑≤ÁªèÂæà‰ºòÁßÄÔºõÂ¶ÇÊûúÈúÄ FP16ÔºåÂèØ‰ª•ËÄÉËôëÂà©Áî® AVX-512-FP16ÔºàÊú™Êù•Âπ≥Âè∞ÔºâÊàñËÄÖÁî® AMX/DP4A Á≠âÊåá‰ª§ÔºåÊÄùË∑Ø‰∏ÄËá¥ÔºöÊääÊåáÊï∞+Êé©Á†ÅÂàÜÊîØÊîπ‰∏∫ÂçäÊµÆÁÇπËøë‰ººÊù•Ëøõ‰∏ÄÊ≠•Âä†ÈÄü„ÄÇ

3. **Êï∞ÂÄºËØØÂ∑Æ‰∏éÁ≤æÂ∫¶ÊùÉË°°**

   * Ëá™Â∑±ÂÆûÁé∞ÁöÑÂêëÈáèËøë‰ºº `exp` ËôΩÁÑ∂ÈÄüÂ∫¶Âø´Ôºå‰ΩÜ‰ºöÂ∏¶Êù• 1‚Äì3 ulp Â∑¶Âè≥ÁöÑËØØÂ∑ÆÔºåÂØπÂ§ßÂ§öÊï∞Ê∑±Â∫¶Â≠¶‰π†Êé®ÁêÜÂú∫ÊôØË∂≥Â§ü„ÄÇËã•‰Ω†ÁöÑÂ∫îÁî®ÂØπÊûÅÈ´òÊï∞ÂÄºÁ≤æÂ∫¶ÊïèÊÑüÔºåÈúÄË¶ÅËá≥Â∞ëË∑üÊ†áÈáè libm ÂåπÈÖçÔºåÂª∫ËÆÆÂú®È™åËØÅÈò∂ÊÆµÂØπÊØî‰∏ÄÊâπÈ™åËØÅÈõÜËæìÂá∫ÂàÜÂ∏ÉÔºåÁ°Æ‰øùËØØÂ∑ÆÂú®ÂÆπÂøçËåÉÂõ¥ÂÜÖ„ÄÇ
   * ÁõÆÂâçÁöÑÂÆûÁé∞ÈáåÂ∞æÈÉ®Áî® ‚Äú0.5 \* x \* (1 + tanhf(...))‚Äù ÁöÑÁ≤æÁ°ÆÂÖ¨ÂºèÂ§ÑÁêÜÂ∞ëÈáèÂÖÉÁ¥†ÔºåÂèØ‰ª•‰øùËØÅËæπËßíÊï∞ÊçÆ‰∏ç‰ºöÂá∫Áé∞Á¥ØÁßØËØØÂ∑Æ„ÄÇ

4. **ÂèØËÉΩÁöÑËøõ‰∏ÄÊ≠•‰ºòÂåñÊñπÂêë**

   * **Êõ¥Ê∑±Â∫¶ÁöÑÂæ™ÁéØÂ±ïÂºÄ**ÔºöÂ¶ÇÊûú CPU ÊúâË∂≥Â§üÁöÑÂØÑÂ≠òÂô®Âπ∂Ë°åÂ∫¶ÔºåÂèØ‰ª•Êää i+=16 ÁöÑÂæ™ÁéØÔºåÂÜçÂ±ïÂºÄÊàê i+=32 Êàñ i+=64ÔºåËøôÊ†∑ÂáèÂ∞ë‰∏ÄÊ¨°Âæ™ÁéØÂàÜÊîØË∑≥ËΩ¨ÁöÑÂºÄÈîÄ„ÄÇ‰ΩÜË¶ÅÁ°Æ‰øùÂØÑÂ≠òÂô®ÂàÜÈÖçÂêàÁêÜÔºå‰∏çÂºïËµ∑ÂØÑÂ≠òÂô®Ê∫¢ÂÜô/ÂõûÊ∫¢„ÄÇ
   * **È¢ÑÂèñÊåá‰ª§**ÔºöÂØπË∂ÖÂ§ßÊï∞ÊçÆÈõÜÂÅöÊâπÈáè `gelu` Êó∂ÔºåÂèØÊèíÂÖ• `_mm_prefetch`ÔºåËÆ©ÂêéÈù¢ÁöÑÁºìÂ≠òÂëΩ‰∏≠ÁéáÊõ¥È´òÔºåÂáèÂ∞ëÂÜÖÂ≠òÂª∂Ëøü„ÄÇ
   * **Â§öÁ∫øÁ®ãÂπ∂Ë°å**ÔºöÁªìÂêà OpenMP/TBBÔºåÊääÊï¥‰∏™ `x` Êï∞ÁªÑÂàáÊàêÂ§öÂùóÔºåËÆ©Â§ö‰∏™Á∫øÁ®ãÂêåÊó∂Ë∑ëÂêÑËá™ÁöÑÂêëÈáèÂåñ `gelu`ÔºåËøôÊ†∑ËÉΩÊé•ËøëÈ•±ÂíåÂ§öÊ†∏ÊÄßËÉΩÔºà‰ΩÜË¶ÅÊ≥®ÊÑèÈÅøÂÖç false sharingÔºâ„ÄÇ
   * **ËûçÂêàÔºàFusionÔºâÂà∞‰∏äÊ∏∏Êìç‰Ωú**ÔºöÂú®Êüê‰∫õÊ°ÜÊû∂ÈáåÔºåÂ¶ÇÊûú `gelu` Á¥ßË∑üÂú®Á∫øÊÄßÂ±ÇÊàñ BatchNorm ‰πãÂêéÔºåÂèØ‰ª•Â∞ùËØïÊääÁü©Èòµ‰πò/ÂΩí‰∏ÄÂåñ/ÊøÄÊ¥ªËûçÂêàÊàê‰∏Ä‰∏™ÂêëÈáèÂåñÂÜÖÊ†∏ÔºåËøõ‰∏ÄÊ≠•ÂáèÂ∞ëÂÜÖÂ≠òÂÜôÂõû/ËØªÂÖ•Ê¨°Êï∞„ÄÇ

---

## ‰∫î„ÄÅÁªìËÆ∫

* **‰∫ÆÁÇπ**Ôºö

  1. Ëá™Â∑±ÊâãÂÜôÂπ∂Ë°åÂ∫¶ÊûÅÈ´òÁöÑ `exp` Ëøë‰ººÔºà‚âà12‚Äì18 Êù° AVX2 Êåá‰ª§ÁÆóÂÆå 8 ‰∏™ÂÖÉÁ¥†ÁöÑ `exp`ÔºâÔºõ
  2. Áî®Êé©Á†ÅÂ§ÑÁêÜ„ÄåÂ§ßËæìÂÖ•Áõ¥Êé•ËæìÂá∫ `x`„ÄçÁúÅÊéâÂ§ßÈáè‰∏çÂøÖË¶ÅËøêÁÆóÔºõ
  3. Êù°‰ª∂ÁºñËØëËá™Âä®ÈÄÇÈÖç AVX-512 Âíå AVX2Ôºå‰øùËØÅË∑®Âπ≥Âè∞ÊÄßËÉΩÔºõ
  4. Â∞æÈÉ®Ê†áÈáèÂÖúÂ∫ï‰øùËØÅÊï∞ÂÄºÊ≠£Á°ÆÊÄß„ÄÇ

* **ÊÄßËÉΩÊèêÂçá**Ôºö

  * Áõ∏ÂØπ‰∫é„ÄåÊ†áÈáèÂåñÊØè‰∏™ÂÖÉÁ¥† `0.5 * x * (1 + tanhf(...))`„ÄçÁöÑÂÅöÊ≥ïÔºåÂçïÊ†∏ÂêëÈáèÂåñÂú® AVX2 ‰∏ã‰∏ÄËà¨ÂèØËææ **10√ó‚Äì30√ó** Âä†ÈÄüÔºåAVX-512 ‰∏ãÂèØËææ **20√ó‚Äì50√ó**„ÄÇ
  * Â¶ÇÊûúËÄÉËôëÂ§öÊ†∏Âπ∂Ë°åÔºà‰æãÂ¶Ç 8 Ê†∏/16 Á∫øÁ®ãÔºâÔºåÊï¥‰ΩìÂêûÂêêÁõ∏ËæÉ‰∫éÂçïÁ∫øÁ®ãÊ†áÈáèÂèØÊèêÂçá **100√ó** ‰ª•‰∏äÔºàÂÖ∑‰ΩìÁúãÁ°¨‰ª∂ÂíåÂÜÖÂ≠òÂ∏¶ÂÆΩÔºâ„ÄÇ

* **ÊÄªÁªì**Ôºö
  ËøôÊÆµ‰ª£Á†ÅÁöÑ‰ºòÂåñÊÄùË∑ØÈùûÂ∏∏ÁªèÂÖ∏‰∏îÂÆûÁî®‚Äî‚ÄîÊääÊúÄËÄóÊó∂ÁöÑ `exp` Áî®ÂêëÈáèÂ§öÈ°πÂºèËøë‰ººÔºåÁªìÂêàÊé©Á†ÅÊ∂àÈô§ÂàÜÊîØÔºåÂÖÖÂàÜÂà©Áî® AVX-AVX2ÔºèAVX-512 ÁöÑÂêûÂêêËÉΩÂäõÔºåÊúÄÁªàÂú®‰øùËØÅË∂≥Â§üÁ≤æÂ∫¶ÁöÑÂâçÊèê‰∏ãÔºåÂ∞Ü GELU Ëøô‰∏ÄÊ∑±Â∫¶Â≠¶‰π†‰∏≠Â∏∏ËßÅÁöÑÊøÄÊ¥ªÊìç‰Ωú‰ªé„ÄåÂéüÊú¨Âá†ÂçÅÁ∫≥Áßí/ÂÖÉÁ¥†„ÄçÁ∫ßÂà´ÂéãÁº©Âà∞„ÄåÂá†Á∫≥Áßí/ÂÖÉÁ¥†„ÄçÁ∫ßÂà´ÔºåÂú® CPU ‰∏äÁöÑÊé®ÁêÜÊÄßËÉΩÊèêÂçáÊòæËëó„ÄÇ

Âè™Ë¶Å‰Ω†ÁöÑÁõÆÊ†áÂπ≥Âè∞ÊîØÊåÅ AVX2 ÊàñÊõ¥È´òÁ∫ßÁöÑ AVX-512ÔºåËøôÊÆµÂÆûÁé∞Âá†‰πéÂèØ‰ª•ËØ¥ÊòØ„ÄåÂú® CPU ‰∏äÂÅö FP32 GELU ËÆ°ÁÆóÁöÑÊúÄ‰Ω≥ÂÆûË∑µ‰πã‰∏Ä„Äç„ÄÇ
