# NAT映射与过滤行为

### 🧑‍💻 User

rfc5780规定的nat中的映射行为和过滤行为分别是什么意思，分别有哪些？

---

### 🤖 Assistant

RFC 5780 (以及其定义基础 RFC 4787) 为了更精确地描述 NAT (网络地址转换) 的特性，废弃了传统的“圆锥型 (Cone)”和“对称型 (Symmetric)”分类法，转而使用两个具体的维度来描述：**映射行为 (Mapping Behavior)** 和 **过滤行为 (Filtering Behavior)**。

简而言之：
*   **映射行为**决定了 NAT 如何为内部主机分配公网地址/端口（**出站**规则）。
*   **过滤行为**决定了 NAT 允许哪些外部主机通过映射的地址/端口发送数据给内部主机（**入站**规则）。

以下是详细的解释和分类：

---

### 1. 映射行为 (Mapping Behavior)

**定义：**
当内部主机使用**同一个**内部 IP 地址和端口 ($IP_{int}:Port_{int}$) 向**不同**的目标地址发送数据包时，NAT 设备是否会重复使用同一个外部映射地址和端口 ($IP_{ext}:Port_{ext}$)。

RFC 定义了三种映射行为：

#### A. 端点独立映射 (Endpoint-Independent Mapping, EIM)
*   **描述**：NAT 重用端口最宽松的模式。只要内部主机的源 IP 和源端口相同，无论它发往哪个目标 IP 或端口，NAT 都会将其映射为**同一个**外部 IP 和外部端口。
*   **规则**：
    对于内部 $X:x$，发送给 $A:a$ 时映射为 $Y:y$。
    对于内部 $X:x$，发送给 $B:b$ 时**依然**映射为 $Y:y$。
*   **特点**：这是对 P2P 连接最友好的模式（对应旧术语中的“圆锥型 NAT”）。

#### B. 地址相关映射 (Address-Dependent Mapping, ADM)
*   **描述**：NAT 的映射取决于目标 IP 地址。如果内部主机向不同的目标 IP 发送数据，即使内部源端口相同，NAT 也会分配**不同**的外部端口。但如果向同一个目标 IP 的不同端口发送，可能会重用映射。
*   **规则**：
    对于内部 $X:x$，发送给 $A:a$ 时映射为 $Y:y1$。
    对于内部 $X:x$，发送给 $B:b$ 时映射为 $Y:y2$ (因为目标 IP 不同)。
    对于内部 $X:x$，发送给 $A:b$ 时通常仍映射为 $Y:y1$ (因为目标 IP 相同)。

#### C. 地址和端口相关映射 (Address and Port-Dependent Mapping, APDM)
*   **描述**：最严格的映射模式。只要目标 IP **或** 目标端口有任何不同，NAT 都会为内部主机分配一个新的外部端口。
*   **规则**：
    对于内部 $X:x$，发送给 $A:a$ 时映射为 $Y:y1$。
    对于内部 $X:x$，发送给 $A:b$ 时映射为 $Y:y2$ (因为目标端口不同)。
    对于内部 $X:x$，发送给 $B:b$ 时映射为 $Y:y3$。
*   **特点**：这对应旧术语中的“对称型 NAT (Symmetric NAT)”，很难进行 P2P 穿透。

---

### 2. 过滤行为 (Filtering Behavior)

**定义：**
当 NAT 在外部接口 ($IP_{ext}:Port_{ext}$) 上建立了一个映射后，它如何决定是否允许接收来自外部主机的入站数据包。

RFC 定义了三种过滤行为：

#### A. 端点独立过滤 (Endpoint-Independent Filtering, EIF)
*   **描述**：最宽松的过滤。一旦内部主机向**任意**外部主机发送过数据（从而建立了映射），NAT 就会允许**任何**外部主机发送数据到该映射端口。
*   **规则**：
    内部 $X:x$ 向 $A:a$ 发送数据，NAT 建立映射 $X:x \leftrightarrow Y:y$。
    此时，外部主机 $B:b$ (即使从未通信过) 发送数据给 $Y:y$，NAT **允许**并通过转发给 $X:x$。
*   **特点**：对应“全圆锥型 (Full Cone)”。

#### B. 地址相关过滤 (Address-Dependent Filtering, ADF)
*   **描述**：NAT 只允许内部主机曾经发送过数据的**目标 IP** 发回数据。端口不限制。
*   **规则**：
    内部 $X:x$ 向 $A:a$ 发送数据，建立映射 $Y:y$。
    外部主机 $A:b$ (相同 IP，不同端口) 发送数据给 $Y:y$，NAT **允许**。
    外部主机 $B:b$ (不同 IP) 发送数据给 $Y:y$，NAT **丢弃**。
*   **特点**：对应“受限圆锥型 (Restricted Cone)”。

#### C. 地址和端口相关过滤 (Address and Port-Dependent Filtering, APDF)
*   **描述**：最严格的过滤。NAT 只允许内部主机曾经发送过数据的**特定 IP 和特定端口**发回数据。
*   **规则**：
    内部 $X:x$ 向 $A:a$ 发送数据，建立映射 $Y:y$。
    只有 $A:a$ 可以发送数据给 $Y:y$，NAT 才会转发。
    外部主机 $A:b$ (端口不同) 发送数据给 $Y:y$，NAT **丢弃**。
    外部主机 $B:b$ (IP 不同) 发送数据给 $Y:y$，NAT **丢弃**。
*   **特点**：对应“端口受限圆锥型 (Port Restricted Cone)”以及“对称型 NAT”通常采用的过滤方式。

---

### 总结与对比

| 行为类型 | 关注点 | 核心逻辑 | 对 P2P 的影响 |
| :--- | :--- | :--- | :--- |
| **映射 (Mapping)** | **出站** (Outbound) | 当我发给不同的人，我的公网马甲(IP:Port)会变吗？ | EIM (不变) 最利于打洞；APDM (变) 最难打洞。 |
| **过滤 (Filtering)** | **入站** (Inbound) | 谁有资格往我的公网马甲(IP:Port)发数据？ | EIF (谁都可以) 最安全隐患但连接最容易；APDF (仅限对方) 最安全但连接困难。 |

**组合示例：**
*   **Full Cone NAT (全圆锥):** EIM (映射) + EIF (过滤)
*   **Restricted Cone NAT (受限圆锥):** EIM (映射) + ADF (过滤)
*   **Port Restricted Cone NAT (端口受限圆锥):** EIM (映射) + APDF (过滤)
*   **Symmetric NAT (对称型):** APDM (映射) + APDF (过滤)

RFC 5780 之所以拆分这两个概念，是因为现代 NAT 设备可能会出现混合情况（例如：EIM 映射，但配合 APDF 过滤），使用旧的分类法无法准确描述。

---

### 🧑‍💻 User

为什么说RFC 5780 (及其前身 RFC 4787) 定义的这些行为类型比旧的 "Cone NAT" (Full, Restricted, Port Restricted) 和 "Symmetric NAT" 分类法更精确和灵活？

---

### 🤖 Assistant

RFC 5780（及 RFC 4787）定义的“映射/过滤行为”体系之所以优于旧的“圆锥/对称（Cone/Symmetric）”体系，根本原因在于**旧体系是基于测试结果的现象描述，而新体系是基于实现逻辑的功能描述**。

旧的分类法（源自已被废弃的 RFC 3489）试图将所有 NAT 设备硬塞进 4 个固定的“盒子”里，但在现实复杂的网络环境中，这种做法显得**过于粗糙**且**存在盲区**。

以下是具体的几个理由，解释了为什么新标准更精确、更灵活：

### 1. 解耦了“映射”与“过滤” (Decoupling)

这是最大的改进。在路由器或防火墙的底层实现代码中，**NAT（地址转换）**和**防火墙（包过滤）**通常是两个独立的模块。

*   **旧体系 (Coupled)：** 假设了映射和过滤是绑定的。例如，“端口受限圆锥型”默认意味着“EIM 映射 + APDF 过滤”。
*   **新体系 (Decoupled)：** 承认这两个行为是正交（相互独立）的。
    *   **例子**：某些企业级防火墙可能配置了极其严格的 **APDM（对称型映射）** 来隐藏内部拓扑，但为了兼容某些业务，又配置了较宽松的 **ADF（地址相关过滤）**。
    *   在旧体系中，这种设备无法被准确归类（它是对称型？还是受限型？），导致 P2P 软件无法选择正确的穿透策略。新体系则可以精确描述为“APDM + ADF”。

### 2. 细分了“对称型 NAT”的粒度 (Granularity)

在旧体系中，凡是不属于三种圆锥型的，都被统称为“对称型 NAT (Symmetric NAT)”。这就像把所有“难搞”的 NAT 都扔进同一个垃圾桶，掩盖了其中的细节差异。

新体系将“对称型”拆解，特别是区分了 **ADM (地址相关)** 和 **APDM (地址和端口相关)**：

*   **场景**：内部主机 $X:x$ 向同一目标 IP 的不同端口（$A:a$ 和 $A:b$）发送数据。
*   **ADM**：NAT 会重用同一个外部映射端口。
*   **APDM**：NAT 会分配不同的外部映射端口。
*   **影响**：这对 P2P 预测非常关键。如果是 ADM，打洞成功率比 APDM 高得多。旧体系把这两个混为一谈，导致 P2P 算法可能会过早放弃尝试。

### 3. 解决了“确定性”问题

旧的 RFC 3489 分类法是基于一套固定的 STUN 测试流程得出的。如果网络出现丢包，或者 NAT 设备处于高负载状态，测试结果可能会波动。

*   例如：一个“全圆锥 NAT”如果因为防火墙规则临时丢弃了某个来自陌生 IP 的探测包，可能会被旧算法误判为“受限圆锥”甚至“对称型”。
*   RFC 4787/5780 强调的是**行为规范**。它告诉开发者和设备制造商：不管网络状况如何，设备应该遵循什么样的逻辑规则。这使得 P2P 协议（如 ICE）不再依赖单一的标签（“我是全圆锥”），而是动态探测具体的行为属性。

### 4. 涵盖了端口保留 (Port Preservation) 和发卡行为 (Hairpinning)

旧分类法主要关注外部可达性，忽略了 NAT 内部的其他关键行为，而这些在新标准中被明确定义：

*   **端口保留**：如果内部源端口是 5060，NAT 是否优先尝试映射到外部的 5060？（这对 SIP 语音协议很重要）。
*   **Hairpinning (NAT 回环)**：同一个 NAT 下的两台内网主机，能否通过对方的**公网 IP** 进行通信？
    *   旧的分类法完全没有定义这一点。
    *   RFC 4787 明确指出了 Hairpinning 的重要性，并定义了它。这对于处于同一局域网下的 P2P 连接至关重要。

### 5. 适应现代复杂的 NAT/防火墙组合

现代网络设备通常是 NAT 网关和状态防火墙（Stateful Firewall）的结合体。

*   **Linux iptables 示例**：
    *   `MASQUERADE` 规则决定了 **映射行为**。
    *   `RELATED,ESTABLISHED` 规则决定了 **过滤行为**。
*   管理员可以随意组合这两者。RFC 5780 的术语体系直接对应了这种现代网络设备的配置逻辑，能够描述 Linux iptables、Cisco PIX/ASA 以及各种云网关的复杂配置，而旧的“圆锥/对称”术语往往显得力不从心。

### 总结对比表

| 特性 | 旧体系 (RFC 3489) | 新体系 (RFC 5780 / 4787) |
| :--- | :--- | :--- |
| **分类逻辑** | 黑盒测试结果 (Phenomenological) | 内部实现逻辑 (Behavioral) |
| **维度** | 单一维度 (4 种类型) | 正交维度 (映射行为 + 过滤行为) |
| **对称型定义** | 笼统 (Catch-all) | 精确 (区分 ADM 和 APDM) |
| **灵活性** | 低 (非此即彼) | 高 (可任意组合) |
| **对 P2P 的价值** | 给 NAT 贴标签，容易误判 | 提供精细属性，利于 ICE 协议选路 |

因此，在开发 WebRTC、VoIP 或在线游戏等 P2P 应用时，现在都使用 RFC 5780 的术语来编写穿透逻辑（ICE），而不再单纯依赖旧的分类。

---

### 🧑‍💻 User

为什么ipv6的mapping behaviour为Direct，filtering behavior为Endpoint-Independent？如果配置了入栈防火墙，情况又会发生哪些变化？

---

### 🤖 Assistant

这是一个非常深刻的问题。你提到的现象（IPv6 Mapping = Direct, Filtering = EIF）描述的是 **IPv6 理想的“端到端”设计初衷**，但在实际部署中，防火墙的引入会显著改变这一行为。

我们需要分两种情况来讨论：**理想的纯路由模式** 和 **现实中的有状态防火墙模式**。

---

### 情况一：理想模式（纯 IPv6 路由，无状态防火墙）

在 IPv6 的标准设计理念中，NAT（网络地址转换）是不被推荐甚至是被废弃的。每个设备都应该拥有一个全球唯一的公网地址（GUA）。

#### 1. 为什么 Mapping Behavior 是 "Direct"？
在 RFC 5780 的语境下，“Mapping”指的是内网地址如何转换为外网地址。
*   **原理**：由于没有 NAT，IPv6 主机直接使用其全球单播地址进行通信。
*   **表现**：内部 socket 绑定的 IP 和端口，就是互联网上其他人看到的 IP 和端口。
    $$IP_{int}:Port_{int} \equiv IP_{ext}:Port_{ext}$$
*   **结论**：这种“恒等映射”在 STUN 测试或 ICE 协商中被称为 **Direct Mapping**（直接映射）。这意味着不需要 STUN 服务器来发现公网地址，设备自己就知道。

#### 2. 为什么 Filtering Behavior 是 "Endpoint-Independent" (EIF)？
*   **原理**：在没有防火墙拦截的纯路由网络中，路由器只负责查表转发，不维护连接状态。
*   **表现**：只要你的设备在某个端口上监听（Listen），互联网上**任何**主机（Endpoint）都可以向该 IP 的该端口发送数据包，路由器都会无条件转发给你。
*   **结论**：这种“来者不拒”的行为正是 **Endpoint-Independent Filtering**。

---

### 情况二：现实模式（配置了入栈防火墙/CPE 设备）

虽然 IPv6 抛弃了 NAT，但出于安全考虑，几乎所有的家用路由器（CPE）和企业防火墙默认都会开启 **IPv6 有状态防火墙 (Stateful Firewall / IPv6 SPI)**。这类似于 IPv4 中 NAT 的“保护”副作用，但没有地址转换。

如果配置了默认的入栈防火墙（通常策略是：允许出站，拒绝入站，允许已建立的连接），情况会发生如下变化：

#### 1. Mapping Behavior：依然是 "Direct"
**这一点不会变。**
防火墙只负责检查包的合法性（Drop/Accept），它**不修改**包头中的源/目的 IP 和端口（不进行 SNAT/DNAT）。
因此，外部看到的依然是你的真实 IPv6 地址。你的映射行为仍然是 **Direct**。

#### 2. Filtering Behavior：变为 "Address and Port-Dependent" (APDF)
这是最大的变化点。有状态防火墙维护一张“连接追踪表 (Conntrack Table)”。

*   **机制**：
    1.  当你（内部 $X:x$）向 Google（外部 $G:80$）发送数据包时，防火墙记录一条状态：`UDP X:x -> G:80`。
    2.  防火墙制定临时规则：只允许来自 $G:80$ 的数据包进入并发给 $X:x$。
    3.  如果有恶意主机 $H:999$ 试图扫描你的端口 $X:x$，防火墙查表发现没有对应的出站记录，直接 **Drop**。

*   **结论**：
    此时，虽然没有 NAT，但防火墙的过滤逻辑变得极其严格。这在 RFC 5780 的术语中对应 **Address and Port-Dependent Filtering (APDF)**。
    *   只有你联系过的那个特定 IP 和端口，才能给你回信。

---

### 总结与对比

| 场景 | IPv6 Mapping Behavior | IPv6 Filtering Behavior | 对 P2P (WebRTC/游戏) 的影响 |
| :--- | :--- | :--- | :--- |
| **纯路由 (理想 IPv6)** | **Direct** (无转换) | **Endpoint-Independent** (全开放) | **极佳**。无需打洞，直接连接。但安全性低，设备暴露在公网。 |
| **有状态防火墙 (常见家用/企业)** | **Direct** (无转换) | **Address & Port-Dependent** (严格过滤) | **中等**。不需要 STUN 发现地址（因为是 Direct），但**必须进行打洞**（Hole Punching）来让防火墙建立状态条目。 |

### 关键点：为什么这很重要？

在 IPv4 时代，P2P 穿透困难通常是因为 **Symmetric NAT (APDM + APDF)**，即“地址变了”且“过滤严了”。

在 IPv6 时代，即便开启了防火墙，问题简化了一半：
1.  **地址不会变了**（Mapping 始终是 Direct），解决了 APDM 带来的最大痛点（无法预测端口）。
2.  **过滤依然严**（Filtering 是 APDF），所以 P2P 协议（如 ICE）在 IPv6 下**依然需要工作**。它不需要做地址转换，但需要双方互相发包（Keep-alive/Hole punching）来“骗”过双方的防火墙，建立合法的 Connection Tracking 状态。