# NAT映射与过滤行为详解

### 🧑‍💻 User

rfc5780规定的nat中的映射行为和过滤行为分别是什么意思，分别有哪些？

---

### 🤖 Assistant

RFC 5780 定义了 NAT 的行为，特别关注其对 P2P 应用（如 VoIP、文件共享）的影响。它将 NAT 的行为分为两个独立但相关的维度：**映射行为** 和 **过滤行为**。理解这两个维度对于判断两个位于不同 NAT 后的主机能否直接建立 P2P 连接至关重要。

### 1. 映射行为
*   **含义：** 映射行为描述 NAT 如何为**内部主机发起的出站连接**分配并维护**公网 IP 地址和端口**的映射关系。它关注的是：当内部主机（`私有IP:PortA`）向不同的外部目标（`公共IPX:PortX`, `公共IPY:PortY`）发送数据包时，NAT 是否会使用**相同的公网端口**（`公网IP:PortM`）？
*   **核心问题：** NAT 在分配公网端口时，其决策依赖于哪些因素？
*   **类型：**
    1.  **Endpoint-Independent Mapping (EIM - 端点无关映射)**
        *   **行为：** 对于同一个内部主机（`私有IP:PortA`），无论它连接的是哪个外部目标地址和端口（`公共IPX:PortX`, `公共IPY:PortY`, `公共IPZ:PortZ`），NAT 始终使用**同一个**公网映射（`公网IP:PortM`）。
        *   **特点：** 最宽松的映射方式。只要是从同一个内部套接字发出的连接，都共享同一个公网端口映射。这是 P2P 连接最友好的映射类型。
        *   **示意图：**
            ```
            内部主机 (192.168.1.100:5000) -> NAT -> 映射到 (203.0.113.1:55000)
            连接目标1: (公共服务器X:80)   使用 203.0.113.1:55000
            连接目标2: (公共服务器Y:443)  使用 203.0.113.1:55000
            连接目标3: (P2P对等体Z:9999) 使用 203.0.113.1:55000
            ```

    2.  **Address-Dependent Mapping (ADM - 地址相关映射)**
        *   **行为：** NAT 为内部主机（`私有IP:PortA`）分配公网端口时，会考虑**目标地址**。如果内部主机连接的是**同一个外部目标IP地址**（`公共IPX`），无论目标端口是什么（`PortX`, `PortY`），NAT 都使用**同一个**公网映射（`公网IP:PortM1`）。但如果连接的是**不同的外部目标IP地址**（`公共IPY`），即使目标端口相同，NAT 也会分配一个**新的公网端口**（`公网IP:PortM2`）。
        *   **特点：** 映射依赖于目标地址。连接相同目标IP的不同端口共享映射；连接不同目标IP则需要新映射。
        *   **示意图：**
            ```
            内部主机 (192.168.1.100:5000) -> NAT
            连接目标1: (公共服务器X:80)   -> 映射到 (203.0.113.1:55000)
            连接目标1: (公共服务器X:443)  -> 映射到 (203.0.113.1:55000) // 相同目标IP，相同映射
            连接目标2: (公共服务器Y:80)   -> 映射到 (203.0.113.1:55001) // 不同目标IP，新映射
            ```

    3.  **Address and Port-Dependent Mapping (APDM - 地址和端口相关映射)**
        *   **行为：** NAT 为内部主机（`私有IP:PortA`）分配公网端口时，会同时考虑**目标地址和目标端口**。只有当内部主机连接的是**完全相同的目标套接字**（`公共IPX:PortX`）时，NAT 才使用同一个公网映射（`公网IP:PortM1`）。如果目标地址**或**目标端口**任何一项**不同，NAT 都会分配一个**新的公网端口**（`公网IP:PortM2`, `公网IP:PortM3`）。
        *   **特点：** 最严格的映射方式。每个唯一的 `(内部IP:Port, 外部目标IP:Port)` 会话对都需要一个独立的公网端口映射。这是对 P2P 连接最不友好的映射类型。
        *   **示意图：**
            ```
            内部主机 (192.168.1.100:5000) -> NAT
            连接目标1: (公共服务器X:80)   -> 映射到 (203.0.113.1:55000)
            连接目标1: (公共服务器X:443)  -> 映射到 (203.0.113.1:55001) // 相同目标IP，不同端口 -> 新映射
            连接目标2: (公共服务器Y:80)   -> 映射到 (203.0.113.1:55002) // 不同目标IP -> 新映射
            ```

### 2. 过滤行为
*   **含义：** 过滤行为描述 NAT 如何处理**外部主机主动发起的入站连接尝试**（即未经内部主机首先发起的连接）。它关注的是：当一个数据包从外部主机（`公共IPZ:PortZ`）发送到 NAT 的公网映射地址（`公网IP:PortM`）时，NAT 是否会允许这个数据包通过并转发给内部主机？
*   **核心问题：** NAT 允许外部入站数据包通过的条件是什么？
*   **类型：**
    1.  **Endpoint-Independent Filtering (EIF - 端点无关过滤)**
        *   **行为：** NAT 允许来自**任何外部主机**（`任何公共IP:任何Port`）的数据包到达内部主机（`私有IP:PortA`），只要这个数据包是发往该内部主机当前活动的公网映射地址（`公网IP:PortM`）。不需要之前有从内部主机到该特定外部主机的出站连接。
        *   **特点：** 最宽松的过滤方式。只要公网端口映射存在（通常由内部主机的出站流量创建），任何外部主机都可以通过这个端口向内部主机发送数据。安全性最低，对 P2P 最友好。
        *   **示意图：**
            ```
            内部主机 (192.168.1.100:5000) 通过出站流量创建映射 (203.0.113.1:55000)
            外部主机A (1.2.3.4:1234) 发送到 203.0.113.1:55000 -> NAT 允许，转发给 192.168.1.100:5000
            外部主机B (5.6.7.8:5678) 发送到 203.0.113.1:55000 -> NAT 允许，转发给 192.168.1.100:5000
            ```

    2.  **Address-Dependent Filtering (ADF - 地址相关过滤)**
        *   **行为：** NAT 只允许来自**特定外部目标IP地址**（`公共IPX`）的数据包通过。具体来说：如果内部主机（`私有IP:PortA`）之前**主动发起过**到某个外部目标IP地址（`公共IPX`）的连接（无论目标端口是什么），那么 NAT 就允许从**该外部IP地址**（`公共IPX`）**发送到该内部主机的活动公网映射端口**（`公网IP:PortM`）的数据包通过，**无论**外部源端口是什么。来自其他未连接过的外部IP地址的数据包会被阻止。
        *   **特点：** 过滤依赖于目标地址。与某个外部IP建立过出站连接后，该IP就可以通过映射端口发起入站连接。
        *   **示意图：**
            ```
            内部主机 (192.168.1.100:5000) 映射到 (203.0.113.1:55000)
            内部主机 先连接 外部主机X (1.2.3.4:80) // 创建映射并“解锁”来自 1.2.3.4 的入站
            外部主机X (1.2.3.4: *任意端口*) 发送到 203.0.113.1:55000 -> NAT 允许
            外部主机Y (5.6.7.8: *任意端口*) 发送到 203.0.113.1:55000 -> NAT 阻止 // 未连接过Y
            ```

    3.  **Address and Port-Dependent Filtering (APDF - 地址和端口相关过滤)**
        *   **行为：** NAT 只允许来自**特定外部目标套接字**（`公共IPX:PortX`）的数据包通过。具体来说：只有当内部主机（`私有IP:PortA`）之前**主动发起过**到某个特定的外部目标地址和端口（`公共IPX:PortX`）的连接时，NAT 才允许从**该外部套接字**（`公共IPX:PortX`）发送到该内部主机的活动公网映射端口（`公网IP:PortM`）的数据包通过。来自其他外部IP或端口的数据包都会被阻止。
        *   **特点：** 最严格的过滤方式。安全性最高，对 P2P 连接最不友好。入站连接仅限于之前内部主机主动连接过的精确端点。
        *   **示意图：**
            ```
            内部主机 (192.168.1.100:5000) 映射到 (203.0.113.1:55000)
            内部主机 先连接 外部主机X (1.2.3.4:80) // 只“解锁”来自 1.2.3.4:80 的入站
            外部主机X (1.2.3.4:80) 发送到 203.0.113.1:55000 -> NAT 允许
            外部主机X (1.2.3.4: *其他端口*) 发送到 203.0.113.1:55000 -> NAT 阻止 // 不是80端口
            外部主机Y (5.6.7.8: *任意端口*) 发送到 203.0.113.1:55000 -> NAT 阻止 // 未连接过Y
            ```

### 关键点总结

1.  **正交性：** 映射行为和过滤行为是 NAT 的两个独立特性。一个 NAT 设备可以具有任何一种映射行为（EIM, ADM, APDM）与任何一种过滤行为（EIF, ADF, APDF）的组合。例如，一个 NAT 可能是 `Endpoint-Independent Mapping` 配合 `Address-Dependent Filtering` (EIM + ADF)。
2.  **对P2P的影响：**
    *   **最友好组合：** `Endpoint-Independent Mapping (EIM)` + `Endpoint-Independent Filtering (EIF)`。这就是传统的 **Full Cone NAT**。
    *   **最不友好组合：** `Address and Port-Dependent Mapping (APDM)` + `Address and Port-Dependent Filtering (APDF)`。这就是传统的 **Symmetric NAT**。建立直接 P2P 连接最困难。
    *   其他组合（如 `EIM + ADF` - 类似 Restricted Cone, `ADM + APDF` - 类似 Port Restricted Cone, `APDM + EIF`）介于两者之间。
3.  **RFC 4787/5382/5780 与旧术语：** RFC 5780 (及其前身 RFC 4787) 定义的这些行为类型比旧的 "Cone NAT" (Full, Restricted, Port Restricted) 和 "Symmetric NAT" 分类法更精确和灵活，因为它明确分离了映射和过滤两个维度，避免了旧术语的一些歧义。不过，旧术语在实践中仍然广泛使用，并且大致可以对应到新分类的组合上（如 Full Cone ≈ EIM + EIF）。

理解特定 NAT 设备的映射行为和过滤行为，是预测和解决 P2P 连接问题（如打洞成功率）的基础。工具如 STUN 就是用来探测 NAT 的这些行为的。

---

### 🧑‍💻 User

为什么ipv6的mapping behaviour为Direct，filtering behavior为Endpoint-Independent？

---

### 🤖 Assistant

在 IPv6 环境下，讨论 RFC 5780 中定义的 NAT 映射行为 (`Mapping Behaviour`) 和过滤行为 (`Filtering Behaviour`) 时，会出现一个特殊且重要的概念：**“Direct” 映射行为**和与之相关的 **“Endpoint-Independent” 过滤行为**。这与 IPv4 NAT 的行为有本质区别，原因在于 IPv6 的核心设计目标之一就是**消除对 NAT 的需求**。

以下解释为什么在纯 IPv6 场景（没有 NAT64 等转换技术）下会这样描述：

1.  **映射行为为 “Direct”：**
    *   **含义：** “Direct” 映射行为意味着**不存在地址或端口的转换**。
    *   **原因 (核心)：** IPv6 地址空间极其巨大（2^128 个地址），设计目标就是让互联网上的每一个设备都能拥有一个或多个**全局唯一的、可路由的公网 IPv6 地址**（通常是 `GUA - Global Unicast Address`）。设备可以直接使用这个地址与互联网上的任何其他主机通信。
    *   **过程：** 当一台 IPv6 主机（`Host-A`，地址为 `2001:db8::1:2:3`）发起一个到外部服务器（`Server-B`，地址为 `2001:db8:1::a:b:c`）的连接时：
        *   源 IP 地址就是 `Host-A` 自己的全局地址 `2001:db8::1:2:3`。
        *   目标 IP 地址就是 `Server-B` 的地址 `2001:db8:1::a:b:c`。
        *   **没有任何中间设备（如 NAT 网关）修改源 IP 或源端口。** 数据包以原始形式在网络中路由。
    *   **结论：** 因为根本没有发生映射（Mapping），所以映射行为是“直接”的（Direct）。设备使用自己的真实地址直接通信。RFC 5780 引入 “Direct” 这个概念就是为了描述这种“无 NAT”的状态。

2.  **过滤行为为 “Endpoint-Independent”：**
    *   **含义：** 端点无关过滤（EIF）意味着，只要入站数据包的目标 IP 地址是主机自己的全局地址 (`2001:db8::1:2:3`)，并且目标端口是主机上某个应用程序正在监听的端口，那么**无论这个数据包来自哪个外部 IP 地址和端口**，主机（或其主机防火墙）都应该允许它到达应用程序。
    *   **原因：**
        *   **主机可达性：** IPv6 的设计理念是端到端连接。每个主机拥有自己的公网地址，理应可以直接接收来自互联网上任一主机的入站连接请求（前提是应用程序在监听）。这与 IPv4 NAT 隐藏内部网络的状态不同。
        *   **主机防火墙的角色：** 在 IPv6 网络中，安全边界通常由运行在主机本身或第一跳路由器上的**状态防火墙**来实现，而不是依赖 NAT 的隐含过滤。RFC 6092 和最佳实践推荐主机防火墙默认采用类似于 “Endpoint-Independent Filtering” 的行为：
            *   **出站连接：** 允许所有由主机主动发起的出站连接及其响应返回（状态防火墙的基本功能）。
            *   **入站连接：** 对于**新的、未经请求的入站连接**（即目标地址是本机 GUA 且目标端口有应用监听的 SYN 包），**默认行为取决于防火墙策略**：
                *   **宽松策略 (EIF-like)：** 允许所有这样的入站连接尝试到达监听端口。这是最符合“端到端”理念的默认行为，也是为什么说过滤行为是 “Endpoint-Independent”。主机应用程序自己负责访问控制（如应用层认证）。
                *   **严格策略：** 管理员可以配置防火墙规则，只允许来自特定源 IP 或范围的入站连接（这就不再是 EIF 了）。**但 RFC 5780 描述的是基础的、未施加额外限制的状态**，即如果主机有应用在监听某端口，则默认应允许任何来源的连接尝试到达该端口，防火墙主要管理端口是否开放，而不是基于源地址过滤新连接。
        *   **与 NAT 过滤的本质区别：** IPv4 NAT 的过滤行为是 NAT 网关强制的，目的是保护隐藏的私有网络。IPv6 的过滤行为是主机防火墙策略决定的，目的是保护主机自身。默认的、符合端到端原则的策略就是 EIF。

**总结：**

*   **`Mapping Behaviour = "Direct"`：** 因为 IPv6 主机使用自己的全局唯一地址直接通信，**不存在任何地址或端口转换（NAT）**。
*   **`Filtering Behaviour = "Endpoint-Independent"`：** 因为在基础配置下（遵循端到端原则），IPv6 主机（或其防火墙）对于发送到其**自身全局地址**和**开放端口**的新入站连接请求，默认**不基于源 IP 地址或端口进行过滤**。任何来源的连接尝试都会被允许到达监听该端口的应用程序。应用程序自身负责进一步的访问控制。

**关键点强调：**

1.  **IPv6 的核心是消除 NAT：** “Direct” 映射直接体现了这一点。
2.  **安全责任转移：** IPv6 的安全不再依赖 NAT 的隐藏和隐式过滤，而是**明确依赖于主机防火墙和应用程序安全**。管理员可以（也常常会）将主机防火墙配置为更严格的行为（如只允许特定 IP 访问特定端口），但这属于策略配置，RFC 5780 描述的是基础的、未配置额外限制时的行为。
3.  **端到端连接：** “Endpoint-Independent Filtering” 是实现真正端到端 IPv6 连接的基础，使得任何主机理论上都可以直接发起连接到任何其他主机，只要目标地址可达且目标端口开放。
4.  **与 IPv4 NAT 类型的类比：** IPv6 的这种 `(Direct, Endpoint-Independent)` 行为组合，在连接开放性上，类似于 IPv4 中最开放的 `Full Cone NAT`。但本质完全不同：IPv4 Full Cone NAT 仍然存在映射和转换，而 IPv6 是原生的直接连接。