# Skylake-SP微架构改进总结

### 🧑‍💻 User

intel的skylake-sp在微架构设计（如乱序执行与分支预测等）上做出了哪些重大改进？

---

### 🤖 Assistant

Intel的Skylake-SP微架构（应用于Xeon Scalable Processors，代号Skylake-X/Skylake-SP）在其前代Broadwell-EP的基础上，在乱序执行核心和分支预测方面确实进行了显著的增强，旨在提升指令级并行度和整体性能，尤其是在服务器和高端桌面领域。以下是其主要改进点：

### 🛠 1. 乱序执行引擎的增强
*   **更大的乱序执行窗口：**
    *   **ReOrder Buffer (ROB) 增大：** ROB 是跟踪所有正在执行中指令状态的关键缓冲区。Skylake-SP 显著增加了 ROB 的大小（相比 Broadwell-EP 的 224 项，Skylake-SP 增加到了 224 项以上，具体实现可能因核心配置略有差异，但普遍增大，有资料显示可达 352 项或更多）。更大的 ROB 允许 CPU 同时追踪和调度更多处于乱序执行状态的指令，极大地挖掘了指令级并行潜力，尤其对代码中存在长延迟操作（如缓存未命中）时非常有利。
    *   **保留站 / 调度器队列增大：** 与 ROB 增大相匹配，调度指令等待执行的队列（Scheduler Entries / Reservation Station）容量也相应增加。这使得调度器能容纳更多等待分派到执行单元的微操作，提高了资源利用率和指令吞吐率。
    *   **加载/存储队列增大：** 为了处理更多的内存操作（加载和存储），Load Buffer 和 Store Buffer 的容量也得到了提升，减少因队列满而导致的停顿。
*   **更强的调度器与执行端口：**
    *   **增加执行端口：** Skylake-SP 的核心通常拥有 8 个执行端口（Port 0-7），而之前的 Haswell/Broadwell 是 8 个端口。虽然端口总数相同，但**关键变化在于端口的功能分配和吞吐能力**：
        *   **整数 ALU 能力增强：** 更多的端口支持整数 ALU 操作（例如，Port 0, 1, 5, 6），并且端口的吞吐能力（每个周期可处理的 uop 数）可能得到优化。具体来说，Port 6 被设计为一个强大的通用整数端口。
        *   **浮点/向量单元增强：** 为了支持 AVX-512，执行端口的宽度和功能进行了重大扩展。Port 0 和 Port 1 可以处理 512 位的浮点乘加（FMA）操作，每个端口每个周期可以完成一个 512 位 FMA 操作（理论峰值每个核心每个周期两个 512 位 FMA）。
        *   **专用存储地址端口：** Port 7 主要处理存储地址计算，减轻了其他端口的压力。
    *   **更灵活的调度：** 调度器算法可能得到改进，能更智能地处理资源冲突和依赖关系，更有效地利用这 8 个执行端口。

### 🎯 2. 分支预测器的改进
*   **更大的分支目标缓冲区：** BTB 用于存储最近遇到的分支指令的目标地址。Skylake-SP 使用了**更大且更高效的分级 BTB 结构**（例如，更快的 L1 BTB 和更大的 L2 BTB），能够缓存更多的分支目标信息，减少因 BTB 缺失导致的预测停顿。
*   **改进的间接分支预测器：** 间接分支（目标地址在运行时计算得出，如 C++ 虚函数调用、函数指针调用）预测难度大且代价高。Skylake-SP 采用了**更先进的间接分支目标预测器**，可能结合了更多上下文信息（如全局分支历史、调用栈信息）和更大的预测表，显著提高了这种重要分支类型的预测准确率。
*   **循环流检测器优化：** 处理紧密循环的分支预测逻辑得到优化，减少了循环退出预测错误时的惩罚。
*   **预测算法精炼：** 核心的分支预测算法（如 TAGE 预测器或其变种）的参数和结构可能进行了调整和优化，以利用更大的存储资源和更长的历史记录，进一步提升整体预测准确率。预测准确率的提升直接减少了流水线清空的发生，提高了有效 IPC。

### 🔗 3. 内存子系统相关改进
虽然不严格属于核心乱序引擎或分支预测器，但与它们紧密相关，极大影响乱序执行效率：
*   **更大的 L1 数据缓存带宽：** L1D Cache 的加载带宽从 Broadwell 的每周期 2x 32 字节提升到 **每周期 2x 64 字节**。这显著加快了数据供给速度，减少了乱序引擎因等待数据而停顿的时间。
*   **改进的预取器：** 数据预取器变得更智能、更积极，能更好地预测未来的内存访问模式，将数据提前加载到缓存中，隐藏内存延迟，让乱序引擎有更多工作可做。
*   **非包含式 L3 缓存：** Skylake-SP 引入了 **"非包含" L3 缓存**设计。这意味着 L3 不再包含所有 L2 缓存的内容副本。这虽然增加了 L2 缺失时访问 L3 的延迟，但带来了巨大优势：
    *   大幅减少了在核心间无效化缓存行时对 L3 的带宽消耗和争用（因为不需要在 L3 中查找并无效化副本）。
    *   显著提高了 L3 的有效容量（因为不需要存储冗余数据），对于多核共享的服务器工作负载尤其有益。
    *   更低的无效化开销间接提升了缓存一致性效率，有助于保持乱序执行引擎的流畅性。

### 🌐 4. 网格互连架构
虽然这是片级架构而非核心微架构，但对核心间通信和内存访问延迟有重大影响：
*   取代了之前的环形总线，采用了**双向网格互连**。网格在核心数非常多时（如 28 核）具有更好的可扩展性和带宽，避免了环形总线在节点过多时延迟急剧上升的问题。这改善了核心间通信和访问远端内存/缓存的延迟，对于多线程应用的乱序执行效率有积极影响。

### 📌 总结关键改进
| **特性**         | **Skylake-SP 改进**                                                                 |
|------------------|--------------------------------------------------------------------------------------|
| **乱序窗口 (ROB)** | 显著增大 (e.g., >224项 -> ~352项)                                                    |
| **调度器/保留站**  | 容量增大，匹配更大的 ROB                                                             |
| **加载/存储队列**  | 容量增大                                                                            |
| **执行端口**      | 8端口，功能重组增强：更强整数能力，原生支持 512-bit FMA (Port 0,1)，专用存储地址端口 |
| **分支预测**      | 更大分级 BTB，显著增强的间接分支预测器，优化循环预测                                 |
| **L1D 带宽**     | 翻倍：每周期 2x 64 字节 (Broadwell: 2x 32字节)                                      |
| **L3 缓存设计**   | 引入非包含式 L3 缓存 (提高有效容量，降低无效化开销)                                  |
| **片内互连**      | 引入网格架构 (Mesh) 替代环形总线 (提升高核数扩展性)                                  |
| **新指令集**      | 支持 AVX-512 (对执行单元是重大扩展)                                                  |

### 🚨 重要提示
*   这些改进主要是针对**核心微架构**（乱序引擎、分支预测）和**核心周边的缓存/内存接口**。Skylake-SP 在服务器平台上的其他重大变化（如集成内存控制器支持 6 通道 DDR4、UPI 互连替代 QPI、平台划分等）也很重要，但不是核心微架构层面的改进。
*   **AVX-512 支持** 是 Skylake-SP 的一个标志性特性，它对执行单元（尤其是浮点/向量单元）进行了革命性的扩展和重组，带来了巨大的理论计算能力提升。虽然它本身不是乱序或分支预测的直接改进，但为了高效支持它，乱序引擎必须能处理更宽的 uop 和数据流，调度器和执行端口的增强部分也是为了适应它。

总而言之，Skylake-SP 的核心微架构通过**大幅扩展关键缓冲区和队列（ROB, RS, LB/SB）、增强调度器和执行端口的能力与灵活性、部署更先进的分支预测器（特别是针对间接分支）、以及提升 L1 数据带宽和缓存子系统效率**，显著提升了指令级并行能力（IPC）和应对复杂工作负载（尤其是存在分支误预测或内存延迟）的性能。这些改进，结合 AVX-512 和网格互连，使其成为当时服务器和 HEDT 市场上非常强大的处理器架构💪🏻。