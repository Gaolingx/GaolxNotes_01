# 光线追踪实现面光源与自发光照明

### 🧑‍💻 User

为什么面光源/自发光照亮场景这种操作只有基于ray tracing/path tracing的渲染器可以实现？

---

### 🤖 Assistant

这是一个非常好的问题，触及了不同渲染算法的核心差异。简单来说：**只有基于光线追踪/路径追踪的渲染器能够“物理正确”且“自然”地模拟面光源和自发光物体照亮场景（尤其是间接照明），是因为它们直接模拟了光线在真实世界中的传播方式——即从光源发射，在场景中多次反弹，最终进入相机（或眼睛）。**

以下是详细的解释：

1.  **光栅化（传统渲染）的核心原理与局限：**
    *   **基于三角形投影和可见性：** 光栅化渲染的核心是将3D物体投影到2D屏幕上，计算每个像素对应的物体表面点（通常是离相机最近的表面）。
    *   **光照计算是局部的：** 对于屏幕上的每个像素点（即一个表面点），计算光照时通常只考虑：
        *   **直接光照：** 计算该点**直接**连接到点光源、方向光或（近似计算的）聚光灯的光照贡献。光照计算通常发生在该表面点的局部坐标系下。
        *   **阴影：** 通过阴影贴图（Shadow Maps）等技术判断该点是否在光源的“视线”内。阴影贴图本质上是**从光源视角**渲染的一张深度图。
    *   **为什么面光源是难题：**
        *   面光源不是一个点，而是一个有面积的区域。要正确计算一个着色点接收到的来自面光源的光照，理论上需要**对面光源上的无数个点进行积分**。
        *   光栅化无法直接进行这种积分。它通常会把面光源近似成一个或多个点光源（如使用多个光源采样点），但这会导致：
            *   **计算开销大：** 每个采样点都需要一次阴影贴图渲染和一次光照计算。
            *   **软阴影质量不高或噪点多：** 采样点不足会导致软阴影边缘粗糙或有噪点。
            *   **无法处理间接光照：** 即使解决了直接光照的软阴影问题，面光源发出的光在场景中反弹（间接照明）对物体的影响，光栅化本身完全无法计算。
    *   **为什么自发光照亮场景是难题：**
        *   在光栅化中，自发光材质通常**只意味着该物体自身看起来是亮的**（即该像素直接显示发光颜色或强度）。
        *   **它不会主动作为光源去照亮其他物体。** 光栅化的光照模型里没有机制让一个表面点（自发光物体上的点）主动向其他表面点发射光线去贡献光照。
        *   要实现自发光照亮其他物体，只能通过“作弊”：
            *   **烘焙光照贴图：** 在离线预处理时，将自发光物体当作光源，计算它对周围静态物体的光照并“烘烤”到纹理上。但这仅适用于静态场景和静态光照。
            *   **近似方法（如屏幕空间技术）：** 如SSGI，在屏幕空间内尝试估算间接光。效果有限，依赖屏幕内容，屏幕外的信息无法计算，边缘和遮挡问题严重，精度和物理正确性远不及路径追踪。

2.  **光线追踪/路径追踪的核心原理与优势：**
    *   **基于光线传播的物理模拟：** 这些算法的核心是模拟光线从**光源**出发（或更常用的，从**相机/眼睛**出发逆向追踪），在场景中与物体表面相交、反射、折射、吸收的过程。
    *   **直接处理面光源：**
        *   当一条从相机出发的射线（眼睛射线）击中一个表面点后，为了计算该点的光照（尤其是直接光照），算法会**向面光源区域发射多条采样射线（Shadow Rays）**。
        *   每条采样射线测试是否能“看见”面光源上的某个点（无遮挡）。通过统计这些采样射线的结果（多少被遮挡/未被遮挡），就能**直接计算**该着色点接收到的来自整个面光源的光照贡献（即对面光源的**蒙特卡洛积分**）。
        *   这个过程**自然**地产生了由面光源造成的**柔和软阴影**。
    *   **直接处理自发光照亮场景：**
        *   在路径追踪中，当一条射线（无论是眼睛射线还是后续的反弹射线）击中一个表面时，会查询该表面的材质属性。
        *   如果该表面是**自发光材质**，那么击中它的射线会直接获得该自发光材质的辐射亮度作为光照贡献的一部分。
        *   **关键点：** 一条射线击中了一个自发光表面，**意味着这条射线（或其祖先射线）的路径最终连接了相机和这个自发光表面**。这个自发光表面就成为了这条光路的有效光源。
        *   **路径追踪通过射线在场景中的多次随机反弹，自然地“发现”了自发光物体并将其贡献纳入最终像素颜色的计算中。** 无论是直接看到发光体，还是发光体照亮了墙壁再反射到物体上（间接照明），都能被捕捉到。不需要特别指定谁是光源，只要材质有发光属性，它在光路中被击中时就会贡献光。

3.  **物理正确性与全局光照：**
    *   光线追踪/路径追踪的目标是实现**全局光照**，即同时考虑直接光照（光源直接照射）和间接光照（光在物体表面间多次反弹后的照明）。
    *   **面光源和自发光物体是场景中间接光照的重要来源。** 路径追踪通过模拟光线的物理传播路径，**统一地、自然地**处理了所有类型的光源（点光、聚光、面光、自发光物体）及其产生的直接照明和间接照明效果。
    *   光栅化由于其局部光照模型和基于投影的本质，无法模拟这种光线多次反弹的复杂相互作用，因此无法物理正确地处理面光源（尤其是其产生的间接光）和自发光物体作为光源的照明效果。

**总结：**

*   **光栅化：** 擅长快速渲染直接可见的表面和点/方向光源的直接光照+硬阴影（或近似的软阴影）。其核心流程（投影->光栅化->局部着色）决定了它**没有机制**去对面光源进行物理积分，也**没有机制**让自发光物体主动发射光线去照亮其他物体（只能通过离线烘焙或屏幕空间近似）。
*   **光线追踪/路径追踪：** 通过模拟光线的物理传播路径，**直接对光源区域（包括面光源）进行采样积分**来计算光照，并**自然地**将击中自发光表面的射线路径识别为有效光源路径，从而**物理正确**地计算了面光源的直接照明、软阴影以及面光源和自发光物体产生的**直接和间接照明**效果。

因此，当你需要真实、物理正确的柔和阴影（由面光源产生）或者希望一个灯泡模型、霓虹灯管、发光的屏幕不仅仅自己亮起来还能真实地照亮周围的墙壁和物体时，基于光线追踪/路径追踪的渲染器是目前唯一能“开箱即用”、无需大量特殊技巧就能实现这些效果的技术。光栅化只能通过各种近似和“作弊”手段去模拟，效果和适用范围都有限。现代游戏引擎通过混合渲染（光栅化 + 光线追踪）可以在实时领域部分实现这些效果（如RTXDI），但其核心依赖的仍然是光线追踪的能力。