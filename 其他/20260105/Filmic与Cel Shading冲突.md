# Filmic与Cel Shading冲突

### 🧑‍💻 User

我发现bl默认给的那套filmic色调映射是给写实渲染用的 他会把高光和阴影往中间压 拿来做cel shading有泛白/灰感觉，要么Custom tonemap（gt/custom aces）要么后期拉下色相饱和度啥的，比较好的解决办法有哪些？

---

### 🤖 Assistant

你的观察非常准确。Blender 默认的 **Filmic**（以及新的 **AgX**）的设计初衷确实是为了**物理正确的写实渲染**（Photorealism）。

**Filmic/AgX 的核心逻辑是：** 随着光照强度增加，颜色的饱和度会逐渐降低并趋向于白色（Desaturation at high intensities）。这模拟了真实胶片的感光特性，能保留高动态范围（HDR）细节。

**Cel Shading（三渲二）的核心逻辑是：** 颜色通常是“所见即所得”的，或者是经过美术风格化定义的。高光往往需要保持高饱和度（例如红色的高光依然是红色，而不是粉白），Filmic 这种“把高光压白、把暗部提亮”的操作会直接破坏二次元画面的“通透感”和“纯净度”。

针对 Cel Shading 泛白/发灰的问题，以下是几种目前业内比较主流的解决方案，按推荐程度排序：

---

### 1. 方案一：换回 `Standard` (标准) + `Look` (风格)
这是做 NPR（非真实感渲染）最传统也最直接的方法。

*   **操作：** 在 `Render Properties` -> `Color Management` 中：
    *   **View Transform:** 设为 `Standard` (而不是 Filmic/AgX)。
    *   **Look:** 设为 `None` 或 `Medium High Contrast` (中高对比度)。
*   **原理：** `Standard` 对应的是 sRGB 转换。它不会对高光进行“压白”处理，$R=1.0$ 就是纯红。这能保证你 Shader 里选什么颜色，渲染出来就是什么颜色。
*   **缺点：** 动态范围很窄。如果你的灯光强度超过 $1.0$，高光部分会直接过曝（Clipping），产生难看的锯齿或色块断层。
*   **应对：** 在 NPR 中，我们通常不需要物理正确的超亮光源。你需要严格控制灯光强度，或者在 Shader 内部通过 `Shader to RGB` 节点来钳制光照范围，避免数值溢出。

### 2. 方案二：使用 Blender 4.2+ 的 `Khronos PBR Neutral` (强烈推荐)
如果你使用的是 Blender 4.2 或更高版本，这是目前官方给出的最佳解决方案，专门为了解决 Filmic/AgX 导致的产品渲染和电商渲染色偏问题，也非常适合 NPR。

*   **操作：** 在 `Color Management` 中：
    *   **View Transform:** 设为 `Khronos PBR Neutral`。
*   **原理：** 这个转换曲线专门设计用于**保留高光下的饱和度**。它依然具备一定的动态范围压缩能力（比 Standard 强），但不会像 Filmic/AgX 那样激进地把高饱和颜色变成白色。
*   **效果：** 既能避免 Standard 的过曝断层，又能避免 Filmic 的泛白。对于二次元皮肤、鲜艳的服饰，它的还原度极高。

### 3. 方案三：使用 `AgX` + `Punchy` (折中方案)
虽然 AgX 也是为写实设计的，但它比 Filmic 在处理高饱和度颜色（尤其是著名的“Filmic 6色导致变色”问题）上要好得多。

*   **操作：**
    *   **View Transform:** `AgX`
    *   **Look:** 必须改为 `Punchy` (有力) 甚至 `High Contrast`。
*   **适用场景：** 如果你的 NPR 风格偏向这就“新海诚”或者“吉卜力”那种带有一点点真实光影感、需要辉光（Bloom）效果的风格，AgX 能比 Standard 提供更柔和的光影过渡，配合 Punchy 可以找回丢失的对比度。

### 4. 方案四：合成器 (Compositor) 后期校色
如果你不想更换 View Transform，或者需要极为特殊的色调，可以在合成节点里“拉回来”。这不是指简单的调节色相，而是利用曲线。

*   **操作：**
    1.  渲染层输出。
    2.  添加 `RGB Curves` 节点。
    3.  在这个节点里画一个 **S型曲线**（压暗部，提亮部）。
    4.  添加 `Hue Saturation Value` 节点，适当增加 Saturation (饱和度) 约 $1.1$ 到 $1.2$。
*   **原理：** 手动模拟你想要的 Tone Mapping 曲线。这比直接改全局 View Transform 更灵活，可以针对特定通道调整。

### 5. 方案五：材质层面的“逆向补偿” (Hack方法)
这是很多做 Guilty Gear (罪恶装备) 风格 Shader 的人常用的技巧。既然 Filmic 会压暗，那我就在 Shader 里把颜色“更纯”地输出。

*   **操作：**
    *   尽量多使用 `Emission` (自发光) 节点或者 `Principled BSDF` 的 Emission 通道来输出颜色，而不是单纯靠 Base Color + 灯光漫反射。
    *   Emission 的强度如果不超过 $1.0$，在 Filmic 下受到的影响相对较小且可控。
    *   在 Shader 结尾，使用 `Gamma` 节点或者 `Bright/Contrast` 节点，在输出前强行拉高对比度。

### 总结推荐

1.  **最省心/现代标准 (Blender 4.2+)：** 选用 **`Khronos PBR Neutral`**。它完美平衡了色彩还原和动态范围，是目前 NPR 的版本答案。
2.  **绝对纯平/日式赛璐珞 (TV Anime)：** 选用 **`Standard`**。严格控制灯光，所见即所得，不会有任何不可控的变色。
3.  **如果你还在用老版本且想要质感：** 也可以去下载第三方的 OCIO 配置（如 GitHub 上的 `Blender-Filmic-Blender-NPR` 或 `TCAMv2`），但现在原生的 Khronos Neutral 已经足够好了，没必要再去折腾 OCIO 配置文件了。

---

### 🧑‍💻 User

我发现很多美术对于tonemapping理解有误区，认为它是用于调色而不是color management的，如何纠正这种观点？

---

### 🤖 Assistant

这是一个非常深刻且普遍的行业痛点。很多美术（甚至部分技术美术）会把 **Tone Mapping（色调映射）** 当作是一种“滤镜”或者“LUT（查找表）”来用，觉得它只是为了让画面变亮或变暗。

要纠正这个观念，关键在于把话题从**“好看”**（审美范畴）拉回到**“信号处理”**（科学范畴）。

你可以尝试用以下几套逻辑和比喻来向美术同事解释，逐层递进：

### 1. 核心定义：它是“翻译官”，不是“化妆师”

*   **误区：** 认为 Tone Mapping 是在给画面“调色”或“加滤镜”。
*   **纠正：** Tone Mapping 是**数据压缩**。
*   **解释：**
    *   渲染器计算出的光照数据（Scene Linear）是**HDR（高动态范围）**的，数值范围是 $0$ 到 $\infty$（无限大）。
    *   我们的显示器（SDR 屏幕）能显示的数值范围只有 $0$ 到 $1$。
    *   **Tone Mapping 的本质：** 是一个数学函数，负责把 $0 \to \infty$ 的海量数据，“塞进” $0 \to 1$ 这个狭窄的显示器容器里。
    *   **结论：** 它不是为了让画面变黄或变蓝，而是为了让那些超过 $1.0$ 的亮度（比如太阳、灯芯）在屏幕上能显示出细节，而不是变成一片死白。

### 2. 直观比喻：大象装冰箱

给美术讲数学曲线（S-Curve）往往效果不好，用物理比喻更有效：

*   **场景数据（HDR）：** 是一头大象。
*   **显示器（SDR）：** 是一个冰箱。
*   **Tone Mapping：** 是把大象装进冰箱的**方法**。
    *   **Standard (Clip):** 直接把大象切了，只留冰箱能塞下的部分，剩下的扔掉（过曝死白，数据丢失）。
    *   **Filmic/AgX:** 把大象通过某种黑科技“缩小”或者“折叠”，完整地塞进去。虽然看起来有点变形（高光饱和度降低），但大象还是完整的。
*   **Color Grading (调色)：** 是把大象装进冰箱**之后**，给大象涂指甲油、戴帽子。
*   **误区的后果：** 如果你试图用“切大象的方法”（选错 Tone Mapping）来获得“涂指甲油的效果”（调色），你最后得到的是一截断掉的象腿，而不是一只漂亮的大象。

### 3. 工作流逻辑：Raw vs. JPG

很多美术都玩摄影，用相机的逻辑解释最通透：

*   **渲染出的图 = RAW 格式原片。** 它灰灰的，包含巨大的宽容度。
*   **View Transform (Tone Mapping) = 相机的显影算法。** 它是把 RAW 变成人眼能看的图像的基础物理规则。
*   **Compositor/Photoshop = 后期修图。**
*   **话术：** “你现在选 Standard 还是 Filmic，是在决定我们要不要丢弃高光数据。如果你选 Standard，就像是用 JPG 格式拍照，天空一旦过曝就再也救不回来的；选 Filmic/AgX 就像拍 RAW，虽然原片看着灰，但后期调色的空间是无限的。”

### 4. 为什么 NPR (三渲二) 会特殊？

既然我们在谈 NPR，这时候要给美术一个台阶下，解释为什么他们会觉得 Standard “更好看”：

*   **解释：** 在写实渲染里，我们追求物理正确，所以必须用 Filmic/AgX 压住高光。
*   **但是：** 在 NPR 里，我们的 Shader 很多时候是在**模拟绘画**，而不是模拟物理光照。我们在 Shader 里画的颜色（Base Color），就是我们在屏幕上想看到的最终颜色（Display Color）。
*   **结论：** 选用 Standard 做 NPR 不是因为它“调色好看”，而是因为我们**主动放弃了 HDR 数据**，我们要的是“所见即所得”的直接映射（$1.0 \to 1.0$）。这也是一种 Color Management 的选择，而非调色。

### 5. 灵魂拷问（Kill Shot）

如果以上道理讲不通，直接用这几个问题引导他们思考：

1.  “如果不换 Tone Mapping，只靠打灯，你能把过曝死白的那块区域找回细节吗？”（Standard 下是找不回来的，证明这是数据瓶颈，不是颜色问题）。
2.  “如果我们将来要出 HDR 版本的视频（比如在 iPhone 或 HDR 电视上看），现在的 Standard 模式能撑得住吗？”（撑不住，因为高光被切掉了）。

### 总结给美术的“防坑指南”

你可以把这段话贴在团队的规范文档里：

> **Color Management (Tone Mapping) 是地基，Color Grading (调色) 是装修。**
>
> *   **Tone Mapping (Filmic/AgX/Standard):** 决定了你的画面能容纳多亮的光，会不会过曝，会不会断层。这是**技术指标**。
> *   **Color Grading (曲线/色相/饱和度):** 决定了画面是冷是暖，是通透是厚重。这是**艺术指标**。
>
> **不要试图通过换地基来改变装修风格，那会让你的房子（画面数据）随时可能塌陷（过曝/失真）。**